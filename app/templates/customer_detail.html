{% extends "base.html" %}

{% block title %}{{ customer.name }} - SubTrack Web{% endblock %}

{% block content %}
<div class="animate-fade-in">
    <!-- Back Button -->
    <button class="btn btn-secondary btn-sm mb-4" onclick="window.history.back()"
        style="display: inline-flex; align-items: center; gap: 6px;">
        ‚Üê Back
    </button>

    <nav class="breadcrumbs" style="margin-bottom: var(--space-4); font-size: var(--font-size-sm);">
        <a href="/" style="color: var(--color-text-secondary);">Dashboard</a>
        <span style="margin: 0 var(--space-2); color: var(--color-text-tertiary);">/</span>
        {% if customer.categories and customer.categories|length > 0 %}
        <a href="/categories/{{ customer.categories[0].id }}" style="color: var(--color-text-secondary);">{{
            customer.categories[0].name }}</a>
        {% elif customer.primary_category %}
        <a href="/categories/{{ customer.primary_category.id }}" style="color: var(--color-text-secondary);">{{
            customer.primary_category.name }}</a>
        {% else %}
        <span style="color: var(--color-text-secondary);">No Category</span>
        {% endif %}
        <span style="margin: 0 var(--space-2); color: var(--color-text-tertiary);">/</span>
        <span style="color: var(--color-text);">{{ customer.name }}</span>
    </nav>

    <div class="flex items-center justify-between mb-8">
        <div>
            <h1>{{ customer.name }}</h1>
            <p class="text-secondary">
                {% if customer.categories and customer.categories|length > 0 %}
                {% for cat in customer.categories %}
                <a href="/categories/{{ cat.id }}">{{ cat.name }}</a>{% if not loop.last %}, {% endif %}
                {% endfor %}
                {% elif customer.primary_category %}
                <a href="/categories/{{ customer.primary_category.id }}">{{ customer.primary_category.name }}</a>
                {% endif %}
                {% if customer.groups and customer.groups|length > 0 %}
                / {% for grp in customer.groups %}
                <a href="/groups/{{ grp.id }}">{{ grp.name }}</a>{% if not loop.last %}, {% endif %}
                {% endfor %}
                {% elif customer.primary_group %}
                / <a href="/groups/{{ customer.primary_group.id }}">{{ customer.primary_group.name }}</a>
                {% endif %}
            </p>
        </div>
        <div class="flex gap-2">
            <button class="btn btn-secondary btn-sm" onclick="loadEditData('customer', {{ customer.id }})">
                ‚úèÔ∏è Edit Customer
            </button>
            <button class="btn btn-primary"
                onclick="openSubscriptionModalForCustomer({{ customer.category_id or customer.primary_category.id if customer.primary_category else 0 }}, {{ customer.id }}, '{{ customer.name|replace("'", "\\'") }}')">
                ‚ûï New Subscription
            </button>
        </div>
    </div>

    <div class="grid grid-cols-3 gap-6">
        <!-- Customer Info -->
        <div class="card" style="grid-column: span 2;">
            <div class="card-header">
                <h2 class="card-title">Customer Information</h2>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <div class="text-sm text-secondary mb-1">Category</div>
                    <div class="font-medium">
                        {% if customer.categories and customer.categories|length > 0 %}
                        {% for cat in customer.categories %}
                        <a href="/categories/{{ cat.id }}" class="badge badge-primary" style="margin-right: 4px;">
                            üìÅ {{ cat.name }}
                        </a>
                        {% endfor %}
                        {% elif customer.primary_category %}
                        <a href="/categories/{{ customer.primary_category.id }}" class="badge badge-primary">
                            üìÅ {{ customer.primary_category.name }}
                        </a>
                        {% else %}
                        <span class="text-secondary">No category assigned</span>
                        {% endif %}
                    </div>
                </div>
                <div>
                    <div class="text-sm text-secondary mb-1">Group</div>
                    <div class="font-medium">
                        {% if customer.groups and customer.groups|length > 0 %}
                        {% for grp in customer.groups %}
                        <a href="/groups/{{ grp.id }}" class="badge badge-success" style="margin-right: 4px;">
                            üë• {{ grp.name }}
                        </a>
                        {% endfor %}
                        {% elif customer.primary_group %}
                        <a href="/groups/{{ customer.primary_group.id }}" class="badge badge-success">
                            üë• {{ customer.primary_group.name }}
                        </a>
                        {% else %}
                        <span class="text-secondary">No group assigned</span>
                        {% endif %}
                    </div>
                </div>
                <div>
                    <div class="text-sm text-secondary mb-1">Email</div>
                    <div class="font-medium">{{ customer.email or 'Not provided' }}</div>
                </div>
                <div>
                    <div class="text-sm text-secondary mb-1">Phone</div>
                    <div class="font-medium">{{ customer.phone or 'Not provided' }}</div>
                </div>
                <div>
                    <div class="text-sm text-secondary mb-1">Country</div>
                    <div class="font-medium">
                        {% if customer.country %}
                        <span class="badge badge-secondary">üåç {{ customer.country }}</span>
                        {% else %}
                        Not specified
                        {% endif %}
                    </div>
                </div>
                <div>
                    <div class="text-sm text-secondary mb-1">Tags</div>
                    <div>
                        {% if customer.tags %}
                        {% for tag in customer.tags.split(',') %}
                        <span class="badge badge-info">{{ tag.strip() }}</span>
                        {% endfor %}
                        {% else %}
                        No tags
                        {% endif %}
                    </div>
                </div>
                <div style="grid-column: span 2;">
                    <div class="text-sm text-secondary mb-1">Notes</div>
                    <div>{{ customer.notes or 'No notes' }}</div>
                </div>
            </div>
        </div>

        <!-- Quick Stats -->
        <div class="flex flex-col gap-4">
            <div class="card card-hover clickable-card" style="cursor: pointer;" onclick="openModal('custSubsModal')">
                <div class="text-sm text-secondary mb-2">Total Subscriptions</div>
                <div class="text-3xl font-bold text-primary">{{ subscriptions|length }}</div>
                <div class="text-xs text-secondary mt-1">Click to view ‚Üí</div>
            </div>
            <div class="card card-hover clickable-card" style="cursor: pointer;" onclick="openModal('custSpendModal')">
                <div class="text-sm text-secondary mb-2">Monthly Spend</div>
                <div class="text-3xl font-bold text-success">
                    ${{ "%.2f"|format(subscriptions|sum(attribute='cost')) }}
                </div>
                <div class="text-xs text-secondary mt-1">Click for breakdown ‚Üí</div>
            </div>
        </div>
    </div>

    <!-- Connections -->
    <div class="grid grid-cols-1 gap-6 mt-6">
        <!-- Connections Panel -->
        <div class="card" id="connections-panel">
            <div class="card-header">
                <h2 class="card-title">üîó Connections</h2>
                <button class="btn btn-secondary btn-sm"
                    hx-get="/api/ai/links?source_type=customer&source_id={{ customer.id }}"
                    hx-target="#connections-content">
                    Refresh
                </button>
            </div>
            <div id="connections-content">
                <div class="empty-state" style="padding: var(--space-8);">
                    <div class="empty-state-icon">üîó</div>
                    <p class="empty-state-text">No connections found yet. Click Refresh to discover relationships with
                        other customers.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Subscriptions -->
    {% if subscriptions %}
    <div class="card mt-6">
        <div class="card-header">
            <h2 class="card-title">üìã Subscriptions</h2>
        </div>
        <div class="table-container">
            <table class="table">
                <thead>
                    <tr>
                        <th>Vendor</th>
                        <th>Plan</th>
                        <th>Cost</th>
                        <th>Billing Cycle</th>
                        <th>Next Renewal</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for sub in subscriptions %}
                    <tr>
                        <td class="font-medium">{{ sub.vendor_name }}</td>
                        <td>{{ sub.plan_name or '-' }}</td>
                        <td>${{ "%.2f"|format(sub.cost) }} {{ sub.currency }}</td>
                        <td>
                            {% if sub.billing_cycle.value == 'custom' %}
                            Every {{ sub.custom_billing_amount or 1 }} {{ (sub.custom_billing_unit or
                            'months')|capitalize }}
                            {% else %}
                            {{ sub.billing_cycle.value|capitalize }}
                            {% endif %}
                        </td>
                        <td>
                            {% set days = sub.days_until_renewal() %}
                            {% if days < 0 %} <span class="badge badge-danger">{{ -days }} days overdue</span>
                                {% elif days <= 7 %} <span class="badge badge-danger">{{ days }} days</span>
                                    {% elif days <= 30 %} <span class="badge badge-warning">{{ days }} days</span>
                                        {% else %}
                                        <span class="badge badge-success">{{ days }} days</span>
                                        {% endif %}
                        </td>
                        <td>
                            <span class="badge badge-{{ 'success' if sub.status.value == 'active' else 'secondary' }}">
                                {{ sub.status.value }}
                            </span>
                        </td>
                        <td>
                            <a href="/subscriptions/{{ sub.id }}" class="btn btn-sm btn-secondary">View</a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% else %}
    <div class="card mt-6">
        <div class="empty-state">
            <div class="empty-state-icon">üìã</div>
            <h3 class="empty-state-title">No subscriptions yet</h3>
            <p class="empty-state-text">Add the first subscription for this customer.</p>
            <button class="btn btn-primary"
                onclick="window.location.href='/subscriptions/new?customer_id={{ customer.id }}'">
                Add Subscription
            </button>
        </div>
    </div>
    {% endif %}
</div>

<!-- Customer Subscriptions Modal -->
<div id="custSubsModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 800px;">
        <div class="modal-header">
            <h2 class="modal-title">üìã {{ customer.name }}'s Subscriptions ({{ subscriptions|length }})</h2>
            <button class="modal-close" onclick="closeModal('custSubsModal')">√ó</button>
        </div>
        <div class="modal-body">
            {% if subscriptions %}
            <div class="table-container" style="max-height: 400px; overflow-y: auto;">
                <table class="table">
                    <thead style="position: sticky; top: 0; background: var(--color-bg-card); z-index: 1;">
                        <tr>
                            <th>Vendor</th>
                            <th>Plan</th>
                            <th>Cost</th>
                            <th>Status</th>
                            <th>Next Renewal</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for sub in subscriptions %}
                        <tr>
                            <td class="font-medium">{{ sub.vendor_name }}</td>
                            <td>{{ sub.plan_name or '-' }}</td>
                            <td>${{ "%.2f"|format(sub.cost) }}</td>
                            <td><span
                                    class="badge badge-{{ 'success' if sub.status.value == 'active' else 'warning' if sub.status.value == 'paused' else 'secondary' }}">{{
                                    sub.status.value }}</span></td>
                            <td>
                                {% set days = sub.days_until_renewal() %}
                                <span
                                    class="badge badge-{{ 'danger' if days < 0 else 'warning' if days <= 30 else 'success' }}">
                                    {% if days < 0 %}{{ -days }}d overdue{% else %}{{ days }}d{% endif %} </span>
                            </td>
                            <td><a href="/subscriptions/{{ sub.id }}" class="btn btn-sm btn-secondary">View</a></td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p class="text-secondary text-center py-4">No subscriptions yet</p>
            {% endif %}
        </div>
    </div>
</div>

<!-- Customer Spend Breakdown Modal -->
<div id="custSpendModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 600px;">
        <div class="modal-header">
            <h2 class="modal-title">üí∞ Spend Breakdown</h2>
            <button class="modal-close" onclick="closeModal('custSpendModal')">√ó</button>
        </div>
        <div class="modal-body">
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div class="card" style="background: var(--color-bg-secondary); padding: var(--space-4);">
                    <div class="text-sm text-secondary mb-1">Total Monthly</div>
                    <div class="text-2xl font-bold text-success">${{ "%.2f"|format(subscriptions|sum(attribute='cost'))
                        }}</div>
                </div>
                <div class="card" style="background: var(--color-bg-secondary); padding: var(--space-4);">
                    <div class="text-sm text-secondary mb-1">Annual Projection</div>
                    <div class="text-2xl font-bold text-info">${{ "%.2f"|format(subscriptions|sum(attribute='cost') *
                        12) }}</div>
                </div>
            </div>
            {% if subscriptions %}
            <h4 class="font-semibold mb-2">By Subscription</h4>
            <div class="space-y-2" style="max-height: 250px; overflow-y: auto;">
                {% for sub in subscriptions|sort(attribute='cost', reverse=true) %}
                <div class="flex justify-between items-center p-2 rounded"
                    style="background: var(--color-bg-secondary);">
                    <div>
                        <span class="font-medium">{{ sub.vendor_name }}</span>
                        <span
                            class="badge badge-{{ 'success' if sub.status.value == 'active' else 'secondary' }} ml-2">{{
                            sub.status.value }}</span>
                    </div>
                    <span class="font-bold">${{ "%.2f"|format(sub.cost) }}</span>
                </div>
                {% endfor %}
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}