{% extends "base.html" %}

{% block title %}AI Features - SubTrack{% endblock %}

{% block content %}
<div class="animate-fade-in">
    <!-- Header -->
    <div class="flex items-center justify-between mb-8">
        <div>
            <h1>ü§ñ AI Features</h1>
            <p class="text-secondary">Powered by Google AI Studio (Gemini)</p>
        </div>
        <div id="ai-status-container">
            <!-- AI Status loads here via HTMX -->
            <div hx-get="/api/ai/status" 
                 hx-trigger="load"
                 hx-swap="innerHTML"
                 class="ai-status-badge">
                <span class="loading-spinner"></span> Checking AI status...
            </div>
        </div>
    </div>

    <!-- AI Features Grid -->
    <div class="ai-features-grid">
        
        <!-- Smart Link Intelligence -->
        <div class="ai-feature-card">
            <div class="ai-feature-header">
                <span class="ai-feature-icon">üîó</span>
                <h4>Smart Link Intelligence</h4>
            </div>
            <p class="ai-feature-desc">Paste a subscription URL to automatically extract vendor, pricing, and plan details.</p>
            
            <div id="link-extract-form">
                <div class="input-group">
                    <input type="url" 
                           id="extract-url-input"
                           placeholder="https://example.com/pricing" 
                           class="input">
                    <button type="button" 
                            id="extract-btn"
                            class="btn btn-primary">
                        <span id="link-extract-loading" style="display:none;">
                            <span class="loading-spinner"></span>
                        </span>
                        <span class="btn-text">Extract</span>
                    </button>
                </div>
            </div>
            
            <div id="link-extract-result" class="ai-result-container"></div>
        </div>

        <!-- Budget Surgeon -->
        <div class="ai-feature-card">
            <div class="ai-feature-header">
                <span class="ai-feature-icon">üî™</span>
                <h4>Budget Surgeon</h4>
            </div>
            <p class="ai-feature-desc">Analyze all subscriptions to find duplicates, redundant services, and potential savings.</p>
            
            <button hx-post="/api/ai/budget-surgeon"
                    hx-target="#budget-surgeon-result"
                    hx-indicator="#budget-surgeon-loading"
                    class="btn btn-secondary w-full">
                <span id="budget-surgeon-loading" class="htmx-indicator">
                    <span class="loading-spinner"></span>
                </span>
                <span class="btn-text">üîç Find Savings</span>
            </button>
            
            <div id="budget-surgeon-result" class="ai-result-container"></div>
        </div>

        <!-- Renewal Forecaster -->
        <div class="ai-feature-card">
            <div class="ai-feature-header">
                <span class="ai-feature-icon">üìÖ</span>
                <h4>Renewal Forecaster</h4>
            </div>
            <p class="ai-feature-desc">Predict your subscription costs for the next 12 months with AI-powered insights.</p>
            
            <button hx-post="/api/ai/renewal-forecast"
                    hx-target="#forecast-result"
                    hx-indicator="#forecast-loading"
                    class="btn btn-secondary w-full">
                <span id="forecast-loading" class="htmx-indicator">
                    <span class="loading-spinner"></span>
                </span>
                <span class="btn-text">üìä Generate Forecast</span>
            </button>
            
            <div id="forecast-result" class="ai-result-container"></div>
        </div>

        <!-- Ask SubTrack (Chat) -->
        <div class="ai-feature-card">
            <div class="ai-feature-header">
                <span class="ai-feature-icon">üí¨</span>
                <h4>Ask SubTrack</h4>
            </div>
            <p class="ai-feature-desc">Ask questions about SubTrack or your subscription data and get instant answers.</p>
            
            <div class="ai-page-chat">
                <div class="ai-page-chat-messages" id="ai-page-chat-messages">
                    <div class="ai-result ai-result-success">
                        <div class="ai-success">
                            <strong>Hi! I‚Äôm your SubTrack assistant.</strong>
                            <div class="text-secondary text-sm">Try: ‚ÄúWhat are my most expensive subscriptions?‚Äù</div>
                        </div>
                    </div>
                </div>
                
                <div class="ai-page-chat-suggestions">
                    <button type="button" class="btn btn-secondary btn-sm" onclick="aiPageChatSend('Summarize my current subscription spending')">Spending summary</button>
                    <button type="button" class="btn btn-secondary btn-sm" onclick="aiPageChatSend('What features does SubTrack have?')">App features</button>
                    <button type="button" class="btn btn-secondary btn-sm" onclick="aiPageChatSend('Find potential duplicates in my subscriptions')">Find duplicates</button>
                </div>

                <div class="ai-page-chat-input">
                    <input id="ai-page-chat-input" class="input" placeholder="Ask a question..." onkeypress="if(event.key==='Enter'){ aiPageChatSend(); }" />
                    <button id="ai-page-chat-send" class="btn btn-primary" type="button" onclick="aiPageChatSend()">Send</button>
                </div>
            </div>
        </div>

        <!-- Auto-Categorizer -->
        <div class="ai-feature-card">
            <div class="ai-feature-header">
                <span class="ai-feature-icon">üìÅ</span>
                <h4>Auto-Categorizer</h4>
            </div>
            <p class="ai-feature-desc">Get AI-suggested categories for any subscription vendor.</p>
            
            <div id="categorize-form">
                <div class="input-group mb-2">
                    <input type="text" 
                           id="categorize-vendor-input"
                           placeholder="Vendor name (e.g., Adobe)" 
                           class="input">
                </div>
                <div class="input-group">
                    <input type="text" 
                           id="categorize-plan-input"
                           placeholder="Plan name (optional)" 
                           class="input">
                    <button type="button" 
                            id="categorize-btn"
                            class="btn btn-primary">
                        <span id="categorize-loading" class="htmx-indicator" style="display:none;">
                            <span class="loading-spinner"></span>
                        </span>
                        <span class="btn-text">Suggest</span>
                    </button>
                </div>
            </div>
            
            <div id="categorize-result" class="ai-result-container"></div>
        </div>
    </div>

    <!-- Cache Stats Section -->
    <div class="card mt-8">
        <div class="flex items-center justify-between mb-4">
            <h3>üìä AI Cache Statistics</h3>
            <button hx-post="/api/ai/cache/clear-expired"
                    hx-target="#cache-stats"
                    hx-swap="outerHTML"
                    class="btn btn-secondary btn-sm">
                üßπ Clear Expired
            </button>
        </div>
        <div id="cache-stats" 
             hx-get="/api/ai/cache/stats" 
             hx-trigger="load"
             hx-swap="innerHTML">
            <span class="loading-spinner"></span> Loading cache stats...
        </div>
    </div>

    <!-- Usage Tips -->
    <div class="card mt-8">
        <h3>üí° Tips for Using AI Features</h3>
        <div class="grid grid-cols-2 gap-4 mt-4">
            <div>
                <h4 class="text-primary">üîó Link Intelligence</h4>
                <ul class="text-secondary text-sm">
                    <li>Paste pricing page URLs for best results</li>
                    <li>Works great with popular SaaS products</li>
                    <li>Results are cached for 24 hours</li>
                </ul>
            </div>
            <div>
                <h4 class="text-primary">üî™ Budget Surgeon</h4>
                <ul class="text-secondary text-sm">
                    <li>Analyzes all active subscriptions</li>
                    <li>Finds overlapping services automatically</li>
                    <li>Suggests specific cost-cutting actions</li>
                </ul>
            </div>
            <div>
                <h4 class="text-primary">üìÖ Renewal Forecaster</h4>
                <ul class="text-secondary text-sm">
                    <li>Predicts costs 12 months ahead</li>
                    <li>Identifies peak spending months</li>
                    <li>Helps with budget planning</li>
                </ul>
            </div>
            <div>
                <h4 class="text-primary">üìÅ Auto-Categorizer</h4>
                <ul class="text-secondary text-sm">
                    <li>Suggests categories with confidence %</li>
                    <li>Shows alternative options</li>
                    <li>Learn from your existing categories</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Free Tier Info -->
    <div class="card mt-8" style="background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(139, 92, 246, 0.1)); border-color: var(--color-primary);">
        <div class="flex items-center gap-4">
            <span style="font-size: 2rem;">üéÅ</span>
            <div>
                <h4 class="text-primary mb-1">Free Tier: Generous Daily Quota</h4>
                <p class="text-secondary text-sm mb-0">
                    You're using Google AI Studio's free tier with Gemini models. 
                    Responses are cached for 24 hours to maximize your daily quota.
                    Most users hit cache 80%+ of the time after the first day!
                </p>
            </div>
        </div>
    </div>
</div>

<script>
// Helper function to show loading state
function setLoading(buttonId, loadingId, isLoading) {
    const btn = document.getElementById(buttonId);
    const loading = document.getElementById(loadingId);
    const btnText = btn?.querySelector('.btn-text');
    
    if (isLoading) {
        if (loading) loading.style.display = 'inline-flex';
        if (btnText) btnText.style.display = 'none';
        if (btn) btn.disabled = true;
    } else {
        if (loading) loading.style.display = 'none';
        if (btnText) btnText.style.display = 'inline';
        if (btn) btn.disabled = false;
    }
}

// Link Intelligence - Extract from URL
document.getElementById('extract-btn')?.addEventListener('click', async function() {
    const url = document.getElementById('extract-url-input').value.trim();
    if (!url) {
        document.getElementById('link-extract-result').innerHTML = `
            <div class="ai-result ai-result-error">
                <div class="ai-error"><span class="ai-error-icon">‚ö†Ô∏è</span><div><strong>Please enter a URL</strong></div></div>
            </div>`;
        return;
    }
    
    setLoading('extract-btn', 'link-extract-loading', true);
    
    try {
        const response = await fetch('/api/ai/extract-from-url', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ url: url })
        });
        const html = await response.text();
        document.getElementById('link-extract-result').innerHTML = html;
    } catch (error) {
        document.getElementById('link-extract-result').innerHTML = `
            <div class="ai-result ai-result-error">
                <div class="ai-error"><span class="ai-error-icon">‚ö†Ô∏è</span><div><strong>Error: ${error.message}</strong></div></div>
            </div>`;
    }
    
    setLoading('extract-btn', 'link-extract-loading', false);
});

// Auto-Categorizer
document.getElementById('categorize-btn')?.addEventListener('click', async function() {
    const vendorName = document.getElementById('categorize-vendor-input').value.trim();
    const planName = document.getElementById('categorize-plan-input').value.trim();
    
    if (!vendorName) {
        document.getElementById('categorize-result').innerHTML = `
            <div class="ai-result ai-result-error">
                <div class="ai-error"><span class="ai-error-icon">‚ö†Ô∏è</span><div><strong>Please enter a vendor name</strong></div></div>
            </div>`;
        return;
    }
    
    setLoading('categorize-btn', 'categorize-loading', true);
    
    try {
        const response = await fetch('/api/ai/categorize-subscription', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ vendor_name: vendorName, plan_name: planName || null })
        });
        const html = await response.text();
        document.getElementById('categorize-result').innerHTML = html;
    } catch (error) {
        document.getElementById('categorize-result').innerHTML = `
            <div class="ai-result ai-result-error">
                <div class="ai-error"><span class="ai-error-icon">‚ö†Ô∏è</span><div><strong>Error: ${error.message}</strong></div></div>
            </div>`;
    }
    
    setLoading('categorize-btn', 'categorize-loading', false);
});

// Apply extracted data to subscription form (if available)
function applyExtractedData(data) {
    // Store in sessionStorage for use in subscription form
    sessionStorage.setItem('ai_extracted_data', JSON.stringify(data));
    
    // Show success message
    alert('Data saved! Go to Add Subscription to use these details.');
}

// Ask SubTrack (page chat)
async function aiPageChatSend(prefillText=null) {
    const input = document.getElementById('ai-page-chat-input');
    const sendBtn = document.getElementById('ai-page-chat-send');
    const messages = document.getElementById('ai-page-chat-messages');

    const text = (prefillText !== null ? prefillText : (input?.value || '')).trim();
    if (!text) return;

    // Clear input if user typed it
    if (prefillText === null && input) input.value = '';

    // Add user bubble
    const user = document.createElement('div');
    user.className = 'ai-page-chat-bubble user';
    user.textContent = text;
    messages.appendChild(user);

    // Typing indicator
    const typing = document.createElement('div');
    typing.className = 'ai-page-chat-bubble assistant';
    typing.textContent = 'Thinking...';
    messages.appendChild(typing);

    messages.scrollTop = messages.scrollHeight;

    if (sendBtn) sendBtn.disabled = true;

    try {
        const resp = await fetch('/api/ai/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message: text })
        });
        const data = await resp.json();

        typing.textContent = (data && data.response) ? data.response : 'No response received.';
        typing.classList.add(data?.error ? 'error' : '');

    } catch (e) {
        typing.textContent = 'Sorry ‚Äî I could not reach the AI service. Please try again.';
        typing.classList.add('error');
    } finally {
        if (sendBtn) sendBtn.disabled = false;
        messages.scrollTop = messages.scrollHeight;
    }
}

// Apply category suggestion
function applyCategorySuggestion(categoryName, categoryId) {
    sessionStorage.setItem('ai_suggested_category', JSON.stringify({
        name: categoryName,
        id: categoryId
    }));
    
    alert('Category saved! This will be pre-selected when adding subscriptions.');
}
</script>
{% endblock %}
