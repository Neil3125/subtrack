{% extends "base.html" %}

{% block title %}Settings - SubTrack Web{% endblock %}

{% block content %}
<div class="animate-fade-in">
    <div class="mb-8">
        <h1>‚öôÔ∏è Settings</h1>
        <p class="text-secondary">Customize your SubTrack experience</p>
    </div>

    <div class="grid grid-cols-1 gap-6">
        <!-- Appearance Settings -->
        <div class="card card-hover">
            <div class="card-header">
                <h2 class="card-title">üé® Appearance</h2>
            </div>
            <div class="card-body">
                <div class="flex items-center justify-between mb-4">
                    <div>
                        <div class="font-medium">Theme</div>
                        <div class="text-sm text-secondary">Choose between light and dark mode</div>
                    </div>
                    <button class="btn btn-primary" onclick="toggleTheme()">
                        <span id="theme-text">Switch Theme</span>
                    </button>
                </div>
                
                <div class="flex items-center justify-between mb-4">
                    <div>
                        <div class="font-medium">Animations</div>
                        <div class="text-sm text-secondary">Enable smooth animations and transitions</div>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="animations-toggle" checked onchange="toggleAnimations(this.checked)">
                        <span class="toggle-slider"></span>
                    </label>
                </div>

                <div class="flex items-center justify-between">
                    <div>
                        <div class="font-medium">Compact Mode</div>
                        <div class="text-sm text-secondary">Reduce spacing for more content</div>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="compact-toggle" onchange="toggleCompactMode(this.checked)">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
            </div>
        </div>

        <!-- Dashboard Settings -->
        <div class="card card-hover">
            <div class="card-header">
                <h2 class="card-title">üìä Dashboard</h2>
            </div>
            <div class="card-body">
                <div class="form-group">
                    <label class="form-label">Default View</label>
                    <select class="form-select" id="default-view" onchange="saveSettings()">
                        <option value="dashboard">Dashboard</option>
                        <option value="categories">Categories</option>
                        <option value="subscriptions">All Subscriptions</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Items Per Page</label>
                    <select class="form-select" id="items-per-page" onchange="saveSettings()">
                        <option value="10">10</option>
                        <option value="25" selected>25</option>
                        <option value="50">50</option>
                        <option value="100">100</option>
                    </select>
                </div>

                <div class="flex items-center justify-between">
                    <div>
                        <div class="font-medium">Show Empty Categories</div>
                        <div class="text-sm text-secondary">Display categories with no subscriptions</div>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="show-empty" checked onchange="saveSettings()">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
            </div>
        </div>

        <!-- Smart Links Settings -->
        <div class="card card-hover">
            <div class="card-header">
                <h2 class="card-title">üîó Smart Links & Relationships</h2>
            </div>
            <div class="card-body">
                <div class="flex items-center justify-between mb-4">
                    <div>
                        <div class="font-medium">Auto-Analyze Links</div>
                        <div class="text-sm text-secondary">Automatically analyze relationships between items</div>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="auto-analyze" checked onchange="saveSettings()">
                        <span class="toggle-slider"></span>
                    </label>
                </div>

                <div class="flex items-center justify-between mb-4">
                    <div>
                        <div class="font-medium">Show Confidence Scores</div>
                        <div class="text-sm text-secondary">Display confidence levels on links</div>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="show-confidence" checked onchange="saveSettings()">
                        <span class="toggle-slider"></span>
                    </label>
                </div>

                <div class="form-group">
                    <label class="form-label">Link Confidence Threshold</label>
                    <input type="range" class="form-input" id="confidence-threshold" min="0" max="100" value="40" 
                           onchange="saveSettings(); document.getElementById('confidence-value').textContent = this.value + '%'">
                    <small id="confidence-value">40%</small>
                    <div class="text-sm text-secondary">Minimum confidence to show suggested links</div>
                </div>
            </div>
        </div>

        <!-- Notification Settings -->
        <div class="card card-hover">
            <div class="card-header">
                <h2 class="card-title">üîî Notifications</h2>
            </div>
            <div class="card-body">
                <div class="form-group">
                    <label class="form-label">Renewal Reminder (Days Before)</label>
                    <input type="number" class="form-input" id="reminder-days" value="30" min="1" max="365" onchange="saveSettings()">
                </div>

                <div class="flex items-center justify-between mb-4">
                    <div>
                        <div class="font-medium">Email Notifications</div>
                        <div class="text-sm text-secondary">Receive email alerts for renewals</div>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="email-notifications" onchange="saveSettings()">
                        <span class="toggle-slider"></span>
                    </label>
                </div>

                <div class="flex items-center justify-between mb-4">
                    <div>
                        <div class="font-medium">Desktop Notifications</div>
                        <div class="text-sm text-secondary">Show browser notifications</div>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="desktop-notifications" onchange="toggleDesktopNotifications(this.checked)">
                        <span class="toggle-slider"></span>
                    </label>
                </div>

                <div class="flex items-center justify-between">
                    <div>
                        <div class="font-medium">Sound Alerts</div>
                        <div class="text-sm text-secondary">Play sound for important alerts</div>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="sound-alerts" onchange="saveSettings()">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
            </div>
        </div>

        <!-- Data Management -->
        <div class="card card-hover">
            <div class="card-header">
                <h2 class="card-title">üíæ Data Management</h2>
            </div>
            <div class="card-body">
                <div class="flex items-center justify-between mb-4">
                    <div>
                        <div class="font-medium">Auto-Save</div>
                        <div class="text-sm text-secondary">Automatically save changes</div>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="auto-save" checked onchange="saveSettings()">
                        <span class="toggle-slider"></span>
                    </label>
                </div>

                <div class="mb-4">
                    <div class="text-sm font-medium mb-2">Backup & Restore</div>
                    <div class="flex gap-3 flex-wrap">
                        <button class="btn btn-primary" onclick="exportData()">
                            üì• Export Data
                        </button>
                        <button class="btn btn-primary" onclick="document.getElementById('import-file').click()">
                            üì§ Import Data
                        </button>
                        <input type="file" id="import-file" style="display: none;" accept=".json" onchange="importData(this.files[0])">
                    </div>
                    <div class="text-xs text-secondary mt-2">
                        üí° Tip: Always export your data before clearing records or making major changes
                    </div>
                </div>

                <div class="mb-4">
                    <div class="text-sm font-medium mb-2">Cache & Settings</div>
                    <div class="flex gap-3 flex-wrap">
                        <button class="btn btn-warning" onclick="clearCache()">
                            üóëÔ∏è Clear Cache
                        </button>
                        <button class="btn btn-warning" onclick="resetSettings()">
                            üîÑ Reset Settings
                        </button>
                    </div>
                </div>

                <div class="mb-0">
                    <div class="text-sm font-medium mb-2" style="color: var(--color-danger);">‚ö†Ô∏è Danger Zone</div>
                    <button class="btn btn-danger" onclick="confirmClearAllRecords()">
                        üóëÔ∏è Clear All Records
                    </button>
                    <div class="text-xs text-secondary mt-2">
                        ‚ö†Ô∏è This will permanently delete all categories, customers, subscriptions, and groups. Export your data first!
                    </div>
                </div>
            </div>
        </div>

        <!-- Cloud Backup (Data Persistence) -->
        <div class="card card-hover" style="border: 2px solid var(--color-warning); background: var(--color-warning-bg);">
            <div class="card-header">
                <h2 class="card-title">‚òÅÔ∏è Cloud Backup (IMPORTANT)</h2>
            </div>
            <div class="card-body">
                <div class="mb-4" style="background: var(--color-bg); padding: 16px; border-radius: 8px; border: 1px solid var(--color-border);">
                    <div class="font-medium mb-2">‚ö†Ô∏è Data Persistence for Deployments</div>
                    <div class="text-sm text-secondary mb-3">
                        If you're using Railway, Render, or Heroku, your data may be lost when you push new code.
                        <strong>Use the button below to generate a backup string</strong>, then set it as the 
                        <code style="background: var(--color-bg-tertiary); padding: 2px 6px; border-radius: 4px;">SUBTRACK_DATA</code> 
                        environment variable in your deployment platform.
                    </div>
                </div>

                <div class="flex gap-3 mb-4">
                    <button class="btn btn-primary" onclick="generateBackupString()">
                        üîê Generate Backup String
                    </button>
                    <button class="btn btn-secondary" onclick="downloadBackupFile()">
                        üíæ Download JSON Backup
                    </button>
                </div>

                <div id="backup-string-container" style="display: none;">
                    <div class="form-group">
                        <label class="form-label">Backup String (copy this entire value)</label>
                        <textarea id="backup-string-output" class="form-input" rows="4" readonly 
                            style="font-family: monospace; font-size: 12px; word-break: break-all;"></textarea>
                    </div>
                    <div class="flex gap-3">
                        <button class="btn btn-success" onclick="copyBackupString()">
                            üìã Copy to Clipboard
                        </button>
                    </div>
                    <div class="text-sm text-secondary mt-3">
                        <strong>Instructions:</strong><br>
                        1. Copy the string above<br>
                        2. Go to Railway/Render/Heroku dashboard ‚Üí Environment Variables<br>
                        3. Create variable: <code>SUBTRACK_DATA</code> = (paste the string)<br>
                        4. Redeploy your app - data will auto-restore!
                    </div>
                </div>

                <div id="backup-stats" class="mt-4" style="display: none;">
                    <div class="text-sm font-medium mb-2">Backup contains:</div>
                    <div class="grid grid-cols-4 gap-2 text-center">
                        <div style="background: var(--color-bg); padding: 8px; border-radius: 6px;">
                            <div class="text-lg font-bold" id="backup-categories">0</div>
                            <div class="text-xs text-secondary">Categories</div>
                        </div>
                        <div style="background: var(--color-bg); padding: 8px; border-radius: 6px;">
                            <div class="text-lg font-bold" id="backup-customers">0</div>
                            <div class="text-xs text-secondary">Customers</div>
                        </div>
                        <div style="background: var(--color-bg); padding: 8px; border-radius: 6px;">
                            <div class="text-lg font-bold" id="backup-subscriptions">0</div>
                            <div class="text-xs text-secondary">Subscriptions</div>
                        </div>
                        <div style="background: var(--color-bg); padding: 8px; border-radius: 6px;">
                            <div class="text-lg font-bold" id="backup-groups">0</div>
                            <div class="text-xs text-secondary">Groups</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- System Info -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">‚ÑπÔ∏è System Information</h2>
            </div>
            <div class="card-body">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <div class="text-sm text-secondary">Version</div>
                        <div class="font-medium">1.0.0</div>
                    </div>
                    <div>
                        <div class="text-sm text-secondary">Database</div>
                        <div class="font-medium">SQLite</div>
                    </div>
                    <div>
                        <div class="text-sm text-secondary">Theme</div>
                        <div class="font-medium" id="current-theme">Light</div>
                    </div>
                    <div>
                        <div class="text-sm text-secondary">Links</div>
                        <div class="font-medium">Smart Links Enabled</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* Toggle Switch */
.toggle-switch {
    position: relative;
    display: inline-block;
    width: 50px;
    height: 24px;
}

.toggle-switch input {
    opacity: 0;
    width: 0;
    height: 0;
}

.toggle-slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: var(--color-bg-tertiary);
    transition: 0.3s;
    border-radius: 24px;
    border: 1px solid var(--color-border);
}

.toggle-slider:before {
    position: absolute;
    content: "";
    height: 18px;
    width: 18px;
    left: 3px;
    bottom: 2px;
    background-color: white;
    transition: 0.3s;
    border-radius: 50%;
}

.toggle-switch input:checked + .toggle-slider {
    background-color: var(--color-primary);
}

.toggle-switch input:checked + .toggle-slider:before {
    transform: translateX(26px);
}

/* Range Slider */
.form-range {
    width: 100%;
    height: 8px;
    background: var(--color-bg-tertiary);
    border-radius: var(--radius-full);
    outline: none;
    -webkit-appearance: none;
}

.form-range::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 20px;
    height: 20px;
    background: var(--color-primary);
    cursor: pointer;
    border-radius: 50%;
}

.form-range::-moz-range-thumb {
    width: 20px;
    height: 20px;
    background: var(--color-primary);
    cursor: pointer;
    border-radius: 50%;
    border: none;
}
</style>

<script>
// Load settings on page load
document.addEventListener('DOMContentLoaded', function() {
    loadSettings();
    updateCurrentTheme();
});

function loadSettings() {
    const settings = JSON.parse(localStorage.getItem('subtrack_settings') || '{}');
    
    // Apply saved settings
    if (settings.defaultView) document.getElementById('default-view').value = settings.defaultView;
    if (settings.itemsPerPage) document.getElementById('items-per-page').value = settings.itemsPerPage;
    if (settings.reminderDays) document.getElementById('reminder-days').value = settings.reminderDays;
    // Apply toggle states
    if (settings.animations !== undefined) document.getElementById('animations-toggle').checked = settings.animations;
    if (settings.compactMode !== undefined) document.getElementById('compact-toggle').checked = settings.compactMode;
    if (settings.showEmpty !== undefined) document.getElementById('show-empty').checked = settings.showEmpty;
}

function saveSettings() {
    const settings = {
        defaultView: document.getElementById('default-view').value,
        itemsPerPage: document.getElementById('items-per-page').value,
        reminderDays: document.getElementById('reminder-days').value,
        animations: document.getElementById('animations-toggle').checked,
        compactMode: document.getElementById('compact-toggle').checked,
        showEmpty: document.getElementById('show-empty').checked,
        emailNotifications: document.getElementById('email-notifications').checked,
        desktopNotifications: document.getElementById('desktop-notifications').checked,
        soundAlerts: document.getElementById('sound-alerts').checked,
        autoSave: document.getElementById('auto-save').checked
    };
    
    localStorage.setItem('subtrack_settings', JSON.stringify(settings));
    showToast('Settings saved', 'success');
}

function updateThresholdLabel(value) {
    document.getElementById('threshold-value').textContent = value + '%';
}

function toggleAnimations(enabled) {
    document.documentElement.style.setProperty('--transition-fast', enabled ? '150ms' : '0ms');
    document.documentElement.style.setProperty('--transition-base', enabled ? '250ms' : '0ms');
    document.documentElement.style.setProperty('--transition-slow', enabled ? '350ms' : '0ms');
    saveSettings();
    showToast(`Animations ${enabled ? 'enabled' : 'disabled'}`, 'success');
}

function toggleCompactMode(enabled) {
    if (enabled) {
        document.documentElement.style.setProperty('--space-4', '0.75rem');
        document.documentElement.style.setProperty('--space-6', '1rem');
        document.documentElement.style.setProperty('--space-8', '1.5rem');
    } else {
        document.documentElement.style.setProperty('--space-4', '1rem');
        document.documentElement.style.setProperty('--space-6', '1.5rem');
        document.documentElement.style.setProperty('--space-8', '2rem');
    }
    saveSettings();
    showToast(`Compact mode ${enabled ? 'enabled' : 'disabled'}`, 'success');
}

function toggleDesktopNotifications(enabled) {
    if (enabled && 'Notification' in window) {
        Notification.requestPermission().then(permission => {
            if (permission === 'granted') {
                showToast('Desktop notifications enabled', 'success');
                new Notification('SubTrack', {
                    body: 'You will now receive desktop notifications',
                    icon: '/static/favicon.ico'
                });
            }
        });
    }
    saveSettings();
}

function updateCurrentTheme() {
    const theme = document.documentElement.getAttribute('data-theme');
    document.getElementById('current-theme').textContent = theme === 'dark' ? 'Dark' : 'Light';
}

// Override toggleTheme to update settings page
const originalToggleTheme = window.toggleTheme;
window.toggleTheme = function() {
    originalToggleTheme();
    updateCurrentTheme();
};

function exportData() {
    showToast('Exporting data...', 'info');
    fetch('/api/export')
        .then(response => {
            if (!response.ok) {
                throw new Error('Export failed');
            }
            return response.blob();
        })
        .then(blob => {
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `subtrack_backup_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            showToast('‚úÖ Data exported successfully!', 'success');
        })
        .catch(error => {
            console.error('Export error:', error);
            showToast('‚ùå Export failed. Please try again.', 'error');
        });
}

async function importData(file) {
    if (!file) return;
    
    // Reset the file input
    const fileInput = document.getElementById('import-file');
    
    // Confirm before importing
    if (!confirm('‚ö†Ô∏è Import data from this file?\n\nThis will ADD new records to your database.\nExisting records with the same IDs will NOT be overwritten.\n\nContinue?')) {
        fileInput.value = '';
        return;
    }
    
    showToast('üìñ Reading file...', 'info');
    
    const reader = new FileReader();
    reader.onload = async function(e) {
        try {
            const data = JSON.parse(e.target.result);
            console.log('Parsed import data:', {
                categories: data.categories?.length || 0,
                groups: data.groups?.length || 0,
                customers: data.customers?.length || 0,
                subscriptions: data.subscriptions?.length || 0
            });
            
            // Validate the data structure
            if (!data.categories && !data.customers && !data.subscriptions && !data.groups) {
                showToast('‚ùå Invalid file format. Expected SubTrack backup JSON.', 'error');
                fileInput.value = '';
                return;
            }
            
            showToast('üì• Importing data...', 'info');
            
            // Send to import endpoint
            const response = await fetch('/api/import/data', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            });
            
            if (!response.ok) {
                const errorText = await response.text();
                console.error('Import response not OK:', response.status, errorText);
                showToast(`‚ùå Import failed: ${response.status} - ${errorText}`, 'error');
                fileInput.value = '';
                return;
            }
            
            const result = await response.json();
            console.log('Import result:', result);
            
            if (result.error) {
                console.error('Import error from server:', result.error);
                showToast('‚ùå ' + result.error, 'error');
            } else {
                const imported = result.imported;
                showToast(
                    `‚úÖ Import successful!\n${imported.categories} categories, ${imported.groups} groups, ${imported.customers} customers, ${imported.subscriptions} subscriptions`,
                    'success'
                );
                // Reload page after short delay to show new data
                setTimeout(() => {
                    if (confirm('Import complete! Reload page to see imported data?')) {
                        window.location.reload();
                    }
                }, 1500);
            }
        } catch (error) {
            console.error('Import error:', error);
            showToast('‚ùå Invalid file format or import failed', 'error');
        } finally {
            fileInput.value = '';
        }
    };
    
    reader.onerror = function() {
        showToast('‚ùå Failed to read file', 'error');
        fileInput.value = '';
    };
    
    reader.readAsText(file);
}

function clearCache() {
    if (confirm('Clear all cached data? This will not delete your subscriptions.')) {
        localStorage.removeItem('subtrack_cache');
        showToast('‚úÖ Cache cleared', 'success');
    }
}

function resetSettings() {
    if (confirm('Reset all settings to default? This cannot be undone.')) {
        localStorage.removeItem('subtrack_settings');
        location.reload();
    }
}

async function confirmClearAllRecords() {
    // First confirmation
    const firstConfirm = confirm(
        '‚ö†Ô∏è WARNING: Clear All Records?\n\n' +
        'This will PERMANENTLY DELETE:\n' +
        '‚Ä¢ All categories\n' +
        '‚Ä¢ All groups\n' +
        '‚Ä¢ All customers\n' +
        '‚Ä¢ All subscriptions\n' +
        '‚Ä¢ All links\n' +
        '‚Ä¢ All saved reports\n' +
        '‚Ä¢ All activity logs\n\n' +
        'This action CANNOT be undone!\n\n' +
        'Have you exported your data?\n\n' +
        'Click OK to continue or Cancel to abort.'
    );
    
    if (!firstConfirm) {
        showToast('Operation cancelled', 'info');
        return;
    }
    
    // Second confirmation - make them type
    const confirmation = prompt(
        'To confirm, please type "DELETE ALL" (in capital letters):'
    );
    
    if (confirmation !== 'DELETE ALL') {
        showToast('‚ùå Confirmation text did not match. Operation cancelled.', 'warning');
        return;
    }
    
    // Final confirmation
    const finalConfirm = confirm(
        '‚ö†Ô∏è FINAL WARNING!\n\n' +
        'This is your last chance to cancel.\n\n' +
        'All data will be permanently deleted.\n\n' +
        'Are you absolutely sure?'
    );
    
    if (!finalConfirm) {
        showToast('Operation cancelled', 'info');
        return;
    }
    
    // Proceed with deletion
    showToast('üóëÔ∏è Clearing all records...', 'info');
    
    try {
        const response = await fetch('/api/clear-all-records', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        const result = await response.json();
        
        if (result.error) {
            showToast('‚ùå Error: ' + result.error, 'error');
        } else {
            const deleted = result.deleted;
            showToast(
                `‚úÖ All records cleared!\n\n` +
                `Deleted:\n` +
                `${deleted.categories} categories\n` +
                `${deleted.groups} groups\n` +
                `${deleted.customers} customers\n` +
                `${deleted.subscriptions} subscriptions`,
                'success'
            );
            
            // Reload after short delay
            setTimeout(() => {
                window.location.href = '/';
            }, 2000);
        }
    } catch (error) {
        console.error('Clear records error:', error);
        showToast('‚ùå Failed to clear records. Please try again.', 'error');
    }
}

// Cloud Backup Functions
async function generateBackupString() {
    try {
        showToast('Generating backup...', 'info');
        const response = await fetch('/api/export/data-string');
        const data = await response.json();
        
        if (data.data_string) {
            document.getElementById('backup-string-output').value = data.data_string;
            document.getElementById('backup-string-container').style.display = 'block';
            document.getElementById('backup-stats').style.display = 'block';
            
            // Update stats
            document.getElementById('backup-categories').textContent = data.data_stats.categories;
            document.getElementById('backup-customers').textContent = data.data_stats.customers;
            document.getElementById('backup-subscriptions').textContent = data.data_stats.subscriptions;
            document.getElementById('backup-groups').textContent = data.data_stats.groups;
            
            showToast('Backup string generated! Copy it to your deployment settings.', 'success');
        } else {
            showToast('Failed to generate backup', 'error');
        }
    } catch (error) {
        console.error('Backup error:', error);
        showToast('Error generating backup', 'error');
    }
}

async function copyBackupString() {
    const textarea = document.getElementById('backup-string-output');
    try {
        await navigator.clipboard.writeText(textarea.value);
        showToast('Backup string copied to clipboard!', 'success');
    } catch (error) {
        // Fallback for older browsers
        textarea.select();
        document.execCommand('copy');
        showToast('Backup string copied!', 'success');
    }
}

async function downloadBackupFile() {
    try {
        showToast('Preparing download...', 'info');
        const response = await fetch('/api/export/data-backup');
        const blob = await response.blob();
        
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `subtrack_backup_${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
        
        showToast('Backup file downloaded!', 'success');
    } catch (error) {
        console.error('Download error:', error);
        showToast('Error downloading backup', 'error');
    }
}
</script>
{% endblock %}
