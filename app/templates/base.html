<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}SubTrack Web{% endblock %}</title>
    
    <!-- Prevent FOUC (Flash of Unstyled Content) and dark mode flash -->
    <script>
        // Load theme IMMEDIATELY before any rendering
        (function() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            const savedVisualTheme = localStorage.getItem('visual-theme') || 'default';
            document.documentElement.setAttribute('data-theme', savedVisualTheme !== 'default' ? savedVisualTheme : savedTheme);
        })();
    </script>
    
    <!-- Preload critical resources -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" as="style">
    <link rel="preload" href="/static/css/style.css" as="style">
    
    <!-- Critical CSS inline for instant load -->
    <style>
        /* Prevent flash */
        html { background: var(--color-bg, #ffffff); }
        [data-theme="dark"] { background: var(--color-bg, #0d0d0d); }
        body { margin: 0; }
    </style>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/style.css">
    <link rel="stylesheet" href="/static/css/enhancements.css">
    <link rel="stylesheet" href="/static/css/themes.css">
    <link rel="stylesheet" href="/static/css/animations.css">
    <script src="https://unpkg.com/htmx.org@1.9.10" defer></script>
    {% block extra_head %}{% endblock %}
</head>
<body>
    <!-- Floating Particles Background -->
    <div class="particles">
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
    </div>
    
    <!-- Morphing Background Blobs -->
    <div class="blob blob-1"></div>
    <div class="blob blob-2"></div>
    <div class="blob blob-3"></div>
    <div class="blob blob-4"></div>
    
    <!-- Navbar -->
    <nav class="navbar">
        <a href="/" class="navbar-brand">
            <span>📊</span> SubTrack
        </a>
        
        <div class="navbar-search">
            <div class="search-wrapper">
                <!-- Hidden fields to trap browser autofill -->
                <input type="text" name="trap_username" style="display:none !important; position:absolute; left:-9999px;" tabindex="-1" autocomplete="username">
                <input type="password" name="trap_password" style="display:none !important; position:absolute; left:-9999px;" tabindex="-1" autocomplete="current-password">
                <input 
                    type="text" 
                    class="search-input" 
                    id="global-search-input"
                    placeholder="Search subscriptions, customers, vendors..."
                    hx-get="/search"
                    hx-trigger="keyup changed delay:300ms"
                    hx-target="#search-results"
                    hx-swap="innerHTML"
                    name="search_query_field"
                    autocomplete="off"
                    autocorrect="off"
                    autocapitalize="off"
                    spellcheck="false"
                    data-form-type="other"
                    data-lpignore="true"
                    data-1p-ignore="true"
                    aria-label="Search"
                    role="searchbox"
                    readonly
                    onfocus="this.removeAttribute('readonly');"
                >
                <span class="search-icon">🔍</span>
            </div>
            <div id="search-results" class="search-results"></div>
        </div>
        
        <div class="navbar-actions">
            <button class="btn btn-secondary btn-sm" onclick="toggleTheme()">
                <span id="theme-icon">🌙</span>
            </button>
            <div class="dropdown">
                <button class="btn btn-secondary btn-sm" data-tooltip-bottom="Visual Themes">
                    🎨
                </button>
                <div class="dropdown-menu">
                    <button onclick="setVisualTheme('default')" class="dropdown-item">
                        <span>🌊</span> Ocean (Default)
                    </button>
                    <button onclick="setVisualTheme('sunset')" class="dropdown-item">
                        <span>🌅</span> Sunset
                    </button>
                    <button onclick="setVisualTheme('midnight')" class="dropdown-item">
                        <span>🌙</span> Midnight
                    </button>
                    <button onclick="setVisualTheme('forest')" class="dropdown-item">
                        <span>🌲</span> Forest
                    </button>
                    <button onclick="setVisualTheme('candy')" class="dropdown-item">
                        <span>🍭</span> Candy
                    </button>
                    <button onclick="setVisualTheme('aurora')" class="dropdown-item">
                        <span>✨</span> Aurora
                    </button>
                </div>
            </div>
            <div class="dropdown">
                <button class="btn btn-secondary btn-sm" data-tooltip-bottom="Settings & More">
                    ⚙️
                </button>
                <div class="dropdown-menu">
                    <a href="/settings" class="dropdown-item">
                        <span>⚙️</span> Settings
                    </a>
                    
                    <a href="/reports" class="dropdown-item">
                        <span>📤</span> Reports & Exports
                    </a>
                    <button onclick="openShortcutsModal()" class="dropdown-item">
                        <span>⌨️</span> Keyboard Shortcuts
                    </button>
                    <button onclick="openAboutModal()" class="dropdown-item">
                        <span>ℹ️</span> About
                    </button>
                    <button onclick="window.location.reload()" class="dropdown-item">
                        <span>🔄</span> Refresh Page
                    </button>
                    <div class="dropdown-divider"></div>
                    <a href="/docs" target="_blank" class="dropdown-item">
                        <span>📚</span> API Docs
                    </a>
                    <div class="dropdown-divider"></div>
                    <a href="/logout" class="dropdown-item" style="color: var(--color-danger);">
                        <span>🚪</span> Logout
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-section">
                <h3 class="sidebar-title">Navigation</h3>
                <ul class="sidebar-nav">
                    <li class="sidebar-nav-item">
                        <a href="/" class="sidebar-nav-link {% if request.path == '/' %}active{% endif %}">
                            📊 Dashboard
                        </a>
                    </li>
                    <li class="sidebar-nav-item">
                        <a href="/categories" class="sidebar-nav-link {% if '/categories' in request.path and '/customers' not in request.path %}active{% endif %}">
                            📁 Categories
                        </a>
                    </li>
                    <li class="sidebar-nav-item">
                        <a href="/customers" class="sidebar-nav-link {% if request.path == '/customers' %}active{% endif %}">
                            👥 Customers
                        </a>
                    </li>
                    <li class="sidebar-nav-item">
                        <a href="/subscriptions" class="sidebar-nav-link {% if request.path == '/subscriptions' %}active{% endif %}">
                            📋 Subscriptions
                        </a>
                    </li>
                    <li class="sidebar-nav-item">
                        <a href="/analytics" class="sidebar-nav-link {% if '/analytics' in request.path %}active{% endif %}">
                            📈 Analytics
                        </a>
                    </li>
                    <li class="sidebar-nav-item">
                        <a href="/reports" class="sidebar-nav-link {% if '/reports' in request.path %}active{% endif %}">
                            📄 Reports
                        </a>
                    </li>
                    <li class="sidebar-nav-item">
                        <a href="/links" class="sidebar-nav-link {% if '/links' in request.path %}active{% endif %}">
                            🔗 Links
                        </a>
                    </li>
                    <li class="sidebar-nav-item">
                        <a href="/settings" class="sidebar-nav-link {% if '/settings' in request.path %}active{% endif %}">
                            ⚙️ Settings
                        </a>
                    </li>
                    <li class="sidebar-nav-item">
                        <a href="/users" class="sidebar-nav-link {% if '/users' in request.path %}active{% endif %}">
                            👥 Users
                        </a>
                    </li>
                    <li class="sidebar-nav-item">
                        <a href="/activity" class="sidebar-nav-link {% if '/activity' in request.path %}active{% endif %}">
                            📋 Activity Log
                        </a>
                    </li>
                </ul>
            </div>

            <div class="sidebar-section">
                <h3 class="sidebar-title">Categories</h3>
                <ul class="sidebar-nav" id="categories-list">
                    {% for category in categories|default([]) %}
                    <li class="sidebar-nav-item">
                        <a href="/categories/{{ category.id }}" class="sidebar-nav-link">
                            {{ category.name }}
                        </a>
                    </li>
                    {% endfor %}
                    {% if not categories %}
                    <li class="sidebar-nav-item">
                        <span class="sidebar-nav-link text-secondary">No categories yet</span>
                    </li>
                    {% endif %}
                </ul>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            {% block content %}{% endblock %}
        </main>
    </div>

    <!-- About Modal -->
    <div id="aboutModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">ℹ️ About SubTrack</h2>
                <button class="modal-close" onclick="closeModal('aboutModal')">×</button>
            </div>
            <div class="modal-body">
                <p class="text-secondary">
                    SubTrack helps you track subscriptions, renewals, and costs across categories and customers.
                </p>
                <div class="list-group">
                    <div class="list-group-item"><strong>Quick Add</strong> — Use the + button to create items fast</div>
                    <div class="list-group-item"><strong>Search</strong> — Search vendors/customers from the top bar</div>
                    <div class="list-group-item"><strong>Reports</strong> — Export your data anytime</div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" onclick="closeModal('aboutModal')">Close</button>
            </div>
        </div>
    </div>

    <!-- Keyboard Shortcuts Modal -->
    <div id="shortcutsModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">⌨️ Keyboard Shortcuts</h2>
                <button class="modal-close" onclick="closeModal('shortcutsModal')">×</button>
            </div>
            <div class="modal-body">
                <div class="list-group">
                    <div class="list-group-item"><strong>/</strong> — Focus global search</div>
                    <div class="list-group-item"><strong>N</strong> — Quick add</div>
                    <div class="list-group-item"><strong>Ctrl/Cmd + K</strong> — Command palette</div>
                    <div class="list-group-item"><strong>B</strong> — Toggle sidebar collapse</div>
                    <div class="list-group-item"><strong>Esc</strong> — Close open windows</div>
                </div>
                <p class="text-secondary" style="margin-top: var(--space-4); margin-bottom: 0;">
                    Tip: Use the command palette to navigate and create items quickly.
                </p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" onclick="closeModal('shortcutsModal')">Done</button>
            </div>
        </div>
    </div>

    <!-- Quick Add Modal -->
    <div id="quickAddModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Quick Add</h2>
                <button class="modal-close" onclick="closeModal('quickAddModal')">×</button>
            </div>
            <div class="modal-body">
                <div class="grid grid-cols-2 gap-4">
                    <button class="card card-hover" onclick="closeModal('quickAddModal'); openModal('categoryModal');" style="cursor: pointer; text-align: center; padding: var(--space-8);">
                        <div style="font-size: 3rem; margin-bottom: var(--space-3);">📁</div>
                        <h3>Category</h3>
                        <p class="text-secondary text-sm">Organize subscriptions</p>
                    </button>
                    <button class="card card-hover" onclick="closeModal('quickAddModal'); openModal('groupModal');" style="cursor: pointer; text-align: center; padding: var(--space-8);">
                        <div style="font-size: 3rem; margin-bottom: var(--space-3);">📦</div>
                        <h3>Group</h3>
                        <p class="text-secondary text-sm">Group customers</p>
                    </button>
                    <button class="card card-hover" onclick="closeModal('quickAddModal'); openModal('customerModal');" style="cursor: pointer; text-align: center; padding: var(--space-8);">
                        <div style="font-size: 3rem; margin-bottom: var(--space-3);">👤</div>
                        <h3>Customer</h3>
                        <p class="text-secondary text-sm">Add new customer</p>
                    </button>
                    <button class="card card-hover" onclick="closeModal('quickAddModal'); openModal('subscriptionModal');" style="cursor: pointer; text-align: center; padding: var(--space-8);">
                        <div style="font-size: 3rem; margin-bottom: var(--space-3);">📋</div>
                        <h3>Subscription</h3>
                        <p class="text-secondary text-sm">Track subscription</p>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Category Modal -->
    <div id="categoryModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Create Category</h2>
                <button class="modal-close" onclick="closeModal('categoryModal')">×</button>
            </div>
            <form onsubmit="handleFormSubmit(event, createCategory)">
                <div class="modal-body">
                    <div class="form-group">
                        <label class="form-label">Name *</label>
                        <input type="text" name="name" class="form-input" required placeholder="e.g., Cloud Services">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Description</label>
                        <textarea name="description" class="form-textarea" placeholder="Brief description of this category"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('categoryModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Category</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Group Modal -->
    <div id="groupModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Create Group</h2>
                <button class="modal-close" onclick="closeModal('groupModal')">×</button>
            </div>
            <form onsubmit="handleFormSubmit(event, createGroup)">
                <div class="modal-body">
                    <div class="form-group">
                        <label class="form-label">Category *</label>
                        <select name="category_id" class="form-select" required>
                            <option value="">Select a category</option>
                            {% for category in categories|default([]) %}
                            <option value="{{ category.id }}">{{ category.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Name *</label>
                        <input type="text" name="name" class="form-input" required placeholder="e.g., VPS Servers">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Notes</label>
                        <textarea name="notes" class="form-textarea" placeholder="Additional notes"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('groupModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Group</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Customer Modal -->
    <div id="customerModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2 class="modal-title">Create Customer</h2>
                <button class="modal-close" onclick="closeModal('customerModal')">×</button>
            </div>
            <form onsubmit="handleFormSubmit(event, createCustomer)">
                <div class="modal-body">
                    <div class="form-group">
                        <label class="form-label">Category *</label>
                        <select name="category_id" class="form-select" required onchange="updateGroupSelectMulti(this.value, 'customer-groups-container')">
                            <option value="">Select a category</option>
                            {% for category in categories|default([]) %}
                            <option value="{{ category.id }}">{{ category.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Groups (Optional - Multi-select)</label>
                        <div id="customer-groups-container" class="multi-select-container">
                            <div class="multi-select-placeholder">Select a category first to see available groups</div>
                        </div>
                        <input type="hidden" name="group_ids" id="customer-group-ids" value="">
                        <small class="text-secondary">Click to select multiple groups</small>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Name *</label>
                        <input type="text" name="name" class="form-input" required placeholder="Customer name">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="form-group">
                            <label class="form-label">Email</label>
                            <input type="email" name="email" class="form-input" placeholder="email@example.com">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Phone</label>
                            <input type="tel" name="phone" class="form-input" placeholder="+1-555-0000">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Country *</label>
                        <input type="text" name="country" class="form-input country-autocomplete" placeholder="Start typing country..." list="country-suggestions" autocomplete="off" required>
                        <datalist id="country-suggestions"></datalist>
                        <small class="text-secondary">Type to see suggestions from existing customers</small>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Tags</label>
                        <input type="text" name="tags" class="form-input" placeholder="vip, enterprise, etc.">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Notes</label>
                        <textarea name="notes" class="form-textarea" placeholder="Additional notes"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('customerModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Customer</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Subscription Modal -->
    <div id="subscriptionModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Create Subscription</h2>
                <button class="modal-close" onclick="closeModal('subscriptionModal')">×</button>
            </div>
            <form onsubmit="handleFormSubmit(event, createSubscription)">
                <div class="modal-body">
                    <div class="form-group">
                        <label class="form-label">Category *</label>
                        <select 
                            name="category_id" 
                            class="form-select" 
                            required 
                            hx-get="/partials/customer-options" 
                            hx-trigger="change" 
                            hx-target="#subscription-customer-select" 
                            hx-swap="innerHTML"
                            hx-include="[name='category_id']">
                            <option value="">Select a category</option>
                            {% for category in categories|default([]) %}
                            <option value="{{ category.id }}">{{ category.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Customer *</label>
                        <select name="customer_id" id="subscription-customer-select" class="form-select" required>
                            <option value="">Select a category first</option>
                        </select>
                        <small class="text-secondary" id="customer-count-message"></small>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Vendor Name *</label>
                        <input type="text" name="vendor_name" class="form-input" required placeholder="e.g., AWS, Netflix, Adobe">
                        <small class="text-secondary">The company providing the service</small>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Plan Name</label>
                        <input type="text" name="plan_name" class="form-input" placeholder="e.g., Professional, Premium">
                        <small class="text-secondary">Optional: The specific plan or tier</small>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="form-group">
                            <label class="form-label">Cost *</label>
                            <input type="number" step="0.01" name="cost" class="form-input" required placeholder="99.99">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Currency</label>
                            <select name="currency" class="form-select">
                                <option value="USD">USD</option>
                                <option value="EUR">EUR</option>
                                <option value="GBP">GBP</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Billing Cycle *</label>
                        <select name="billing_cycle" class="form-select" required>
                            <option value="monthly">Monthly</option>
                            <option value="quarterly">Quarterly</option>
                            <option value="yearly">Yearly</option>
                            <option value="weekly">Weekly</option>
                            <option value="biannual">Biannual</option>
                        </select>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="form-group">
                            <label class="form-label">Start Date *</label>
                            <input type="date" name="start_date" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Next Renewal *</label>
                            <input type="date" name="next_renewal_date" class="form-input" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Status</label>
                        <select name="status" class="form-select">
                            <option value="active">Active</option>
                            <option value="cancelled">Cancelled</option>
                            <option value="paused">Paused</option>
                            <option value="expired">Expired</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Country</label>
                        <input type="text" name="country" class="form-input country-autocomplete" placeholder="Start typing country..." autocomplete="off">
                        <small class="text-secondary">Type to see suggestions</small>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Notes</label>
                        <textarea name="notes" class="form-textarea" placeholder="Additional notes"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('subscriptionModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Subscription</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Category Modal -->
    <div id="editCategoryModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Edit Category</h2>
                <button class="modal-close" onclick="closeModal('editCategoryModal')">×</button>
            </div>
            <form onsubmit="handleFormSubmit(event, updateCategory)">
                <div class="modal-body">
                    <div class="form-group">
                        <label class="form-label">Name *</label>
                        <input type="text" name="name" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Description</label>
                        <textarea name="description" class="form-textarea"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('editCategoryModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update Category</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Group Modal -->
    <div id="editGroupModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Edit Group</h2>
                <button class="modal-close" onclick="closeModal('editGroupModal')">×</button>
            </div>
            <form onsubmit="handleFormSubmit(event, updateGroup)">
                <div class="modal-body">
                    <div class="form-group">
                        <label class="form-label">Category *</label>
                        <select name="category_id" class="form-select" required>
                            {% for category in categories|default([]) %}
                            <option value="{{ category.id }}">{{ category.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Name *</label>
                        <input type="text" name="name" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Notes</label>
                        <textarea name="notes" class="form-textarea"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('editGroupModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update Group</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Customer Modal -->
    <div id="editCustomerModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h2 class="modal-title">Edit Customer</h2>
                <button class="modal-close" onclick="closeModal('editCustomerModal')">×</button>
            </div>
            <form onsubmit="handleFormSubmit(event, updateCustomer)">
                <div class="modal-body">
                    <div class="form-group">
                        <label class="form-label">Category *</label>
                        <select name="category_id" class="form-select" required onchange="updateGroupSelectMulti(this.value, 'edit-customer-groups-container')">
                            {% for category in categories|default([]) %}
                            <option value="{{ category.id }}">{{ category.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Groups (Optional - Multi-select)</label>
                        <div id="edit-customer-groups-container" class="multi-select-container">
                            <div class="multi-select-placeholder">Loading groups...</div>
                        </div>
                        <input type="hidden" name="group_ids" id="edit-customer-group-ids" value="">
                        <small class="text-secondary">Click to select/deselect multiple groups</small>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Name *</label>
                        <input type="text" name="name" class="form-input" required>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="form-group">
                            <label class="form-label">Email</label>
                            <input type="email" name="email" class="form-input">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Phone</label>
                            <input type="tel" name="phone" class="form-input">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Country *</label>
                        <input type="text" name="country" class="form-input country-autocomplete" placeholder="Start typing country..." list="country-suggestions-edit" autocomplete="off" required>
                        <datalist id="country-suggestions-edit"></datalist>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="form-group">
                            <label class="form-label">Tags</label>
                            <input type="text" name="tags" class="form-input" placeholder="vip, enterprise">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Notes</label>
                            <input type="text" name="notes" class="form-input" placeholder="Additional notes">
                        </div>
                    </div>
                    
                    <!-- Subscriptions Section -->
                    <div class="form-group" style="margin-top: var(--space-4); padding-top: var(--space-4); border-top: 1px solid var(--color-border);">
                        <div class="flex items-center justify-between mb-3">
                            <label class="form-label" style="margin-bottom: 0;">📋 Subscriptions</label>
                            <button type="button" class="btn btn-sm btn-primary" onclick="addSubscriptionForCustomer()">+ Add Subscription</button>
                        </div>
                        <div id="customer-subscriptions-list" class="space-y-2">
                            <p class="text-secondary text-sm">Loading subscriptions...</p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('editCustomerModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update Customer</button>
                </div>
            </form>
        </div>
    </div>


    <!-- Edit Subscription Modal -->
    <div id="editSubscriptionModal" class="modal" style="display: none;">
        <div class="modal-content" style="width: min(800px, 95vw);">
            <div class="modal-header">
                <h2 class="modal-title">Edit Subscription</h2>
                <button class="modal-close" onclick="closeModal('editSubscriptionModal')">×</button>
            </div>
            <form onsubmit="handleFormSubmit(event, updateSubscription)" style="display: flex; flex-direction: column; min-height: 0; flex: 1;">
                <div class="modal-body">
                    <!-- Customer Selection Section -->
                    <div class="form-section" style="background: var(--color-bg-secondary); padding: 1rem; border-radius: var(--radius-lg); margin-bottom: 1rem;">
                        <h4 style="margin: 0 0 0.75rem 0; font-size: 0.875rem; color: var(--color-text-secondary);">👤 Customer Assignment</h4>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="form-group" style="margin-bottom: 0;">
                                <label class="form-label">Category *</label>
                                <select 
                                    name="category_id" 
                                    id="edit-subscription-category" 
                                    class="form-select" 
                                    required 
                                    hx-get="/partials/customer-options" 
                                    hx-trigger="change" 
                                    hx-target="#edit-subscription-customer-select" 
                                    hx-swap="innerHTML"
                                    hx-include="[name='category_id']">
                                    {% for category in categories|default([]) %}
                                    <option value="{{ category.id }}">{{ category.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="form-group" style="margin-bottom: 0;">
                                <label class="form-label">Customer *</label>
                                <select name="customer_id" id="edit-subscription-customer-select" class="form-select" required>
                                    <option value="">Loading customers...</option>
                                </select>
                                <small class="text-secondary">Change customer to reassign this subscription</small>
                            </div>
                        </div>
                    </div>

                    <!-- Vendor & Plan Section -->
                    <div class="form-section" style="background: var(--color-bg-secondary); padding: 1rem; border-radius: var(--radius-lg); margin-bottom: 1rem;">
                        <h4 style="margin: 0 0 0.75rem 0; font-size: 0.875rem; color: var(--color-text-secondary);">📋 Service & Plan Details</h4>
                        <div class="form-group">
                            <label class="form-label">Vendor Name *</label>
                            <input type="text" name="vendor_name" class="form-input" required>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="form-group" style="margin-bottom: 0;">
                                <label class="form-label">Plan Name</label>
                                <input type="text" name="plan_name" class="form-input" placeholder="e.g., Basic, Pro, Enterprise">
                            </div>
                            <div class="form-group" style="margin-bottom: 0;">
                                <label class="form-label">Quick Plan Select</label>
                                <select class="form-select" onchange="applyPlanPreset(this.value)">
                                    <option value="">-- Select a preset --</option>
                                    <option value="basic">Basic Plan</option>
                                    <option value="standard">Standard Plan</option>
                                    <option value="professional">Professional Plan</option>
                                    <option value="enterprise">Enterprise Plan</option>
                                    <option value="custom">Custom Plan</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Pricing Section -->
                    <div class="form-section" style="background: var(--color-bg-secondary); padding: 1rem; border-radius: var(--radius-lg); margin-bottom: 1rem;">
                        <h4 style="margin: 0 0 0.75rem 0; font-size: 0.875rem; color: var(--color-text-secondary);">💰 Pricing & Billing</h4>
                        <div class="grid grid-cols-3 gap-4">
                            <div class="form-group" style="margin-bottom: 0;">
                                <label class="form-label">Cost *</label>
                                <input type="number" step="0.01" name="cost" class="form-input" required>
                            </div>
                            <div class="form-group" style="margin-bottom: 0;">
                                <label class="form-label">Currency</label>
                                <select name="currency" class="form-select">
                                    <option value="USD">USD</option>
                                    <option value="EUR">EUR</option>
                                    <option value="GBP">GBP</option>
                                    <option value="CAD">CAD</option>
                                    <option value="AUD">AUD</option>
                                </select>
                            </div>
                            <div class="form-group" style="margin-bottom: 0;">
                                <label class="form-label">Billing Cycle *</label>
                                <select name="billing_cycle" class="form-select" required onchange="updateRenewalDateFromCycle(this.value)">
                                    <option value="monthly">Monthly</option>
                                    <option value="quarterly">Quarterly</option>
                                    <option value="yearly">Yearly</option>
                                    <option value="weekly">Weekly</option>
                                    <option value="biannual">Biannual</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Dates Section -->
                    <div class="form-section" style="background: var(--color-bg-secondary); padding: 1rem; border-radius: var(--radius-lg); margin-bottom: 1rem;">
                        <h4 style="margin: 0 0 0.75rem 0; font-size: 0.875rem; color: var(--color-text-secondary);">📅 Dates & Renewal</h4>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="form-group" style="margin-bottom: 0;">
                                <label class="form-label">Start Date *</label>
                                <input type="date" name="start_date" class="form-input" required>
                            </div>
                            <div class="form-group" style="margin-bottom: 0;">
                                <label class="form-label">Next Renewal Date *</label>
                                <input type="date" name="next_renewal_date" class="form-input" required>
                                <small class="text-secondary">Auto-calculated when changing billing cycle</small>
                            </div>
                        </div>
                    </div>

                    <!-- Status & Location Section -->
                    <div class="grid grid-cols-2 gap-4">
                        <div class="form-group">
                            <label class="form-label">Status</label>
                            <select name="status" class="form-select">
                                <option value="active">✅ Active</option>
                                <option value="paused">⏸️ Paused</option>
                                <option value="cancelled">❌ Cancelled</option>
                                <option value="expired">⏰ Expired</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Country</label>
                            <input type="text" name="country" class="form-input country-autocomplete" placeholder="Start typing country..." autocomplete="off">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Notes</label>
                        <textarea name="notes" class="form-textarea" placeholder="Additional notes about this subscription..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('editSubscriptionModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update Subscription</button>
                </div>
            </form>
        </div>
    </div>


    <!-- Add Existing Customer Modal -->
    <div id="addExistingCustomerModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2 class="modal-title">Add Existing Customer to Category</h2>
                <button class="modal-close" onclick="closeModal('addExistingCustomerModal')">×</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="existing-customer-category-id" value="">
                <div class="form-group">
                    <label class="form-label">Select Customer *</label>
                    <select id="existing-customer-select" class="form-select" required>
                        <option value="">Loading customers...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Group (Optional)</label>
                    <select id="existing-customer-group-select" class="form-select">
                        <option value="">No group</option>
                    </select>
                </div>
                <div class="info-box info-box-info">
                    <strong>ℹ️ Note:</strong> This will update the customer's category assignment.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('addExistingCustomerModal')">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="assignExistingCustomerToCategory()">Add to Category</button>
            </div>
        </div>
    </div>

    <script src="/static/js/app.js"></script>
    
    <script>
    // Helper functions for modals
    function openShortcutsModal() {
        openModal('shortcutsModal');
    }
    
    function openAboutModal() {
        openModal('aboutModal');
    }
    
    // Add existing customer to category
    function openAddExistingCustomerModal(categoryId) {
        document.getElementById('existing-customer-category-id').value = categoryId;
        
        // Load all customers
        fetch('/api/customers')
            .then(response => response.json())
            .then(customers => {
                const select = document.getElementById('existing-customer-select');
                select.innerHTML = '<option value="">Select a customer</option>';
                
                if (customers.length === 0) {
                    select.innerHTML = '<option value="" disabled>No customers available</option>';
                } else {
                    customers.forEach(customer => {
                        const categoryInfo = customer.category_names || 'No category';
                        const option = document.createElement('option');
                        option.value = customer.id;
                        option.textContent = `${customer.name} (${categoryInfo})`;
                        select.appendChild(option);
                    });
                }
            })
            .catch(error => {
                console.error('Error loading customers:', error);
                document.getElementById('existing-customer-select').innerHTML = '<option value="">Error loading customers</option>';
            });
        
        // Load groups for this category
        fetch(`/api/groups?category_id=${categoryId}`)
            .then(response => response.json())
            .then(groups => {
                const select = document.getElementById('existing-customer-group-select');
                select.innerHTML = '<option value="">No group</option>';
                groups.forEach(group => {
                    const option = document.createElement('option');
                    option.value = group.id;
                    option.textContent = group.name;
                    select.appendChild(option);
                });
            })
            .catch(error => console.error('Error loading groups:', error));
        
        openModal('addExistingCustomerModal');
    }
    
    function assignExistingCustomerToCategory() {
        const customerId = document.getElementById('existing-customer-select').value;
        const categoryId = document.getElementById('existing-customer-category-id').value;
        const groupId = document.getElementById('existing-customer-group-select').value;
        
        if (!customerId) {
            showToast('Please select a customer', 'error');
            return;
        }
        
        const data = {
            category_id: parseInt(categoryId)
        };
        
        if (groupId) {
            data.group_id = parseInt(groupId);
        }
        
        fetch(`/api/customers/${customerId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        })
        .then(response => {
            if (response.ok) {
                showToast('Customer added to category successfully', 'success');
                closeModal('addExistingCustomerModal');
                setTimeout(() => window.location.reload(), 500);
            } else {
                return response.json().then(err => {
                    throw new Error(err.detail || 'Failed to add customer');
                });
            }
        })
        .catch(error => {
            showToast(error.message, 'error');
        });
    }
    </script>
    
    {% block extra_scripts %}{% endblock %}
    
    <!-- Floating Action Button (FAB) for Quick Add -->
    <div id="fab-container" class="fab-container">
        <button id="fab-main" class="fab-main" onclick="toggleFabMenu()" aria-label="Quick Add Menu">
            <span class="fab-icon">+</span>
        </button>
        <div id="fab-menu" class="fab-menu">
            <button class="fab-action" onclick="closeFabMenu(); openModal('customerModal');" data-tooltip="Add Customer">
                <span class="fab-action-icon">👤</span>
                <span class="fab-action-label">Customer</span>
            </button>
            <button class="fab-action" onclick="closeFabMenu(); openModal('subscriptionModal');" data-tooltip="Add Subscription">
                <span class="fab-action-icon">📋</span>
                <span class="fab-action-label">Subscription</span>
            </button>
            <button class="fab-action" onclick="closeFabMenu(); openModal('categoryModal');" data-tooltip="Add Category">
                <span class="fab-action-icon">📁</span>
                <span class="fab-action-label">Category</span>
            </button>
            <button class="fab-action" onclick="closeFabMenu(); openModal('groupModal');" data-tooltip="Add Group">
                <span class="fab-action-icon">👥</span>
                <span class="fab-action-label">Group</span>
            </button>
        </div>
    </div>
    
    <style>
    /* Floating Action Button Styles */
    .fab-container {
        position: fixed;
        bottom: 24px;
        right: 24px;
        z-index: 1000;
        display: flex;
        flex-direction: column-reverse;
        align-items: center;
        gap: 12px;
    }
    
    /* Safe area for mobile devices */
    @supports (padding-bottom: env(safe-area-inset-bottom)) {
        .fab-container {
            bottom: calc(24px + env(safe-area-inset-bottom));
            right: calc(24px + env(safe-area-inset-right));
        }
    }
    
    .fab-main {
        width: 56px;
        height: 56px;
        border-radius: 50%;
        background: linear-gradient(135deg, var(--color-primary, #667eea) 0%, var(--color-primary-dark, #764ba2) 100%);
        border: none;
        color: white;
        font-size: 28px;
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4), 0 2px 4px rgba(0, 0, 0, 0.1);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        display: flex;
        align-items: center;
        justify-content: center;
        outline: none;
    }
    
    .fab-main:hover {
        transform: scale(1.1);
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5), 0 4px 8px rgba(0, 0, 0, 0.15);
    }
    
    .fab-main:active {
        transform: scale(0.95);
    }
    
    .fab-main.open {
        transform: rotate(45deg);
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    }
    
    .fab-main.open:hover {
        transform: rotate(45deg) scale(1.1);
    }
    
    .fab-icon {
        line-height: 1;
        transition: transform 0.3s ease;
    }
    
    .fab-menu {
        display: flex;
        flex-direction: column-reverse;
        gap: 10px;
        opacity: 0;
        visibility: hidden;
        transform: translateY(20px) scale(0.8);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        pointer-events: none;
    }
    
    .fab-menu.open {
        opacity: 1;
        visibility: visible;
        transform: translateY(0) scale(1);
        pointer-events: auto;
    }
    
    .fab-action {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 16px;
        background: var(--color-bg-card, white);
        border: 1px solid var(--color-border, #e2e8f0);
        border-radius: 24px;
        cursor: pointer;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        transition: all 0.2s ease;
        white-space: nowrap;
        font-size: 14px;
        color: var(--color-text, #1e293b);
    }
    
    .fab-action:hover {
        transform: translateX(-4px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        background: var(--color-bg-hover, #f8fafc);
    }
    
    .fab-action:active {
        transform: scale(0.95);
    }
    
    .fab-action-icon {
        font-size: 18px;
    }
    
    .fab-action-label {
        font-weight: 500;
    }
    
    /* Animation for menu items appearing */
    .fab-menu.open .fab-action {
        animation: fabItemAppear 0.3s ease forwards;
    }
    
    .fab-menu.open .fab-action:nth-child(1) { animation-delay: 0ms; }
    .fab-menu.open .fab-action:nth-child(2) { animation-delay: 50ms; }
    .fab-menu.open .fab-action:nth-child(3) { animation-delay: 100ms; }
    .fab-menu.open .fab-action:nth-child(4) { animation-delay: 150ms; }
    
    @keyframes fabItemAppear {
        from {
            opacity: 0;
            transform: translateY(10px) scale(0.8);
        }
        to {
            opacity: 1;
            transform: translateY(0) scale(1);
        }
    }
    
    /* Backdrop when menu is open */
    .fab-backdrop {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.3);
        z-index: 999;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
    }
    
    .fab-backdrop.open {
        opacity: 1;
        visibility: visible;
    }
    
    /* Mobile adjustments */
    @media (max-width: 640px) {
        .fab-container {
            bottom: 16px;
            right: 16px;
        }
        
        .fab-main {
            width: 52px;
            height: 52px;
            font-size: 24px;
        }
        
        .fab-action {
            padding: 8px 14px;
            font-size: 13px;
        }
        
        .fab-action-icon {
            font-size: 16px;
        }
    }
    
    /* Hide FAB on login/auth pages */
    body.auth-page .fab-container {
        display: none;
    }
    </style>
    
    <script>
    // FAB Menu Toggle Functions
    let fabBackdrop = null;
    
    function toggleFabMenu() {
        const fabMain = document.getElementById('fab-main');
        const fabMenu = document.getElementById('fab-menu');
        
        if (fabMenu.classList.contains('open')) {
            closeFabMenu();
        } else {
            openFabMenu();
        }
    }
    
    function openFabMenu() {
        const fabMain = document.getElementById('fab-main');
        const fabMenu = document.getElementById('fab-menu');
        
        fabMain.classList.add('open');
        fabMenu.classList.add('open');
        
        // Create backdrop
        if (!fabBackdrop) {
            fabBackdrop = document.createElement('div');
            fabBackdrop.className = 'fab-backdrop';
            fabBackdrop.onclick = closeFabMenu;
            document.body.appendChild(fabBackdrop);
        }
        fabBackdrop.classList.add('open');
    }
    
    function closeFabMenu() {
        const fabMain = document.getElementById('fab-main');
        const fabMenu = document.getElementById('fab-menu');
        
        fabMain.classList.remove('open');
        fabMenu.classList.remove('open');
        
        if (fabBackdrop) {
            fabBackdrop.classList.remove('open');
        }
    }
    
    // Close FAB menu on escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closeFabMenu();
        }
    });
    
    // Close FAB when a modal opens
    const originalOpenModal = window.openModal;
    window.openModal = function(modalId) {
        closeFabMenu();
        return originalOpenModal(modalId);
    };
    </script>
</body>
</html>
