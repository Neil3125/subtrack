<!DOCTYPE html>
<html lang="en" data-theme="light">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}SubTrack Web{% endblock %}</title>

    <!-- Prevent FOUC (Flash of Unstyled Content) and dark mode flash -->
    <script>
        // Load theme IMMEDIATELY before any rendering
        (function () {
            const savedTheme = localStorage.getItem('theme') || 'light';
            const savedVisualTheme = localStorage.getItem('visual-theme') || 'default';
            document.documentElement.setAttribute('data-theme', savedVisualTheme !== 'default' ? savedVisualTheme : savedTheme);
        })();
    </script>

    <!-- Preload critical resources -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
        as="style">
    <link rel="preload" href="/static/css/style.css" as="style">

    <!-- Critical CSS inline for instant load -->
    <style>
        /* Prevent flash */
        html {
            background: var(--color-bg, #ffffff);
        }

        [data-theme="dark"] {
            background: var(--color-bg, #0d0d0d);
        }

        body {
            margin: 0;
        }
    </style>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/style.css">
    <link rel="stylesheet" href="/static/css/enhancements.css">
    <link rel="stylesheet" href="/static/css/themes.css">
    <link rel="stylesheet" href="/static/css/animations.css">
    <script src="https://unpkg.com/htmx.org@1.9.10" defer></script>
    {% block extra_head %}{% endblock %}
</head>

<body>
    <!-- Floating Particles Background -->
    <div class="particles">
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
    </div>

    <!-- Morphing Background Blobs -->
    <div class="blob blob-1"></div>
    <div class="blob blob-2"></div>
    <div class="blob blob-3"></div>
    <div class="blob blob-4"></div>

    <!-- Navbar -->
    <nav class="navbar">
        <a href="/" class="navbar-brand">
            <span>üìä</span> SubTrack
        </a>

        <div class="navbar-search">
            <div class="search-wrapper">
                <!-- Hidden fields to trap browser autofill -->
                <input type="text" name="trap_username"
                    style="display:none !important; position:absolute; left:-9999px;" tabindex="-1"
                    autocomplete="username">
                <input type="password" name="trap_password"
                    style="display:none !important; position:absolute; left:-9999px;" tabindex="-1"
                    autocomplete="current-password">
                <input type="text" class="search-input" id="global-search-input"
                    placeholder="Search subscriptions, customers, vendors..." hx-get="/search"
                    hx-trigger="keyup changed delay:300ms" hx-target="#search-results" hx-swap="innerHTML"
                    name="search_query_field" autocomplete="off" autocorrect="off" autocapitalize="off"
                    spellcheck="false" data-form-type="other" data-lpignore="true" data-1p-ignore="true"
                    aria-label="Search" role="searchbox" readonly onfocus="this.removeAttribute('readonly');">
                <span class="search-icon">üîç</span>
            </div>
            <div id="search-results" class="search-results"></div>
        </div>

        <div class="navbar-actions">
            <button class="btn btn-secondary btn-sm" onclick="toggleTheme()">
                <span id="theme-icon">üåô</span>
            </button>
            <div class="dropdown">
                <button class="btn btn-secondary btn-sm" data-tooltip-bottom="Visual Themes">
                    üé®
                </button>
                <div class="dropdown-menu">
                    <button onclick="setVisualTheme('default')" class="dropdown-item">
                        <span>üåä</span> Ocean (Default)
                    </button>
                    <button onclick="setVisualTheme('sunset')" class="dropdown-item">
                        <span>üåÖ</span> Sunset
                    </button>
                    <button onclick="setVisualTheme('midnight')" class="dropdown-item">
                        <span>üåô</span> Midnight
                    </button>
                    <button onclick="setVisualTheme('forest')" class="dropdown-item">
                        <span>üå≤</span> Forest
                    </button>
                    <button onclick="setVisualTheme('candy')" class="dropdown-item">
                        <span>üç≠</span> Candy
                    </button>
                    <button onclick="setVisualTheme('aurora')" class="dropdown-item">
                        <span>‚ú®</span> Aurora
                    </button>
                </div>
            </div>
            <div class="dropdown">
                <button class="btn btn-secondary btn-sm" data-tooltip-bottom="Settings & More">
                    ‚öôÔ∏è
                </button>
                <div class="dropdown-menu">
                    <a href="/settings" class="dropdown-item">
                        <span>‚öôÔ∏è</span> Settings
                    </a>

                    <a href="/reports" class="dropdown-item">
                        <span>üì§</span> Reports & Exports
                    </a>
                    <button onclick="openShortcutsModal()" class="dropdown-item">
                        <span>‚å®Ô∏è</span> Keyboard Shortcuts
                    </button>
                    <button onclick="openAboutModal()" class="dropdown-item">
                        <span>‚ÑπÔ∏è</span> About
                    </button>
                    <button onclick="window.location.reload()" class="dropdown-item">
                        <span>üîÑ</span> Refresh Page
                    </button>
                    <div class="dropdown-divider"></div>
                    <a href="/docs" target="_blank" class="dropdown-item">
                        <span>üìö</span> API Docs
                    </a>
                    <div class="dropdown-divider"></div>
                    <a href="/logout" class="dropdown-item" style="color: var(--color-danger);">
                        <span>üö™</span> Logout
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-section mb-6">
                <h3 class="sidebar-title">Applications</h3>
                <ul class="sidebar-nav">
                    <li class="sidebar-nav-item">
                        <a href="/log-check"
                            class="sidebar-nav-link {% if '/log-check' in request.path %}active{% endif %}">
                            ‚úÖ Log Check
                        </a>
                    </li>
                </ul>
            </div>

            <div class="sidebar-section">
                <h3 class="sidebar-title">Navigation</h3>
                <ul class="sidebar-nav">
                    <li class="sidebar-nav-item">
                        <a href="/" class="sidebar-nav-link {% if request.path == '/' %}active{% endif %}">
                            üìä Dashboard
                        </a>
                    </li>
                    <li class="sidebar-nav-item">
                        <a href="/categories"
                            class="sidebar-nav-link {% if '/categories' in request.path and '/customers' not in request.path %}active{% endif %}">
                            üìÅ Categories
                        </a>
                    </li>
                    <li class="sidebar-nav-item">
                        <a href="/customers"
                            class="sidebar-nav-link {% if request.path == '/customers' %}active{% endif %}">
                            üë• Customers
                        </a>
                    </li>
                    <li class="sidebar-nav-item">
                        <a href="/subscriptions"
                            class="sidebar-nav-link {% if request.path == '/subscriptions' %}active{% endif %}">
                            üìã Subscriptions
                        </a>
                    </li>
                    <li class="sidebar-nav-item">
                        <a href="/analytics"
                            class="sidebar-nav-link {% if '/analytics' in request.path %}active{% endif %}">
                            üìà Analytics
                        </a>
                    </li>
                    <li class="sidebar-nav-item">
                        <a href="/reports"
                            class="sidebar-nav-link {% if '/reports' in request.path %}active{% endif %}">
                            üìÑ Reports
                        </a>
                    </li>
                    <li class="sidebar-nav-item">
                        <a href="/links" class="sidebar-nav-link {% if '/links' in request.path %}active{% endif %}">
                            üîó Links
                        </a>
                    </li>
                    <li class="sidebar-nav-item">
                        <a href="/settings"
                            class="sidebar-nav-link {% if '/settings' in request.path %}active{% endif %}">
                            ‚öôÔ∏è Settings
                        </a>
                    </li>

                    <li class="sidebar-nav-item">
                        <a href="/users" class="sidebar-nav-link {% if '/users' in request.path %}active{% endif %}">
                            üë• Users
                        </a>
                    </li>
                    <li class="sidebar-nav-item">
                        <a href="/activity"
                            class="sidebar-nav-link {% if '/activity' in request.path %}active{% endif %}">
                            üìã Activity Log
                        </a>
                    </li>
                </ul>
            </div>

            <div class="sidebar-section">
                <h3 class="sidebar-title">Categories</h3>
                <ul class="sidebar-nav" id="categories-list">
                    {% for category in categories|default([]) %}
                    <li class="sidebar-nav-item">
                        <a href="/categories/{{ category.id }}" class="sidebar-nav-link">
                            {{ category.name }}
                        </a>
                    </li>
                    {% endfor %}
                    {% if not categories %}
                    <li class="sidebar-nav-item">
                        <span class="sidebar-nav-link text-secondary">No categories yet</span>
                    </li>
                    {% endif %}
                </ul>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            {% block content %}{% endblock %}
        </main>
    </div>

    <!-- About Modal -->
    <div id="aboutModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">‚ÑπÔ∏è About SubTrack</h2>
                <button class="modal-close" onclick="closeModal('aboutModal')">√ó</button>
            </div>
            <div class="modal-body">
                <p class="text-secondary">
                    SubTrack helps you track subscriptions, renewals, and costs across categories and customers.
                </p>
                <div class="list-group">
                    <div class="list-group-item"><strong>Quick Add</strong> ‚Äî Use the + button to create items fast
                    </div>
                    <div class="list-group-item"><strong>Search</strong> ‚Äî Search vendors/customers from the top bar
                    </div>
                    <div class="list-group-item"><strong>Reports</strong> ‚Äî Export your data anytime</div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" onclick="closeModal('aboutModal')">Close</button>
            </div>
        </div>
    </div>

    <!-- Keyboard Shortcuts Modal -->
    <div id="shortcutsModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">‚å®Ô∏è Keyboard Shortcuts</h2>
                <button class="modal-close" onclick="closeModal('shortcutsModal')">√ó</button>
            </div>
            <div class="modal-body">
                <div class="list-group">
                    <div class="list-group-item"><strong>/</strong> ‚Äî Focus global search</div>
                    <div class="list-group-item"><strong>N</strong> ‚Äî Quick add</div>
                    <div class="list-group-item"><strong>Ctrl/Cmd + K</strong> ‚Äî Command palette</div>
                    <div class="list-group-item"><strong>B</strong> ‚Äî Toggle sidebar collapse</div>
                    <div class="list-group-item"><strong>Esc</strong> ‚Äî Close open windows</div>
                </div>
                <p class="text-secondary" style="margin-top: var(--space-4); margin-bottom: 0;">
                    Tip: Use the command palette to navigate and create items quickly.
                </p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" onclick="closeModal('shortcutsModal')">Done</button>
            </div>
        </div>
    </div>

    <!-- Quick Add Modal -->
    <div id="quickAddModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Quick Add</h2>
                <button class="modal-close" onclick="closeModal('quickAddModal')">√ó</button>
            </div>
            <div class="modal-body">
                <div class="grid grid-cols-2 gap-4">
                    <div class="card card-hover quick-add-card"
                        onclick="closeModal('quickAddModal'); openModal('categoryModal');"
                        style="cursor: pointer; text-align: center; padding: var(--space-6);">
                        <div class="quick-add-icon">üìÅ</div>
                        <div class="quick-add-label">Category</div>
                        <div class="quick-add-desc">Organize subscriptions</div>
                    </div>
                    <div class="card card-hover quick-add-card"
                        onclick="closeModal('quickAddModal'); openModal('groupModal');"
                        style="cursor: pointer; text-align: center; padding: var(--space-6);">
                        <div class="quick-add-icon">üì¶</div>
                        <div class="quick-add-label">Group</div>
                        <div class="quick-add-desc">Group customers</div>
                    </div>
                    <div class="card card-hover quick-add-card"
                        onclick="closeModal('quickAddModal'); openModal('customerModal');"
                        style="cursor: pointer; text-align: center; padding: var(--space-6);">
                        <div class="quick-add-icon">üë§</div>
                        <div class="quick-add-label">Customer</div>
                        <div class="quick-add-desc">Add new customer</div>
                    </div>
                    <div class="card card-hover quick-add-card"
                        onclick="closeModal('quickAddModal'); openModal('subscriptionModal');"
                        style="cursor: pointer; text-align: center; padding: var(--space-6);">
                        <div class="quick-add-icon">üìã</div>
                        <div class="quick-add-label">Subscription</div>
                        <div class="quick-add-desc">Track subscription</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Category Modal - ENHANCED UI -->
    <div id="categoryModal" class="modal category-modal-improved" style="display: none;">
        <div class="modal-content modal-content-improved" style="max-width: 500px;">
            <div class="modal-header modal-header-improved">
                <h2 class="modal-title modal-title-improved">Create Category</h2>
                <p class="modal-subtitle modal-subtitle-improved">Categories help organize your subscriptions</p>
                <button class="modal-close modal-close-improved" onclick="closeModal('categoryModal')">√ó</button>
            </div>
            <form onsubmit="handleFormSubmit(event, saveEnhancedCategory)">
                <div class="modal-body modal-body-improved">
                    <!-- Section: Details -->
                    <div class="form-section"
                        style="background: var(--color-bg-secondary); padding: 16px; border-radius: 12px; border: 1px solid var(--color-border);">
                        <div class="form-group">
                            <label class="form-label">Name *</label>
                            <input type="text" name="name" class="form-input" required
                                placeholder="e.g., Cloud Services">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Description</label>
                            <textarea name="description" class="form-textarea"
                                placeholder="Brief description of this category"></textarea>
                        </div>
                    </div>
                </div>
                <div class="modal-footer modal-footer-improved">
                    <button type="button" class="btn btn-secondary"
                        onclick="closeModal('categoryModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Category</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Group Modal - ENHANCED UI -->
    <div id="groupModal" class="modal group-modal-improved" style="display: none;">
        <div class="modal-content modal-content-improved" style="max-width: 500px;">
            <div class="modal-header modal-header-improved">
                <h2 class="modal-title modal-title-improved">Create Group</h2>
                <p class="modal-subtitle modal-subtitle-improved">Organize items within a category</p>
                <button class="modal-close modal-close-improved" onclick="closeModal('groupModal')">√ó</button>
            </div>
            <form onsubmit="handleFormSubmit(event, saveEnhancedGroup)">
                <div class="modal-body modal-body-improved">
                    <!-- Section: Group Info -->
                    <div class="form-section"
                        style="background: var(--color-bg-secondary); padding: 16px; border-radius: 12px; border: 1px solid var(--color-border);">
                        <div class="form-group">
                            <label class="form-label">Category *</label>
                            <select name="category_id" class="form-select" required>
                                <option value="">Select a category</option>
                                {% for category in categories|default([]) %}
                                <option value="{{ category.id }}">{{ category.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Name *</label>
                            <input type="text" name="name" class="form-input" required placeholder="Group Name">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Notes</label>
                            <textarea name="notes" class="form-textarea" placeholder="Description/Notes"></textarea>
                        </div>
                    </div>
                </div>
                <div class="modal-footer modal-footer-improved">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('groupModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Group</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Customer Modal - IMPROVED UI (Matches Subscription Modal) -->
    <div id="customerModal" class="modal customer-modal-improved" style="display: none;">
        <div class="modal-content modal-content-improved"
            style="max-width: 720px; max-height: 90vh; display: flex; flex-direction: column;">
            <div class="modal-header modal-header-improved">
                <h2 class="modal-title modal-title-improved">Create Customer</h2>
                <p class="modal-subtitle modal-subtitle-improved">Customers are organized by category and group</p>
                <button class="modal-close modal-close-improved" onclick="closeModal('customerModal')">√ó</button>
            </div>
            <form onsubmit="handleFormSubmit(event, saveEnhancedCustomer)" id="customer-form">
                <div class="modal-body modal-body-improved"
                    style="overflow-y: auto; flex: 1; max-height: calc(90vh - 140px);">

                    <!-- PRIMARY SELECTION ROW: Categories & Groups -->
                    <div class="primary-selection-row">
                        <!-- CATEGORIES SELECTOR (FIRST) -->
                        <div class="selection-card selection-card-categories animated-border-card">
                            <div class="animated-border"></div>
                            <div class="selection-card-inner">
                                <div class="selection-card-header">
                                    <span class="selection-card-icon">üè∑Ô∏è</span>
                                    <h3 class="selection-card-title">Categories *</h3>
                                </div>
                                <div class="selection-card-content">
                                    <input type="hidden" name="category_ids" id="customer-category-ids" value="">

                                    <div class="categories-chips-container" id="customer-categories-wrapper">
                                        <!-- Selected Categories Display -->
                                        <div class="categories-chips-display" id="customer-categories-tags"
                                            onclick="openCustomerCategorySelector()">
                                            <span class="categories-placeholder">Click to select...</span>
                                        </div>

                                        <!-- Dropdown Panel -->
                                        <div class="categories-dropdown" id="customer-categories-dropdown"
                                            style="display: none;">
                                            <div class="categories-dropdown-header">
                                                <span>Select categories</span>
                                                <button type="button" class="categories-close"
                                                    onclick="closeCustomerCategorySelector()">‚úï</button>
                                            </div>
                                            <div class="categories-dropdown-list">
                                                {% for category in categories|default([]) %}
                                                <div class="categories-dropdown-item tags-dropdown-item"
                                                    data-id="{{ category.id }}" data-name="{{ category.name }}"
                                                    onclick="toggleCustomerCategoryTag(this)">
                                                    <span class="categories-item-checkbox"></span>
                                                    <span class="categories-item-label">{{ category.name }}</span>
                                                </div>
                                                {% endfor %}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- GROUPS SELECTOR (SECOND) -->
                        <div class="selection-card selection-card-groups animated-border-card">
                            <div class="animated-border"></div>
                            <div class="selection-card-inner">
                                <div class="selection-card-header">
                                    <span class="selection-card-icon">üìÅ</span>
                                    <h3 class="selection-card-title">Groups</h3>
                                </div>
                                <div class="selection-card-content">
                                    <input type="hidden" name="group_ids" id="customer-group-ids" value="">

                                    <div class="categories-chips-container" id="customer-groups-wrapper">
                                        <!-- Selected Groups Display -->
                                        <div class="categories-chips-display" id="customer-groups-tags"
                                            onclick="openCustomerGroupSelector()">
                                            <span class="categories-placeholder">Click to select...</span>
                                        </div>

                                        <!-- Dropdown Panel -->
                                        <div class="categories-dropdown" id="customer-groups-dropdown"
                                            style="display: none;">
                                            <div class="categories-dropdown-header">
                                                <span>Select groups</span>
                                                <button type="button" class="categories-close"
                                                    onclick="closeCustomerGroupSelector()">‚úï</button>
                                            </div>
                                            <div class="categories-dropdown-list">
                                                {% for group in groups|default([]) %}
                                                <div class="categories-dropdown-item tags-dropdown-item"
                                                    data-id="{{ group.id }}" data-name="{{ group.name }}"
                                                    onclick="toggleCustomerGroupTag(this)">
                                                    <span class="categories-item-checkbox"></span>
                                                    <span class="categories-item-label">{{ group.name }}</span>
                                                </div>
                                                {% endfor %}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- SECTION 2: CUSTOMER DETAILS -->
                    <div class="modal-section">
                        <div class="section-header">
                            <h3 class="section-title">Customer Details</h3>
                        </div>
                        <div class="section-content">
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Name *</label>
                                    <input type="text" name="name" class="form-input" required
                                        placeholder="Customer Name">
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Email</label>
                                    <input type="email" name="email" class="form-input" placeholder="email@example.com">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Phone</label>
                                    <input type="tel" name="phone" class="form-input" placeholder="+1-555-0000">
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Country *</label>
                                    <input type="text" name="country" class="form-input country-autocomplete" required
                                        placeholder="Residency" list="customer-country-suggestions" autocomplete="off">
                                    <datalist id="customer-country-suggestions"></datalist>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Tags</label>
                                    <input type="text" name="tags" class="form-input" placeholder="vip, enterprise...">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- SECTION 3: NOTES -->
                    <div class="modal-section">
                        <div class="section-header">
                            <h3 class="section-title">Additional Notes</h3>
                        </div>
                        <div class="section-content">
                            <div class="form-group">
                                <textarea name="notes" class="form-textarea" style="min-height: 80px;"
                                    placeholder="Additional notes about this customer..."></textarea>
                            </div>
                        </div>
                    </div>

                </div>
                <!-- Footer -->
                <div class="modal-footer modal-footer-improved">
                    <button type="button" class="btn btn-secondary"
                        onclick="closeModal('customerModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Customer</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Subscription Modal - IMPROVED UI -->
    <div id="subscriptionModal" class="modal subscription-modal-improved" style="display: none;">
        <div class="modal-content modal-content-improved"
            style="max-width: 720px; max-height: 90vh; display: flex; flex-direction: column;">
            <div class="modal-header modal-header-improved">
                <h2 class="modal-title modal-title-improved">Create Subscription</h2>
                <p class="modal-subtitle modal-subtitle-improved">Subscriptions are organized by category</p>
                <button class="modal-close modal-close-improved" onclick="closeModal('subscriptionModal')">√ó</button>
            </div>
            <form onsubmit="handleFormSubmit(event, saveEnhancedSubscription)" id="subscription-form">
                <div class="modal-body modal-body-improved"
                    style="overflow-y: auto; flex: 1; max-height: calc(90vh - 140px);">

                    <!-- PRIMARY SELECTION ROW: Customer & Categories -->
                    <div class="primary-selection-row">
                        <!-- CUSTOMER SELECTOR (FIRST) -->
                        <div class="selection-card selection-card-customer animated-border-card">
                            <div class="animated-border"></div>
                            <div class="selection-card-inner">
                                <div class="selection-card-header">
                                    <span class="selection-card-icon">üë§</span>
                                    <h3 class="selection-card-title">Customer</h3>
                                </div>
                                <div class="selection-card-content">
                                    <input type="hidden" name="customer_id" id="subscription-customer-id" required>

                                    <!-- Customer Display/Selector -->
                                    <div class="customer-selector-wrapper" id="customer-selector-wrapper">
                                        <div class="customer-selected-display" id="customer-selected-display"
                                            onclick="toggleCustomerDropdown()">
                                            <span class="customer-selected-name" id="selected-customer-name">Select
                                                customer...</span>
                                            <span class="customer-selected-arrow">‚ñº</span>
                                        </div>

                                        <!-- Customer Dropdown -->
                                        <div class="customer-dropdown-panel" id="customer-dropdown-panel"
                                            style="display: none;">
                                            <div class="dropdown-search-box">
                                                <input type="text" class="dropdown-search-input"
                                                    placeholder="Search customers..." id="subscription-customer-search"
                                                    oninput="filterEnhancedDropdown('subscription-customer', this.value)">
                                            </div>

                                            <div class="dropdown-loading" id="subscription-customer-loading">
                                                <div class="loading-spinner"></div>
                                                <span>Loading...</span>
                                            </div>

                                            <div class="dropdown-list" id="subscription-customer-list"
                                                style="display: none;">
                                                <!-- Populated by JS -->
                                            </div>

                                            <div class="dropdown-empty" id="subscription-customer-empty"
                                                style="display: none;">
                                                <span>No customers found</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- CATEGORIES SELECTOR (SECOND) -->
                        <div class="selection-card selection-card-categories animated-border-card">
                            <div class="animated-border"></div>
                            <div class="selection-card-inner">
                                <div class="selection-card-header">
                                    <span class="selection-card-icon">üè∑Ô∏è</span>
                                    <h3 class="selection-card-title">Categories</h3>
                                </div>
                                <div class="selection-card-content">
                                    <input type="hidden" name="category_ids" id="subscription-category-ids" value="">
                                    <input type="hidden" name="category_id" id="subscription-category-id" value="">

                                    <div class="categories-chips-container" id="subscription-categories-wrapper">
                                        <!-- Selected Categories Display -->
                                        <div class="categories-chips-display" id="subscription-categories-tags"
                                            onclick="openCategorySelector()">
                                            <span class="categories-placeholder">Click to select...</span>
                                        </div>

                                        <!-- Dropdown Panel -->
                                        <div class="categories-dropdown" id="subscription-categories-dropdown"
                                            style="display: none;">
                                            <div class="categories-dropdown-header">
                                                <span>Select categories</span>
                                                <button type="button" class="categories-close"
                                                    onclick="closeCategorySelector()">‚úï</button>
                                            </div>
                                            <div class="categories-dropdown-list">
                                                {% for category in categories|default([]) %}
                                                <div class="categories-dropdown-item tags-dropdown-item"
                                                    data-id="{{ category.id }}" data-name="{{ category.name }}"
                                                    onclick="toggleCategoryTag(this)">
                                                    <span class="categories-item-checkbox"></span>
                                                    <span class="categories-item-label">{{ category.name }}</span>
                                                </div>
                                                {% endfor %}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- SECTION 2: VENDOR & SUBSCRIPTION DETAILS -->
                    <div class="modal-section">
                        <div class="section-header">
                            <h3 class="section-title">Vendor & Details</h3>
                        </div>
                        <div class="section-content">
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Vendor Name</label>
                                    <input type="text" name="vendor_name" id="subscription-vendor-name"
                                        class="form-input" required placeholder="AWS / Adobe / Netflix"
                                        autocomplete="off">
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Plan / Tier</label>
                                    <input type="text" name="plan_name" class="form-input"
                                        placeholder="Professional, Premium">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Billing Cycle</label>
                                    <select name="billing_cycle" class="form-select" required>
                                        <option value="monthly">Monthly</option>
                                        <option value="quarterly">Quarterly</option>
                                        <option value="yearly">Yearly</option>
                                        <option value="weekly">Weekly</option>
                                        <option value="biannual">Biannual</option>
                                    </select>
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Cost</label>
                                    <div class="input-with-prefix">
                                        <span class="input-prefix">$</span>
                                        <input type="number" step="0.01" name="cost" class="form-input" required
                                            placeholder="99.99">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Currency</label>
                                    <select name="currency" class="form-select">
                                        <option value="USD">USD - US Dollar</option>
                                        <option value="EUR">EUR - Euro</option>
                                        <option value="GBP">GBP - British Pound</option>
                                        <option value="CAD">CAD - Canadian Dollar</option>
                                        <option value="AUD">AUD - Australian Dollar</option>
                                        <option value="BBD">BBD - Barbadian Dollar</option>
                                        <option value="JMD">JMD - Jamaican Dollar</option>
                                        <option value="TTD">TTD - Trinidad Dollar</option>
                                        <option value="XCD">XCD - East Caribbean Dollar</option>
                                        <option value="BRL">BRL - Brazilian Real</option>
                                        <option value="MXN">MXN - Mexican Peso</option>
                                        <option value="JPY">JPY - Japanese Yen</option>
                                        <option value="INR">INR - Indian Rupee</option>
                                        <option value="CHF">CHF - Swiss Franc</option>
                                        <option value="NZD">NZD - New Zealand Dollar</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- SECTION 3: SMART SUGGESTIONS (COLLAPSIBLE) -->
                    <div class="modal-section modal-section-collapsible">
                        <div class="collapsible-header" onclick="toggleSmartSuggestions()">
                            <div class="collapsible-title">
                                <span class="collapsible-icon">‚ú®</span>
                                <span class="collapsible-text">Smart suggestions</span>
                                <span class="collapsible-subtitle">(based on this customer)</span>
                            </div>
                            <button type="button" class="collapsible-toggle" id="smart-suggestions-toggle">
                                <span class="toggle-icon">‚ñº</span>
                            </button>
                        </div>
                        <div class="collapsible-content" id="smart-suggestions-content" style="display: none;">
                            <div id="suggestions-content" class="suggestions-content">
                                <!-- Populated by JS -->
                            </div>
                        </div>
                    </div>

                    <!-- SECTION 5: ADDITIONAL DETAILS -->
                    <div class="modal-section">
                        <div class="section-header">
                            <h3 class="section-title">Additional Details</h3>
                        </div>
                        <div class="section-content">
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Start Date</label>
                                    <input type="date" name="start_date" class="form-input" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Next Renewal</label>
                                    <input type="date" name="next_renewal_date" class="form-input" required>
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Status</label>
                                    <select name="status" class="form-select">
                                        <option value="active">Active</option>
                                        <option value="paused">Paused</option>
                                        <option value="cancelled">Cancelled</option>
                                        <option value="expired">Expired</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Country</label>
                                    <input type="text" name="country" class="form-input" placeholder="Country..."
                                        autocomplete="off">
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Notes</label>
                                    <textarea name="notes" class="form-textarea" rows="3"
                                        placeholder="Additional notes..."></textarea>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>

                <!-- Clean Footer -->
                <div class="modal-footer modal-footer-improved">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('subscriptionModal')">
                        Cancel
                    </button>
                    <button type="submit" class="btn btn-primary" id="subscription-submit-btn">
                        Create Subscription
                    </button>
                </div>
            </form>
        </div>
    </div>





    <!-- Add Existing Customer Modal -->
    <div id="addExistingCustomerModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2 class="modal-title">Add Existing Customer to Category</h2>
                <button class="modal-close" onclick="closeModal('addExistingCustomerModal')">√ó</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="existing-customer-category-id" value="">
                <div class="form-group">
                    <label class="form-label">Select Customer *</label>
                    <select id="existing-customer-select" class="form-select" required>
                        <option value="">Loading customers...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Group (Optional)</label>
                    <select id="existing-customer-group-select" class="form-select">
                        <option value="">No group</option>
                    </select>
                </div>
                <div class="info-box info-box-info">
                    <strong>‚ÑπÔ∏è Note:</strong> This will update the customer's category assignment.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary"
                    onclick="closeModal('addExistingCustomerModal')">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="assignExistingCustomerToCategory()">Add to
                    Category</button>
            </div>
        </div>
    </div>

    <script src="/static/js/app.js"></script>
    <script src="/static/js/subscription-modal-enhanced.js"></script>
    <script src="/static/js/customer-modal-enhanced.js"></script>

    <script>
        // Helper functions for modals
        function openShortcutsModal() {
            openModal('shortcutsModal');
        }

        function openAboutModal() {
            openModal('aboutModal');
        }

        // Add existing customer to category
        function openAddExistingCustomerModal(categoryId) {
            document.getElementById('existing-customer-category-id').value = categoryId;

            // Load all customers
            fetch('/api/customers')
                .then(response => response.json())
                .then(customers => {
                    const select = document.getElementById('existing-customer-select');
                    select.innerHTML = '<option value="">Select a customer</option>';

                    if (customers.length === 0) {
                        select.innerHTML = '<option value="" disabled>No customers available</option>';
                    } else {
                        customers.forEach(customer => {
                            const categoryInfo = customer.category_names || 'No category';
                            const option = document.createElement('option');
                            option.value = customer.id;
                            option.textContent = `${customer.name} (${categoryInfo})`;
                            select.appendChild(option);
                        });
                    }
                })
                .catch(error => {
                    console.error('Error loading customers:', error);
                    document.getElementById('existing-customer-select').innerHTML = '<option value="">Error loading customers</option>';
                });

            // Load groups for this category
            fetch(`/api/groups?category_id=${categoryId}`)
                .then(response => response.json())
                .then(groups => {
                    const select = document.getElementById('existing-customer-group-select');
                    select.innerHTML = '<option value="">No group</option>';
                    groups.forEach(group => {
                        const option = document.createElement('option');
                        option.value = group.id;
                        option.textContent = group.name;
                        select.appendChild(option);
                    });
                })
                .catch(error => console.error('Error loading groups:', error));

            openModal('addExistingCustomerModal');
        }

        function assignExistingCustomerToCategory() {
            const customerId = document.getElementById('existing-customer-select').value;
            const categoryId = document.getElementById('existing-customer-category-id').value;
            const groupId = document.getElementById('existing-customer-group-select').value;

            if (!customerId) {
                showToast('Please select a customer', 'error');
                return;
            }

            const data = {
                category_id: parseInt(categoryId)
            };

            if (groupId) {
                data.group_id = parseInt(groupId);
            }

            fetch(`/api/customers/${customerId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            })
                .then(response => {
                    if (response.ok) {
                        showToast('Customer added to category successfully', 'success');
                        closeModal('addExistingCustomerModal');
                        setTimeout(() => window.location.reload(), 500);
                    } else {
                        return response.json().then(err => {
                            throw new Error(err.detail || 'Failed to add customer');
                        });
                    }
                })
                .catch(error => {
                    showToast(error.message, 'error');
                });
        }
    </script>

    {% block extra_scripts %}{% endblock %}

    <!-- Floating Action Button (FAB) for Quick Add -->
    <div id="fab-container" class="fab-container">
        <button id="fab-main" class="fab-main" onclick="toggleFabMenu()" aria-label="Quick Add Menu">
            <span class="fab-icon">+</span>
        </button>
        <div id="fab-menu" class="fab-menu">
            <button class="fab-action" onclick="closeFabMenu(); openModal('customerModal');"
                data-tooltip="Add Customer">
                <span class="fab-action-icon">üë§</span>
                <span class="fab-action-label">Customer</span>
            </button>
            <button class="fab-action" onclick="closeFabMenu(); openModal('subscriptionModal');"
                data-tooltip="Add Subscription">
                <span class="fab-action-icon">üìã</span>
                <span class="fab-action-label">Subscription</span>
            </button>
            <button class="fab-action" onclick="closeFabMenu(); openModal('categoryModal');"
                data-tooltip="Add Category">
                <span class="fab-action-icon">üìÅ</span>
                <span class="fab-action-label">Category</span>
            </button>
            <button class="fab-action" onclick="closeFabMenu(); openModal('groupModal');" data-tooltip="Add Group">
                <span class="fab-action-icon">üë•</span>
                <span class="fab-action-label">Group</span>
            </button>
        </div>
    </div>

    <style>
        /* Floating Action Button Styles */
        .fab-container {
            position: fixed;
            bottom: 24px;
            right: 24px;
            z-index: 1000;
            display: flex;
            flex-direction: column-reverse;
            align-items: center;
            gap: 12px;
        }

        /* Safe area for mobile devices */
        @supports (padding-bottom: env(safe-area-inset-bottom)) {
            .fab-container {
                bottom: calc(24px + env(safe-area-inset-bottom));
                right: calc(24px + env(safe-area-inset-right));
            }
        }

        .fab-main {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--color-primary, #667eea) 0%, var(--color-primary-dark, #764ba2) 100%);
            border: none;
            color: white;
            font-size: 28px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4), 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            outline: none;
        }

        .fab-main:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5), 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        .fab-main:active {
            transform: scale(0.95);
        }

        .fab-main.open {
            transform: rotate(45deg);
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }

        .fab-main.open:hover {
            transform: rotate(45deg) scale(1.1);
        }

        .fab-icon {
            line-height: 1;
            transition: transform 0.3s ease;
        }

        .fab-menu {
            display: flex;
            flex-direction: column-reverse;
            gap: 10px;
            opacity: 0;
            visibility: hidden;
            transform: translateY(20px) scale(0.8);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            pointer-events: none;
        }

        .fab-menu.open {
            opacity: 1;
            visibility: visible;
            transform: translateY(0) scale(1);
            pointer-events: auto;
        }

        .fab-action {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 16px;
            background: var(--color-bg-card, white);
            border: 1px solid var(--color-border, #e2e8f0);
            border-radius: 24px;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: all 0.2s ease;
            white-space: nowrap;
            font-size: 14px;
            color: var(--color-text, #1e293b);
        }

        .fab-action:hover {
            transform: translateX(-4px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            background: var(--color-bg-hover, #f8fafc);
        }

        .fab-action:active {
            transform: scale(0.95);
        }

        .fab-action-icon {
            font-size: 18px;
        }

        .fab-action-label {
            font-weight: 500;
        }

        /* Animation for menu items appearing */
        .fab-menu.open .fab-action {
            animation: fabItemAppear 0.3s ease forwards;
        }

        .fab-menu.open .fab-action:nth-child(1) {
            animation-delay: 0ms;
        }

        .fab-menu.open .fab-action:nth-child(2) {
            animation-delay: 50ms;
        }

        .fab-menu.open .fab-action:nth-child(3) {
            animation-delay: 100ms;
        }

        .fab-menu.open .fab-action:nth-child(4) {
            animation-delay: 150ms;
        }

        @keyframes fabItemAppear {
            from {
                opacity: 0;
                transform: translateY(10px) scale(0.8);
            }

            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        /* Backdrop when menu is open */
        .fab-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.3);
            z-index: 999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .fab-backdrop.open {
            opacity: 1;
            visibility: visible;
        }

        /* Mobile adjustments */
        @media (max-width: 640px) {
            .fab-container {
                bottom: 16px;
                right: 16px;
            }

            .fab-main {
                width: 52px;
                height: 52px;
                font-size: 24px;
            }

            .fab-action {
                padding: 8px 14px;
                font-size: 13px;
            }

            .fab-action-icon {
                font-size: 16px;
            }
        }

        /* Hide FAB on login/auth pages */
        body.auth-page .fab-container {
            display: none;
        }
    </style>

    <script>
        // FAB Menu Toggle Functions
        let fabBackdrop = null;

        function toggleFabMenu() {
            const fabMain = document.getElementById('fab-main');
            const fabMenu = document.getElementById('fab-menu');

            if (fabMenu.classList.contains('open')) {
                closeFabMenu();
            } else {
                openFabMenu();
            }
        }

        function openFabMenu() {
            const fabMain = document.getElementById('fab-main');
            const fabMenu = document.getElementById('fab-menu');

            fabMain.classList.add('open');
            fabMenu.classList.add('open');

            // Create backdrop
            if (!fabBackdrop) {
                fabBackdrop = document.createElement('div');
                fabBackdrop.className = 'fab-backdrop';
                fabBackdrop.onclick = closeFabMenu;
                document.body.appendChild(fabBackdrop);
            }
            fabBackdrop.classList.add('open');
        }

        function closeFabMenu() {
            const fabMain = document.getElementById('fab-main');
            const fabMenu = document.getElementById('fab-menu');

            fabMain.classList.remove('open');
            fabMenu.classList.remove('open');

            if (fabBackdrop) {
                fabBackdrop.classList.remove('open');
            }
        }

        // Close FAB menu on escape key
        document.addEventListener('keydown', function (e) {
            if (e.key === 'Escape') {
                closeFabMenu();
            }
        });
    </script>
</body>

</html>