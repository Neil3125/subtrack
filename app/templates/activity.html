{% extends "base.html" %}

{% block title %}Activity Log - SubTrack Web{% endblock %}

{% block content %}
<div class="animate-fade-in">
    <div class="flex items-center justify-between mb-8">
        <div>
            <h1 class="gradient-text">üìã Activity Log</h1>
            <p class="text-secondary">Track all changes and actions in your system</p>
        </div>
        <div class="flex gap-2">
            <button class="btn btn-secondary" onclick="refreshActivityLogs()">
                üîÑ Refresh
            </button>
            {% if logs|length > 15 %}
            <button class="btn btn-danger" onclick="openClearLogsModal()">
                üóëÔ∏è Clear Logs
            </button>
            {% endif %}
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="grid grid-cols-5 mb-8">
        <div class="card card-hover stat-card animate-slide-in" style="animation-delay: 0ms;">
            <div class="text-sm text-secondary mb-2">Total Activities</div>
            <div class="text-3xl font-bold text-primary mb-2" id="stat-total">{{ stats.total_actions|default(0) }}</div>
            <div class="text-xs text-secondary">Last {{ stats.period_days|default(7) }} days</div>
        </div>
        <div class="card card-hover stat-card animate-slide-in" style="animation-delay: 100ms;">
            <div class="text-sm text-secondary mb-2">Created</div>
            <div class="text-3xl font-bold text-success mb-2" id="stat-created">{{
                stats.action_counts.created|default(0) }}</div>
            <div class="text-xs text-secondary">New items added</div>
        </div>
        <div class="card card-hover stat-card animate-slide-in" style="animation-delay: 200ms;">
            <div class="text-sm text-secondary mb-2">Updated</div>
            <div class="text-3xl font-bold text-warning mb-2" id="stat-updated">{{
                stats.action_counts.updated|default(0) }}</div>
            <div class="text-xs text-secondary">Items modified</div>
        </div>
        <div class="card card-hover stat-card animate-slide-in" style="animation-delay: 250ms;">
            <div class="text-sm text-secondary mb-2">Renewed</div>
            <div class="text-3xl font-bold text-secondary mb-2" id="stat-renewed">{{
                stats.action_counts.renewed|default(0) }}</div>
            <div class="text-xs text-secondary">Subscriptions renewed</div>
        </div>
        <div class="card card-hover stat-card animate-slide-in" style="animation-delay: 300ms;">
            <div class="text-sm text-secondary mb-2">Emails Sent</div>
            <div class="text-3xl font-bold text-info mb-2" id="stat-emails">{{
                (stats.action_counts.email_sent|default(0)) + (stats.action_counts.bulk_email_sent|default(0)) }}</div>
            <div class="text-xs text-secondary">Renewal notices</div>
        </div>
    </div>

    <!-- Filters -->
    <div class="card mb-6">
        <div class="flex gap-4 items-end flex-wrap">
            <div class="form-group flex-1" style="min-width: 150px; margin-bottom: 0;">
                <label class="form-label">Entity Type</label>
                <select class="form-select" id="filter-entity" onchange="filterActivityLogs()">
                    <option value="">All Entities</option>
                    <option value="subscription">Subscriptions</option>
                    <option value="customer">Customers</option>
                    <option value="category">Categories</option>
                    <option value="group">Groups</option>
                </select>
            </div>
            <div class="form-group flex-1" style="min-width: 150px; margin-bottom: 0;">
                <label class="form-label">Action Type</label>
                <select class="form-select" id="filter-action" onchange="filterActivityLogs()">
                    <option value="">All Actions</option>
                    <option value="created">Created</option>
                    <option value="updated">Updated</option>
                    <option value="deleted">Deleted</option>
                    <option value="email_sent">Email Sent</option>
                    <option value="bulk_email_sent">Bulk Email</option>
                    <option value="renewed">Renewed</option>
                    <option value="status_changed">Status Changed</option>
                </select>
            </div>
            <div class="form-group flex-1" style="min-width: 150px; margin-bottom: 0;">
                <label class="form-label">Time Period</label>
                <select class="form-select" id="filter-days" onchange="filterActivityLogs()">
                    <option value="1">Last 24 hours</option>
                    <option value="7" selected>Last 7 days</option>
                    <option value="30">Last 30 days</option>
                    <option value="90">Last 90 days</option>
                    <option value="365">Last year</option>
                </select>
            </div>
            <button class="btn btn-secondary" onclick="clearFilters()">Clear Filters</button>
        </div>
    </div>

    <!-- Activity Timeline -->
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">üìú Activity Timeline</h2>
            <span class="badge badge-primary" id="log-count">{{ logs|length }} activities</span>
        </div>

        <div id="activity-list">
            {% if logs %}
            <div class="activity-timeline">
                {% for log in logs %}
                <div class="activity-item" data-entity="{{ log.entity_type }}" data-action="{{ log.action_type }}">
                    <div class="activity-icon">
                        {{ log.icon or 'üìã' }}
                    </div>
                    <div class="activity-content">
                        <div class="activity-header">
                            <span class="activity-title">{{ log.description }}</span>
                            <!-- Use client-side formatting for local time -->
                            <span class="activity-time"
                                data-timestamp="{{ log.created_at.isoformat() if log.created_at else '' }}">
                                {{ log.created_at.strftime('%Y-%m-%d %H:%M') if log.created_at else 'Unknown' }}
                            </span>
                        </div>
                        <div class="activity-meta">
                            <span
                                class="badge badge-{{ 'success' if log.action_type == 'created' else 'warning' if log.action_type == 'updated' else 'danger' if log.action_type == 'deleted' else 'info' }}">
                                {{ log.action_type|replace('_', ' ')|title }}
                            </span>
                            <span class="badge badge-secondary">{{ log.entity_type|title }}</span>
                            {% if log.entity_name %}
                            <span class="text-secondary text-sm">‚Ä¢ {{ log.entity_name }}</span>
                            {% endif %}
                        </div>
                        {% if log.changes %}
                        <div class="activity-changes mt-2">
                            <button class="btn btn-sm btn-secondary" onclick="toggleChanges(this)">
                                üëÅÔ∏è View Changes
                            </button>
                            <div class="changes-detail" style="display: none;">
                                <table class="table table-sm mt-2" style="font-size: 0.85rem;">
                                    <thead>
                                        <tr>
                                            <th>Field</th>
                                            <th>Old Value</th>
                                            <th>New Value</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for field, values in log.changes.items() %}
                                        <tr>
                                            <td class="font-medium">{{ field|replace('_', ' ')|title }}</td>
                                            <td class="text-danger">{{ values.old if values.old is not none else '-' }}
                                            </td>
                                            <td class="text-success">{{ values.new if values.new is not none else '-' }}
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="empty-state">
                <div class="empty-state-icon">üìã</div>
                <h3 class="empty-state-title">No activity yet</h3>
                <p class="empty-state-text">Activities will appear here when you make changes to your subscriptions,
                    customers, and other data.</p>
            </div>
            {% endif %}
        </div>

        <!-- Pagination -->
        {% if total_pages > 1 %}
        <div class="flex justify-center gap-2 mt-4 p-4 border-t" style="border-color: var(--color-border);">
            {% if current_page > 1 %}
            <button class="btn btn-sm btn-secondary" onclick="goToPage({{ current_page - 1 }})">‚Üê Previous</button>
            {% endif %}
            <span class="text-secondary" style="line-height: 32px;">Page {{ current_page }} of {{ total_pages }}</span>
            {% if current_page < total_pages %} <button class="btn btn-sm btn-secondary"
                onclick="goToPage({{ current_page + 1 }})">Next ‚Üí</button>
                {% endif %}
        </div>
        {% endif %}
    </div>
</div>

<!-- Clear Logs Confirmation Modal -->
<div id="clearLogsModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 500px;">
        <div class="modal-header">
            <h2 class="modal-title">üóëÔ∏è Clear Activity Logs</h2>
            <button class="modal-close" onclick="closeModal('clearLogsModal')">√ó</button>
        </div>
        <div class="modal-body">
            <div class="info-box info-box-warning mb-4">
                <strong>‚ö†Ô∏è Warning:</strong> This action cannot be undone. All activity logs older than the selected
                period will be permanently deleted.
            </div>

            <div class="form-group mb-4">
                <label class="form-label">Clear logs older than:</label>
                <select class="form-select" id="clear-logs-days">
                    <option value="7">7 days</option>
                    <option value="14">14 days</option>
                    <option value="30" selected>30 days</option>
                    <option value="60">60 days</option>
                    <option value="90">90 days</option>
                    <option value="0">All logs (clear everything)</option>
                </select>
            </div>

            <div class="form-group mb-4">
                <label class="form-label">Type "CLEAR" to confirm:</label>
                <input type="text" class="form-input" id="clear-logs-confirm" placeholder="Type CLEAR to confirm">
            </div>

            <div class="flex gap-2 justify-end">
                <button class="btn btn-secondary" onclick="closeModal('clearLogsModal')">Cancel</button>
                <button class="btn btn-danger" onclick="clearActivityLogs()" id="clear-logs-btn" disabled>
                    üóëÔ∏è Clear Logs
                </button>
            </div>
        </div>
    </div>
</div>

<style>
    /* ... (Keep existing styles) ... */
    .activity-timeline {
        display: flex;
        flex-direction: column;
        gap: 0;
    }

    /* ... */
</style>

<script>
    function toggleChanges(btn) {
        const detail = btn.nextElementSibling;
        if (detail.style.display === 'none') {
            detail.style.display = 'block';
            btn.innerHTML = 'üôà Hide Changes';
        } else {
            detail.style.display = 'none';
            btn.innerHTML = 'üëÅÔ∏è View Changes';
        }
    }

    function filterActivityLogs() {
        const entityType = document.getElementById('filter-entity').value;
        const actionType = document.getElementById('filter-action').value;
        const days = document.getElementById('filter-days').value;

        let url = `/activity?days=${days}`;
        if (entityType) url += `&entity_type=${entityType}`;
        if (actionType) url += `&action_type=${actionType}`;

        window.location.href = url;
    }

    function clearFilters() {
        document.getElementById('filter-entity').value = '';
        document.getElementById('filter-action').value = '';
        document.getElementById('filter-days').value = '7';
        window.location.href = '/activity';
    }

    function refreshActivityLogs() {
        window.location.reload();
    }

    function goToPage(page) {
        const entityType = document.getElementById('filter-entity').value;
        const actionType = document.getElementById('filter-action').value;
        const days = document.getElementById('filter-days').value;

        let url = `/activity?page=${page}&days=${days}`;
        if (entityType) url += `&entity_type=${entityType}`;
        if (actionType) url += `&action_type=${actionType}`;

        window.location.href = url;
    }

    // Set filter values from URL params on load
    document.addEventListener('DOMContentLoaded', function () {
        // Format timestamps to local time
        document.querySelectorAll('.activity-time').forEach(el => {
            const isoStr = el.dataset.timestamp;
            if (isoStr) {
                // Append 'Z' if not present to ensure UTC parsing
                const timeStr = isoStr.endsWith('Z') ? isoStr : isoStr + 'Z';
                const date = new Date(timeStr);
                if (!isNaN(date.getTime())) {
                    el.textContent = date.toLocaleString(undefined, {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                }
            }
        });

        const params = new URLSearchParams(window.location.search);

        if (params.get('entity_type')) {
            document.getElementById('filter-entity').value = params.get('entity_type');
        }
        if (params.get('action_type')) {
            document.getElementById('filter-action').value = params.get('action_type');
        }
        if (params.get('days')) {
            document.getElementById('filter-days').value = params.get('days');
        }

        // Enable/disable clear logs button based on confirmation input
        const confirmInput = document.getElementById('clear-logs-confirm');
        if (confirmInput) {
            confirmInput.addEventListener('input', function () {
                const clearBtn = document.getElementById('clear-logs-btn');
                clearBtn.disabled = this.value.toUpperCase() !== 'CLEAR';
            });
        }
    });

    function openClearLogsModal() {
        document.getElementById('clear-logs-confirm').value = '';
        document.getElementById('clear-logs-btn').disabled = true;
        openModal('clearLogsModal');
    }

    function clearActivityLogs() {
        const confirmValue = document.getElementById('clear-logs-confirm').value;
        if (confirmValue.toUpperCase() !== 'CLEAR') {
            showToast('Please type CLEAR to confirm', 'warning');
            return;
        }

        const days = parseInt(document.getElementById('clear-logs-days').value);
        const btn = document.getElementById('clear-logs-btn');
        const originalText = btn.innerHTML;
        btn.innerHTML = '‚è≥ Clearing...';
        btn.disabled = true;

        let url = '/api/activity/logs';
        // Pass days directly (supports 0 for all)
        url += `?days=${days}`;

        fetch(url, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            }
        })
            .then(response => response.json())
            .then(data => {
                btn.innerHTML = originalText;
                closeModal('clearLogsModal');

                if (data.deleted_count !== undefined) {
                    showToast(`Successfully cleared ${data.deleted_count} activity log(s)`, 'success');
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                } else if (data.error) {
                    showToast('Error: ' + data.error, 'error');
                }
            })
            .catch(error => {
                btn.innerHTML = originalText;
                btn.disabled = false;
                showToast('Error clearing logs: ' + error.message, 'error');
                console.error('Error:', error);
            });
    }
</script>
{% endblock %}