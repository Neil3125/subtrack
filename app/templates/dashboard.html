{% extends "base.html" %}

{% block title %}Dashboard - SubTrack Web{% endblock %}

{% block content %}
<div class="animate-fade-in">
    <div class="flex items-center justify-between mb-8">
        <div>
            <h1>Dashboard</h1>
            <p class="text-secondary">Overview of your subscriptions</p>
        </div>
        <button class="btn btn-primary" onclick="openModal('categoryModal')">
            ‚ûï Add Category
        </button>
    </div>

    <!-- Stats Grid with Enhanced Design - Clickable Cards -->
    <div class="grid grid-cols-5 mb-8">
        <div class="card card-hover stat-card animate-slide-in clickable-card" style="animation-delay: 0ms; cursor: pointer;" onclick="openModal('activeSubscriptionsModal')">
            <div class="text-sm text-secondary mb-2">Active Subscriptions</div>
            <div class="text-3xl font-bold text-primary mb-2">{{ stats.total_active|default(0) }}</div>
            <div class="progress">
                <div class="progress-bar" style="width: {{ (stats.total_active|default(0) / 20 * 100)|int }}%;"></div>
            </div>
            <div class="text-xs text-secondary mt-2">Click to view all ‚Üí</div>
        </div>
        <div class="card card-hover stat-card animate-slide-in clickable-card" style="animation-delay: 100ms; cursor: pointer;" onclick="openModal('monthlyCostModal')">
            <div class="text-sm text-secondary mb-2">Monthly Cost</div>
            <div class="text-3xl font-bold text-success mb-2">${{ "%.2f"|format(stats.monthly_cost|default(0)) }}</div>
            <div class="text-xs text-secondary">Total recurring expenses</div>
            <div class="text-xs text-secondary mt-1">Click for breakdown ‚Üí</div>
        </div>
        <div class="card card-hover stat-card animate-slide-in" style="animation-delay: 150ms;">
            <div class="text-sm text-secondary mb-2">Annual Revenue</div>
            <div class="text-3xl font-bold text-info mb-2">${{ "%.2f"|format(stats.annual_revenue|default(0)) }}</div>
            <div class="text-xs text-secondary">Projected yearly total</div>
        </div>
        <div class="card card-hover stat-card animate-slide-in clickable-card" style="animation-delay: 200ms; position: relative; cursor: pointer;" onclick="openModal('expiringSoonModal')">
            <div class="text-sm text-secondary mb-2">Expiring Soon</div>
            <div class="text-3xl font-bold text-warning mb-2">{{ stats.expiring_soon|default(0) }}</div>
            {% if stats.expiring_soon > 0 %}
            <span class="notification-badge">!</span>
            {% endif %}
            <div class="text-xs text-secondary">Click to filter ‚Üí</div>
        </div>
        <div class="card card-hover stat-card animate-slide-in clickable-card" style="animation-delay: 300ms; position: relative; cursor: pointer;" onclick="openModal('overdueModal')">
            <div class="text-sm text-secondary mb-2">Overdue</div>
            <div class="text-3xl font-bold text-danger mb-2">{{ stats.overdue|default(0) }}</div>
            {% if stats.overdue > 0 %}
            <span class="notification-badge" style="background: var(--color-danger);">{{ stats.overdue }}</span>
            {% endif %}
            <div class="text-xs text-secondary">Click to view ‚Üí</div>
        </div>
    </div>

    <!-- Empty state -->
    {% if stats.total_active == 0 %}
    <div class="card">
        <div class="empty-state">
            <div class="empty-state-icon">üìä</div>
            <h3 class="empty-state-title">No subscriptions yet</h3>
            <p class="empty-state-text">Get started by creating a category and adding your first subscription.</p>
            <button class="btn btn-primary" onclick="openModal('categoryModal')">
                Create First Category
            </button>
        </div>
    </div>
    {% endif %}
</div>

<!-- Active Subscriptions Modal -->
<div id="activeSubscriptionsModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 900px;">
        <div class="modal-header">
            <h2 class="modal-title">üìã Active Subscriptions ({{ stats.total_active }})</h2>
            <button class="modal-close" onclick="closeModal('activeSubscriptionsModal')">√ó</button>
        </div>
        <div class="modal-body">
            {% if all_active %}
            <table class="table">
                <thead>
                    <tr>
                        <th>Vendor</th>
                        <th>Customer</th>
                        <th>Cost</th>
                        <th>Cycle</th>
                        <th>Next Renewal</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for sub in all_active %}
                    <tr>
                        <td class="font-medium">{{ sub.vendor_name }}</td>
                        <td>{{ sub.customer.name }}</td>
                        <td>${{ "%.2f"|format(sub.cost) }} {{ sub.currency }}</td>
                        <td><span class="badge badge-secondary">{{ sub.billing_cycle.value }}</span></td>
                        <td>{{ sub.next_renewal_date }}</td>
                        <td><a href="/subscriptions/{{ sub.id }}" class="btn btn-sm btn-secondary">View</a></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <p class="text-secondary text-center">No active subscriptions</p>
            {% endif %}
        </div>
    </div>
</div>

<!-- Monthly Cost Modal -->
<div id="monthlyCostModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 900px; width: 95vw;">
        <div class="modal-header">
            <h2 class="modal-title">üí∞ Monthly Cost Breakdown</h2>
            <button class="modal-close" onclick="closeModal('monthlyCostModal')">√ó</button>
        </div>
        <div class="modal-body" style="overflow-x: auto;">
            <div class="grid grid-cols-2 gap-4 mb-4" style="min-width: 300px;">
                <div class="card" style="background: var(--color-bg-secondary); padding: var(--space-4);">
                    <div class="text-sm text-secondary mb-1">Total Monthly Cost</div>
                    <div class="text-2xl font-bold text-success">${{ "%.2f"|format(stats.monthly_cost|default(0)) }}</div>
                </div>
                <div class="card" style="background: var(--color-bg-secondary); padding: var(--space-4);">
                    <div class="text-sm text-secondary mb-1">Projected Annual Revenue</div>
                    <div class="text-2xl font-bold text-info">${{ "%.2f"|format(stats.annual_revenue|default(0)) }}</div>
                </div>
            </div>
            <h4 class="font-semibold mb-3">By Billing Cycle</h4>
            {% if all_active %}
            <div class="table-container" style="max-height: 400px; overflow: auto;">
                <table class="table" style="min-width: 500px; width: 100%;">
                    <thead style="position: sticky; top: 0; background: var(--color-bg-card); z-index: 1;">
                        <tr>
                            <th style="min-width: 180px; white-space: nowrap;">Vendor</th>
                            <th style="min-width: 100px; white-space: nowrap;">Cost</th>
                            <th style="min-width: 100px; white-space: nowrap;">Cycle</th>
                            <th style="min-width: 120px; white-space: nowrap;">Monthly Equiv.</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for sub in all_active %}
                        <tr>
                            <td class="font-medium" style="word-break: break-word; max-width: 200px;">{{ sub.vendor_name }}</td>
                            <td style="white-space: nowrap;">${{ "%.2f"|format(sub.cost) }}</td>
                            <td><span class="badge badge-secondary">{{ sub.billing_cycle.value }}</span></td>
                            <td style="white-space: nowrap;">
                                {% if sub.billing_cycle.value == 'yearly' %}
                                ${{ "%.2f"|format(sub.cost / 12) }}
                                {% elif sub.billing_cycle.value == 'quarterly' %}
                                ${{ "%.2f"|format(sub.cost / 3) }}
                                {% elif sub.billing_cycle.value == 'weekly' %}
                                ${{ "%.2f"|format(sub.cost * 4.33) }}
                                {% elif sub.billing_cycle.value == 'biannual' %}
                                ${{ "%.2f"|format(sub.cost / 6) }}
                                {% else %}
                                ${{ "%.2f"|format(sub.cost) }}
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Expiring Soon Modal -->
<div id="expiringSoonModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 900px;">
        <div class="modal-header">
            <h2 class="modal-title">‚ö†Ô∏è Expiring Soon</h2>
            <button class="modal-close" onclick="closeModal('expiringSoonModal')">√ó</button>
        </div>
        <div class="modal-body">
            <div class="flex gap-4 items-end mb-4">
                <div class="form-group flex-1" style="margin-bottom: 0;">
                    <label class="form-label">Filter by Days</label>
                    <select class="form-select" id="expiring-days-filter" onchange="filterExpiringSubscriptions()">
                        <option value="3">Expiring in 3 days</option>
                        <option value="7">Expiring in 7 days</option>
                        <option value="14">Expiring in 14 days</option>
                        <option value="30" selected>Expiring in 30 days</option>
                        <option value="60">Expiring in 60 days</option>
                        <option value="90">Expiring in 90 days</option>
                        <option value="999">90+ days</option>
                    </select>
                </div>
                {% if expiring_soon %}
                <button class="btn btn-primary" onclick="sendAllExpiringNotices()" id="send-all-btn">
                    üìß Send All Renewal Notices
                </button>
                {% endif %}
            </div>
            
            {% if expiring_soon %}
            <div class="info-box info-box-info mb-4" id="send-all-info">
                <strong>üí° Tip:</strong> Click "Send All Renewal Notices" to send email reminders to all customers with expiring subscriptions shown below (only those with email addresses).
            </div>
            {% endif %}
            
            <div id="expiring-results">
                {% if expiring_soon %}
                <div class="table-container" style="max-height: 400px; overflow-y: auto;">
                    <table class="table">
                        <thead style="position: sticky; top: 0; background: var(--color-bg-card); z-index: 1;">
                            <tr>
                                <th style="width: 30px;">
                                    <input type="checkbox" id="select-all-expiring" onchange="toggleSelectAllExpiring()" checked>
                                </th>
                                <th>Vendor</th>
                                <th>Customer</th>
                                <th>Email</th>
                                <th>Cost</th>
                                <th>Days</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for sub in expiring_soon %}
                            <tr class="expiring-row" data-days="{{ sub.days_until_renewal() }}" data-id="{{ sub.id }}" data-has-email="{{ 'true' if sub.customer.email else 'false' }}">
                                <td>
                                    <input type="checkbox" class="expiring-checkbox" data-id="{{ sub.id }}" {{ 'checked' if sub.customer.email else 'disabled' }}>
                                </td>
                                <td class="font-medium">{{ sub.vendor_name }}</td>
                                <td>{{ sub.customer.name }}</td>
                                <td>
                                    {% if sub.customer.email %}
                                    <span class="text-sm">{{ sub.customer.email }}</span>
                                    {% else %}
                                    <span class="badge badge-secondary">No email</span>
                                    {% endif %}
                                </td>
                                <td>${{ "%.2f"|format(sub.cost) }}</td>
                                <td><span class="badge badge-warning">{{ sub.days_until_renewal() }}d</span></td>
                                <td>
                                    <div class="flex gap-1">
                                        <a href="/subscriptions/{{ sub.id }}" class="btn btn-sm btn-secondary" title="View">üëÅÔ∏è</a>
                                        {% if sub.customer.email %}
                                        <button class="btn btn-sm btn-primary" onclick="sendRenewalNotice({{ sub.id }})" title="Send Email">üìß</button>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <div class="mt-3 text-sm text-secondary">
                    <span id="selected-expiring-count">{{ expiring_soon|length }}</span> subscriptions selected
                </div>
                {% else %}
                <p class="text-secondary text-center">No subscriptions expiring soon! üéâ</p>
                {% endif %}
            </div>
            <div id="no-expiring-message" style="display: none;" class="text-secondary text-center py-4">
                No subscriptions expiring in this period.
            </div>
        </div>
    </div>
</div>

<!-- Overdue Modal -->
<div id="overdueModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 900px;">
        <div class="modal-header">
            <h2 class="modal-title">üö® Overdue Subscriptions ({{ stats.overdue }})</h2>
            <button class="modal-close" onclick="closeModal('overdueModal')">√ó</button>
        </div>
        <div class="modal-body">
            {% if overdue %}
            <table class="table">
                <thead>
                    <tr>
                        <th>Vendor</th>
                        <th>Customer</th>
                        <th>Cost</th>
                        <th>Days Overdue</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for sub in overdue %}
                    <tr>
                        <td class="font-medium">{{ sub.vendor_name }}</td>
                        <td>{{ sub.customer.name }}</td>
                        <td>${{ "%.2f"|format(sub.cost) }} {{ sub.currency }}</td>
                        <td><span class="badge badge-danger">{{ -sub.days_until_renewal() }} days</span></td>
                        <td>
                            <a href="/subscriptions/{{ sub.id }}" class="btn btn-sm btn-secondary">View</a>
                            <button class="btn btn-sm btn-primary" onclick="renewSubscription({{ sub.id }})">Renew</button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <p class="text-secondary text-center">No overdue subscriptions! üéâ</p>
            {% endif %}
        </div>
    </div>
</div>

<script>
function filterExpiringSubscriptions() {
    const days = parseInt(document.getElementById('expiring-days-filter').value);
    const rows = document.querySelectorAll('.expiring-row');
    let visibleCount = 0;
    let withEmailCount = 0;
    
    rows.forEach(row => {
        const rowDays = parseInt(row.dataset.days);
        let show = false;
        
        if (days === 999) {
            show = rowDays > 90;
        } else {
            show = rowDays <= days && rowDays >= 0;
        }
        
        row.style.display = show ? '' : 'none';
        if (show) {
            visibleCount++;
            if (row.dataset.hasEmail === 'true') {
                withEmailCount++;
            }
        }
    });
    
    document.getElementById('no-expiring-message').style.display = visibleCount === 0 ? 'block' : 'none';
    
    // Update selected count
    const countEl = document.getElementById('selected-expiring-count');
    if (countEl) {
        countEl.textContent = withEmailCount;
    }
    
    // Update send all button visibility
    const sendAllBtn = document.getElementById('send-all-btn');
    if (sendAllBtn) {
        sendAllBtn.style.display = withEmailCount > 0 ? '' : 'none';
    }
}

function toggleSelectAllExpiring() {
    const selectAll = document.getElementById('select-all-expiring');
    const checkboxes = document.querySelectorAll('.expiring-checkbox:not(:disabled)');
    checkboxes.forEach(cb => {
        const row = cb.closest('.expiring-row');
        if (row && row.style.display !== 'none') {
            cb.checked = selectAll.checked;
        }
    });
    updateSelectedExpiringCount();
}

function updateSelectedExpiringCount() {
    const checkboxes = document.querySelectorAll('.expiring-checkbox:checked');
    const visibleChecked = Array.from(checkboxes).filter(cb => {
        const row = cb.closest('.expiring-row');
        return row && row.style.display !== 'none';
    });
    
    const countEl = document.getElementById('selected-expiring-count');
    if (countEl) {
        countEl.textContent = visibleChecked.length;
    }
}

function sendAllExpiringNotices() {
    const checkboxes = document.querySelectorAll('.expiring-checkbox:checked');
    const visibleChecked = Array.from(checkboxes).filter(cb => {
        const row = cb.closest('.expiring-row');
        return row && row.style.display !== 'none';
    });
    
    const subscriptionIds = visibleChecked.map(cb => parseInt(cb.dataset.id));
    
    if (subscriptionIds.length === 0) {
        showToast('No subscriptions selected', 'warning');
        return;
    }
    
    if (!confirm(`Send renewal notices to ${subscriptionIds.length} customer(s)?`)) {
        return;
    }
    
    const btn = document.getElementById('send-all-btn');
    const originalText = btn.innerHTML;
    btn.innerHTML = '‚è≥ Sending...';
    btn.disabled = true;
    
    fetch('/api/email/send-batch-notices', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ subscription_ids: subscriptionIds })
    })
    .then(response => response.json())
    .then(data => {
        btn.innerHTML = originalText;
        btn.disabled = false;
        
        if (data.success_count > 0) {
            showToast(`Successfully sent ${data.success_count} renewal notice(s)`, 'success');
        }
        if (data.failure_count > 0) {
            showToast(`Failed to send ${data.failure_count} notice(s)`, 'error');
        }
        if (data.success_count === 0 && data.failure_count === 0) {
            showToast('No emails were sent', 'warning');
        }
    })
    .catch(error => {
        btn.innerHTML = originalText;
        btn.disabled = false;
        showToast('Error sending notices: ' + error.message, 'error');
        console.error('Error:', error);
    });
}

// Add event listeners to checkboxes
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.expiring-checkbox').forEach(cb => {
        cb.addEventListener('change', updateSelectedExpiringCount);
    });
});
</script>

{% endblock %}
