{% extends "base.html" %}

{% block title %}Customers - SubTrack Web{% endblock %}

{% block content %}
<div class="animate-fade-in">
    <div class="flex items-center justify-between mb-8">
        <div>
            <h1 class="gradient-text">üë• All Customers</h1>
            <p class="text-secondary">Manage customers across all categories</p>
        </div>
        <button class="btn btn-primary" onclick="openModal('customerModal')">
            ‚ûï Add Customer
        </button>
    </div>

    <!-- Stats Cards -->
    <div class="grid grid-cols-4 mb-8">
        <div class="card card-hover stat-card animate-slide-in clickable-card" style="animation-delay: 0ms; cursor: pointer;" onclick="openModal('totalCustomersModal')">
            <div class="text-sm text-secondary mb-2">Total Customers</div>
            <div class="text-3xl font-bold text-primary mb-2">{{ total_customers }}</div>
            <div class="text-xs text-secondary">Click to view details ‚Üí</div>
        </div>
        <div class="card card-hover stat-card animate-slide-in clickable-card" style="animation-delay: 100ms; cursor: pointer;" onclick="openModal('categoriesModal')">
            <div class="text-sm text-secondary mb-2">Categories</div>
            <div class="text-3xl font-bold text-success mb-2">{{ categories_count }}</div>
            <div class="text-xs text-secondary">Click to view breakdown ‚Üí</div>
        </div>
        <div class="card card-hover stat-card animate-slide-in clickable-card" style="animation-delay: 200ms; cursor: pointer;" onclick="openModal('countriesModal')">
            <div class="text-sm text-secondary mb-2">Countries</div>
            <div class="text-3xl font-bold text-warning mb-2">{{ countries_count }}</div>
            <div class="text-xs text-secondary">Click to view breakdown ‚Üí</div>
        </div>
        <div class="card card-hover stat-card animate-slide-in clickable-card" style="animation-delay: 300ms; cursor: pointer;" onclick="openModal('groupsModal')">
            <div class="text-sm text-secondary mb-2">In Groups</div>
            <div class="text-3xl font-bold text-info mb-2">{{ in_groups_count }}</div>
            <div class="text-xs text-secondary">Click to view details ‚Üí</div>
        </div>
    </div>

    <!-- Filters -->
    <div class="card mb-6">
        <div class="flex gap-4 items-end flex-wrap">
            <div class="form-group flex-1" style="min-width: 200px;">
                <label class="form-label">Filter by Category</label>
                <select class="form-select" id="filter-category" onchange="filterCustomers()">
                    <option value="">All Categories</option>
                    {% for category in categories %}
                    <option value="{{ category.id }}">{{ category.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group flex-1" style="min-width: 200px;">
                <label class="form-label">Filter by Country</label>
                <select class="form-select" id="filter-country" onchange="filterCustomers()">
                    <option value="">All Countries</option>
                    {% for country in unique_countries %}
                    <option value="{{ country }}">{{ country }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group flex-1" style="min-width: 200px;">
                <label class="form-label">Search</label>
                <input type="text" class="form-input" id="filter-search" placeholder="Search by name, email..." oninput="filterCustomers()">
            </div>
            <button class="btn btn-secondary" onclick="clearFilters()">Clear Filters</button>
        </div>
    </div>

    <!-- Customers Table -->
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">üìã Customer List</h2>
            <span class="badge badge-primary" id="visible-count">{{ customers|length }} customers</span>
        </div>
        {% if customers %}
        <div class="table-container">
            <table class="table" id="customers-table">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Phone</th>
                        <th>Country</th>
                        <th>Category</th>
                        <th>Group</th>
                        <th>Subscriptions</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for customer in customers %}
                    <tr class="customer-row" 
                        data-category="{{ customer.category_id }}"
                        data-country="{{ customer.country or '' }}"
                        data-name="{{ customer.name|lower }}"
                        data-email="{{ (customer.email or '')|lower }}">
                        <td class="font-medium">
                            <a href="/customers/{{ customer.id }}" class="text-primary hover:underline">
                                {{ customer.name }}
                            </a>
                        </td>
                        <td>{{ customer.email or '-' }}</td>
                        <td>{{ customer.phone or '-' }}</td>
                        <td>
                            {% if customer.country %}
                            <span class="badge badge-secondary">{{ customer.country }}</span>
                            {% else %}
                            <span class="text-secondary">-</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if customer.categories %}
                                {% for cat in customer.categories %}
                                <a href="/categories/{{ cat.id }}" class="badge badge-primary" style="margin: 1px;">
                                    {{ cat.name }}
                                </a>
                                {% endfor %}
                            {% elif customer.primary_category %}
                                <a href="/categories/{{ customer.primary_category.id }}" class="badge badge-primary">
                                    {{ customer.primary_category.name }}
                                </a>
                            {% else %}
                                <span class="text-secondary">-</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if customer.groups %}
                                {% for grp in customer.groups %}
                                <a href="/groups/{{ grp.id }}" class="badge badge-success" style="margin: 1px;">
                                    {{ grp.name }}
                                </a>
                                {% endfor %}
                            {% elif customer.primary_group %}
                                <a href="/groups/{{ customer.primary_group.id }}" class="badge badge-success">
                                    {{ customer.primary_group.name }}
                                </a>
                            {% else %}
                                <span class="text-secondary">-</span>
                            {% endif %}
                        </td>
                        <td>
                            <span class="badge badge-info">{{ customer.subscriptions|length }}</span>
                        </td>
                        <td>
                            <div class="flex gap-1">
                                <a href="/customers/{{ customer.id }}" class="btn btn-sm btn-secondary" title="View">üëÅÔ∏è</a>
                                <button class="btn btn-sm btn-secondary" onclick="loadEditData('customer', {{ customer.id }})" title="Edit">‚úèÔ∏è</button>
                                <button class="btn btn-sm btn-danger" onclick="deleteItem('customer', {{ customer.id }}, '{{ customer.name }}')" title="Delete">üóëÔ∏è</button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="empty-state">
            <div class="empty-state-icon">üë•</div>
            <h3 class="empty-state-title">No customers yet</h3>
            <p class="empty-state-text">Add your first customer to get started.</p>
            <button class="btn btn-primary" onclick="openModal('customerModal')">
                Add Customer
            </button>
        </div>
        {% endif %}
    </div>

    <!-- Customers by Category Breakdown -->
    {% if category_breakdown %}
    <div class="card mt-6">
        <div class="card-header">
            <h2 class="card-title">üìä Customers by Category</h2>
        </div>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            {% for item in category_breakdown %}
            <div class="card card-hover" style="background: var(--color-bg-secondary);">
                <div class="flex items-center justify-between mb-2">
                    <span class="font-medium">{{ item.name }}</span>
                    <span class="badge badge-primary">{{ item.count }}</span>
                </div>
                <div class="progress" style="height: 6px;">
                    <div class="progress-bar" style="width: {{ (item.count / total_customers * 100) if total_customers > 0 else 0 }}%;"></div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Customers by Country Breakdown -->
    {% if country_breakdown %}
    <div class="card mt-6">
        <div class="card-header">
            <h2 class="card-title">üåç Customers by Country</h2>
        </div>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            {% for item in country_breakdown %}
            <div class="card card-hover" style="background: var(--color-bg-secondary);">
                <div class="flex items-center justify-between mb-2">
                    <span class="font-medium">{{ item.country or 'Not Specified' }}</span>
                    <span class="badge badge-secondary">{{ item.count }}</span>
                </div>
                <div class="progress" style="height: 6px;">
                    <div class="progress-bar" style="width: {{ (item.count / total_customers * 100) if total_customers > 0 else 0 }}%; background: var(--color-success);"></div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
</div>

<!-- Total Customers Modal -->
<div id="totalCustomersModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 600px;">
        <div class="modal-header">
            <h2 class="modal-title">üë• Customer Overview</h2>
            <button class="modal-close" onclick="closeModal('totalCustomersModal')">√ó</button>
        </div>
        <div class="modal-body">
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div class="card" style="background: var(--color-bg-secondary); padding: var(--space-4);">
                    <div class="text-sm text-secondary mb-1">Total Customers</div>
                    <div class="text-3xl font-bold text-primary">{{ total_customers }}</div>
                </div>
                <div class="card" style="background: var(--color-bg-secondary); padding: var(--space-4);">
                    <div class="text-sm text-secondary mb-1">With Email</div>
                    <div class="text-3xl font-bold text-success">{{ customers|selectattr('email')|list|length }}</div>
                </div>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div class="card" style="background: var(--color-bg-secondary); padding: var(--space-4);">
                    <div class="text-sm text-secondary mb-1">In Categories</div>
                    <div class="text-2xl font-bold text-warning">{{ categories_count }}</div>
                </div>
                <div class="card" style="background: var(--color-bg-secondary); padding: var(--space-4);">
                    <div class="text-sm text-secondary mb-1">In Groups</div>
                    <div class="text-2xl font-bold text-info">{{ in_groups_count }}</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Categories Breakdown Modal -->
<div id="categoriesModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 600px;">
        <div class="modal-header">
            <h2 class="modal-title">üìÅ Customers by Category</h2>
            <button class="modal-close" onclick="closeModal('categoriesModal')">√ó</button>
        </div>
        <div class="modal-body">
            {% if category_breakdown %}
            <div class="space-y-3">
                {% for item in category_breakdown %}
                <div class="flex justify-between items-center p-3 rounded" style="background: var(--color-bg-secondary);">
                    <div class="flex items-center gap-2">
                        <a href="/categories/{{ item.id }}" class="text-primary font-medium hover:underline">{{ item.name }}</a>
                    </div>
                    <div class="flex items-center gap-3">
                        <div class="progress" style="width: 100px; height: 6px;">
                            <div class="progress-bar" style="width: {{ (item.count / total_customers * 100) if total_customers > 0 else 0 }}%;"></div>
                        </div>
                        <span class="badge badge-primary">{{ item.count }}</span>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <p class="text-secondary text-center py-4">No categories yet</p>
            {% endif %}
        </div>
    </div>
</div>

<!-- Countries Breakdown Modal -->
<div id="countriesModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 600px;">
        <div class="modal-header">
            <h2 class="modal-title">üåç Customers by Country</h2>
            <button class="modal-close" onclick="closeModal('countriesModal')">√ó</button>
        </div>
        <div class="modal-body">
            {% if country_breakdown %}
            <div class="space-y-3" style="max-height: 400px; overflow-y: auto;">
                {% for item in country_breakdown %}
                <div class="flex justify-between items-center p-3 rounded" style="background: var(--color-bg-secondary);">
                    <span class="font-medium">{{ item.country or 'Not Specified' }}</span>
                    <div class="flex items-center gap-3">
                        <div class="progress" style="width: 100px; height: 6px;">
                            <div class="progress-bar" style="width: {{ (item.count / total_customers * 100) if total_customers > 0 else 0 }}%; background: var(--color-success);"></div>
                        </div>
                        <span class="badge badge-secondary">{{ item.count }}</span>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <p class="text-secondary text-center py-4">No country data available</p>
            {% endif %}
        </div>
    </div>
</div>

<!-- Groups Modal -->
<div id="groupsModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 700px;">
        <div class="modal-header">
            <h2 class="modal-title">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Customers in Groups</h2>
            <button class="modal-close" onclick="closeModal('groupsModal')">√ó</button>
        </div>
        <div class="modal-body">
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div class="card" style="background: var(--color-bg-secondary); padding: var(--space-4);">
                    <div class="text-sm text-secondary mb-1">In Groups</div>
                    <div class="text-2xl font-bold text-info">{{ in_groups_count }}</div>
                </div>
                <div class="card" style="background: var(--color-bg-secondary); padding: var(--space-4);">
                    <div class="text-sm text-secondary mb-1">Not in Groups</div>
                    <div class="text-2xl font-bold text-secondary">{{ total_customers - in_groups_count }}</div>
                </div>
            </div>
            {% if in_groups_count > 0 %}
            <h4 class="font-semibold mb-2">Customers with Groups</h4>
            <div class="table-container" style="max-height: 300px; overflow-y: auto;">
                <table class="table">
                    <thead style="position: sticky; top: 0; background: var(--color-bg-card); z-index: 1;">
                        <tr>
                            <th>Customer</th>
                            <th>Group(s)</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for customer in customers if customer.primary_group or (customer.groups and customer.groups|length > 0) %}
                        <tr>
                            <td class="font-medium">{{ customer.name }}</td>
                            <td>
                                {% if customer.groups %}
                                    {% for grp in customer.groups %}
                                    <span class="badge badge-success" style="margin: 1px;">{{ grp.name }}</span>
                                    {% endfor %}
                                {% elif customer.primary_group %}
                                    <span class="badge badge-success">{{ customer.primary_group.name }}</span>
                                {% endif %}
                            </td>
                            <td><a href="/customers/{{ customer.id }}" class="btn btn-sm btn-secondary">View</a></td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p class="text-secondary text-center py-4">No customers are assigned to groups yet</p>
            {% endif %}
        </div>
    </div>
</div>

<script>
function filterCustomers() {
    const categoryFilter = document.getElementById('filter-category').value;
    const countryFilter = document.getElementById('filter-country').value;
    const searchFilter = document.getElementById('filter-search').value.toLowerCase();
    
    const rows = document.querySelectorAll('.customer-row');
    let visibleCount = 0;
    
    rows.forEach(row => {
        const category = row.dataset.category;
        const country = row.dataset.country;
        const name = row.dataset.name;
        const email = row.dataset.email;
        
        let show = true;
        
        if (categoryFilter && category !== categoryFilter) show = false;
        if (countryFilter && country !== countryFilter) show = false;
        if (searchFilter && !name.includes(searchFilter) && !email.includes(searchFilter)) show = false;
        
        row.style.display = show ? '' : 'none';
        if (show) visibleCount++;
    });
    
    document.getElementById('visible-count').textContent = `${visibleCount} customers`;
}

function clearFilters() {
    document.getElementById('filter-category').value = '';
    document.getElementById('filter-country').value = '';
    document.getElementById('filter-search').value = '';
    filterCustomers();
}
</script>
{% endblock %}
