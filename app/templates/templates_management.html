{% extends "base.html" %}

{% block title %}Template Manager - SubTrack Web{% endblock %}

{% block content %}
<div class="animate-fade-in">
    <!-- Header -->
    <div class="flex items-center justify-between mb-8">
        <div>
            <h1 class="gradient-text text-3xl font-bold mb-2">üìã Template Manager</h1>
            <p class="text-secondary">Create and manage reusable subscription templates for checking out faster.</p>
        </div>
        <button class="btn btn-primary gap-2 shadow-lg hover-lift" onclick="openTemplateModal()">
            <span class="text-lg">‚ûï</span> New Template
        </button>
    </div>

    <!-- Templates Grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="templates-grid">
        <!-- Rendered by JS -->
        <div class="col-span-full text-center py-12">
            <div class="spinner"></div>
            <p class="text-secondary mt-4">Loading templates...</p>
        </div>
    </div>
</div>

<!-- Add/Edit Template Modal -->
<div id="templateModal" class="modal" style="backdrop-filter: blur(4px);">
    <div class="modal-content animate-scale-in card-glass"
        style="max-width: 550px; border: 1px solid var(--color-border);">
        <div class="modal-header border-b border-border pb-4 mb-4">
            <h2 class="modal-title text-xl font-bold" id="templateModalTitle">New Template</h2>
            <button class="modal-close text-2xl hover:text-white" onclick="closeTemplateModal()">√ó</button>
        </div>

        <form id="templateForm" onsubmit="saveTemplate(event)">
            <input type="hidden" id="template-id">

            <!-- Vendor & Plan -->
            <div class="space-y-4 mb-6">
                <div class="form-group">
                    <label class="form-label">Vendor Name <span class="text-danger">*</span></label>
                    <input type="text" id="template-vendor" class="form-input w-full bg-bg-secondary" required
                        placeholder="e.g. Netflix, Adobe, Spotify" autocomplete="off">
                </div>
                <div class="form-group">
                    <label class="form-label">Plan Name</label>
                    <input type="text" id="template-plan" class="form-input w-full bg-bg-secondary"
                        placeholder="e.g. Premium 4K, All Apps, Family">
                    <p class="text-xs text-text-tertiary mt-1">Displayed in the auto-complete dropdown.</p>
                </div>
            </div>

            <!-- Cost, Currency, Cycle -->
            <div class="grid grid-cols-2 gap-4 mb-6">
                <div class="form-group">
                    <label class="form-label">Cost <span class="text-danger">*</span></label>
                    <div class="relative">
                        <span class="absolute left-3 top-2.5 text-text-secondary">$</span>
                        <input type="number" step="0.01" id="template-cost"
                            class="form-input w-full pl-7 bg-bg-secondary" required placeholder="0.00">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Currency</label>
                    <select id="template-currency" class="form-select w-full bg-bg-secondary">
                        <option value="USD">USD ($)</option>
                        <option value="EUR">EUR (‚Ç¨)</option>
                        <option value="GBP">GBP (¬£)</option>
                        <option value="CAD">CAD ($)</option>
                        <option value="AUD">AUD ($)</option>
                        <option value="BBD">BBD ($)</option> <!-- Added BBD -->
                    </select>
                </div>
            </div>

            <!-- Details -->
            <div class="grid grid-cols-2 gap-4 mb-8">
                <div class="form-group">
                    <label class="form-label">Billing Cycle <span class="text-danger">*</span></label>
                    <select id="template-cycle" class="form-select w-full bg-bg-secondary" required>
                        <option value="monthly">Monthly</option>
                        <option value="yearly">Yearly</option>
                        <option value="quarterly">Quarterly</option>
                        <option value="weekly">Weekly</option>
                        <option value="biannual">Biannual (6M)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Default Category</label>
                    <select id="template-category" class="form-select w-full bg-bg-secondary">
                        <option value="">(No Category)</option>
                        {% for cat in categories %}
                        <option value="{{ cat.id }}">{{ cat.name }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <div class="modal-footer flex justify-end gap-3 pt-4 border-t border-border">
                <button type="button" class="btn btn-secondary" onclick="closeTemplateModal()">Cancel</button>
                <button type="submit" class="btn btn-primary px-6">Save Template</button>
            </div>
        </form>
    </div>
</div>

<script>
    let templates = [];

    // Fallback toast if global not found
    const safeShowToast = (msg, type) => {
        if (window.showToast) {
            window.showToast(msg, type);
        } else {
            alert(msg);
        }
    };

    document.addEventListener('DOMContentLoaded', loadTemplates);

    function loadTemplates() {
        const grid = document.getElementById('templates-grid');
        // loading state

        fetch('/api/templates')
            .then(r => r.json())
            .then(data => {
                templates = data;
                renderTemplates();
            })
            .catch(err => {
                console.error(err);
                grid.innerHTML = `<div class="col-span-full text-center text-danger">Failed to load templates.</div>`;
            });
    }

    function renderTemplates() {
        const grid = document.getElementById('templates-grid');
        grid.innerHTML = '';

        if (templates.length === 0) {
            grid.innerHTML = `
        <div class="col-span-full flex flex-col items-center justify-center py-16 text-center animate-fade-in">
            <div class="w-16 h-16 bg-bg-secondary rounded-full flex items-center justify-center mb-4 text-3xl shadow-inner">
                üìù
            </div>
            <h3 class="text-xl font-bold mb-2">No Templates Yet</h3>
            <p class="text-secondary max-w-md mx-auto mb-6">
                Create templates for your frequently used subscriptions (like Netflix, Spotify) to auto-fill details instantly.
            </p>
            <button class="btn btn-outline" onclick="openTemplateModal()">Create Your First Template</button>
        </div>`;
            return;
        }

        templates.forEach(t => {
            const card = document.createElement('div');
            card.className = 'card p-5 relative group hover-lift animate-slide-in';
            card.style.border = '1px solid var(--color-border)';

            // Find category name if possible (passed from backend or look up in select)
            let catName = '';
            if (t.category_id) {
                const sel = document.querySelector(`#template-category option[value="${t.category_id}"]`);
                if (sel) catName = `<span class="badge text-xs bg-bg-secondary text-text-secondary ml-2">${sel.text}</span>`;
            }

            // Cycle shorthand
            const cycleMap = { 'monthly': 'Mo', 'yearly': 'Yr', 'quarterly': 'Qtr', 'weekly': 'Wk', 'biannual': '6Mo' };
            const cycle = cycleMap[t.billing_cycle] || t.billing_cycle;

            card.innerHTML = `
            <div class="flex justify-between items-start mb-3">
                <div class="flex-1 min-w-0 pr-4">
                     <div class="flex items-center mb-1">
                        <h3 class="font-bold text-lg text-primary truncate" title="${t.vendor_name}">${t.vendor_name}</h3>
                        ${catName}
                     </div>
                     <div class="text-sm text-secondary truncate">${t.plan_name || '<span class="italic opacity-50">No plan name</span>'}</div>
                </div>
                <div class="text-right flex-shrink-0 bg-bg-secondary px-3 py-1 rounded-md">
                    <div class="font-bold text-text font-mono">${t.currency} ${t.cost.toFixed(2)}</div>
                    <div class="text-xs text-text-tertiary uppercase tracking-wider text-right">/${cycle}</div>
                </div>
            </div>
            
            <div class="absolute top-4 right-4 opacity-0 group-hover:opacity-100 transition-opacity flex gap-2">
                <!-- Hover actions if we want overlay, but bottom bar is safer for mobile -->
            </div>

            <div class="mt-4 pt-4 border-t border-border flex justify-between items-center opacity-80 group-hover:opacity-100 transition-opacity">
                 <span class="text-xs text-text-tertiary">template #${t.id}</span>
                 <div class="flex gap-2">
                    <button class="p-1.5 text-secondary hover:text-primary hover:bg-bg-secondary rounded transition-colors" 
                            title="Edit" onclick="editTemplate(${t.id})">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                    </button>
                    <button class="p-1.5 text-secondary hover:text-danger hover:bg-danger-bg rounded transition-colors" 
                            title="Delete" onclick="deleteTemplate(${t.id})">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                    </button>
                 </div>
            </div>
        `;
            grid.appendChild(card);
        });
    }

    function openTemplateModal(id = null) {
        const modal = document.getElementById('templateModal');
        const form = document.getElementById('templateForm');
        const title = document.getElementById('templateModalTitle');

        if (id) {
            const t = templates.find(x => x.id === id);
            if (!t) return;

            title.textContent = 'Edit Template';
            document.getElementById('template-id').value = t.id;
            document.getElementById('template-vendor').value = t.vendor_name;
            document.getElementById('template-plan').value = t.plan_name || '';
            document.getElementById('template-cost').value = t.cost;
            document.getElementById('template-currency').value = t.currency || 'USD';

            // Handle cycle enum (strip 'BillingCycle.')
            let cycle = t.billing_cycle;
            if (cycle.includes('.')) cycle = cycle.split('.')[1];
            document.getElementById('template-cycle').value = cycle;

            document.getElementById('template-category').value = t.category_id || '';
        } else {
            title.textContent = 'New Template';
            form.reset();
            document.getElementById('template-id').value = '';
            document.getElementById('template-currency').value = 'USD';
            document.getElementById('template-cycle').value = 'monthly';
        }

        // Animate in
        modal.style.display = 'flex';
        requestAnimationFrame(() => {
            modal.classList.add('active'); // ensure opacity transition if supported
        });
    }

    function closeTemplateModal() {
        document.getElementById('templateModal').style.display = 'none';
    }

    function saveTemplate(e) {
        e.preventDefault();
        const id = document.getElementById('template-id').value;

        // Basic Validation
        const vendor = document.getElementById('template-vendor').value.trim();
        const cost = parseFloat(document.getElementById('template-cost').value);

        if (!vendor || isNaN(cost)) {
            safeShowToast('Please fill in required fields correctly.', 'error');
            return;
        }

        const data = {
            vendor_name: vendor,
            plan_name: document.getElementById('template-plan').value.trim() || null,
            cost: cost,
            currency: document.getElementById('template-currency').value,
            billing_cycle: document.getElementById('template-cycle').value,
            category_id: document.getElementById('template-category').value || null
        };

        // If ID exists, it's an update
        const method = id ? 'PUT' : 'POST';
        const url = id ? `/api/templates/${id}` : '/api/templates';

        const btn = e.target.querySelector('button[type="submit"]');
        const originalText = btn.textContent;
        btn.textContent = 'Saving...';
        btn.disabled = true;

        fetch(url, {
            method: method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        })
            .then(async r => {
                if (!r.ok) {
                    const err = await r.json().catch(() => ({}));
                    throw new Error(err.detail || 'Failed to save template');
                }
                return r.json();
            })
            .then(() => {
                closeTemplateModal();
                loadTemplates();
                safeShowToast(id ? 'Template updated!' : 'Template created!', 'success');
            })
            .catch(err => {
                console.error(err);
                safeShowToast(err.message, 'error');
            })
            .finally(() => {
                btn.textContent = originalText;
                btn.disabled = false;
            });
    }

    function editTemplate(id) {
        openTemplateModal(id);
    }

    function deleteTemplate(id) {
        if (confirm('Are you sure you want to delete this template?')) {
            fetch(`/api/templates/${id}`, { method: 'DELETE' })
                .then(r => {
                    if (r.ok) {
                        loadTemplates();
                        safeShowToast('Template deleted.', 'success');
                    } else {
                        safeShowToast('Failed to delete template.', 'error');
                    }
                });
        }
    }
</script>
{% endblock %}