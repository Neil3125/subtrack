{% extends "base.html" %}

{% block title %}Template Manager - SubTrack Web{% endblock %}

{% block content %}
<style>
    /* Phase 2 & 3: Premium Aesthetics & Animations */
    :root {
        --glass-bg: rgba(255, 255, 255, 0.05);
        --glass-border: rgba(255, 255, 255, 0.1);
        --glass-blur: 16px;
        --accent-glow: 0 0 20px rgba(99, 102, 241, 0.3);
        --input-bg: rgba(0, 0, 0, 0.2);
    }

    [data-theme="light"] {
        --glass-bg: rgba(255, 255, 255, 0.6);
        --glass-border: rgba(0, 0, 0, 0.05);
        --input-bg: rgba(255, 255, 255, 0.5);
    }

    .glass-panel {
        background: var(--glass-bg);
        backdrop-filter: blur(var(--glass-blur));
        -webkit-backdrop-filter: blur(var(--glass-blur));
        border: 1px solid var(--glass-border);
        box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.1);
    }

    /* Modal Animation */
    .modal-enter {
        opacity: 0;
        transform: scale(0.95) translateY(20px);
    }

    .modal-enter-active {
        opacity: 1;
        transform: scale(1) translateY(0);
        transition: opacity 0.3s ease, transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    /* Input Styling */
    .premium-input {
        background: var(--input-bg) !important;
        border: 1px solid var(--glass-border) !important;
        border-radius: 8px;
        transition: all 0.3s ease;
        backdrop-filter: blur(4px);
    }

    .premium-input:focus {
        border-color: var(--color-primary) !important;
        box-shadow: var(--accent-glow);
        transform: translateY(-1px);
    }

    /* Card Hover */
    .template-card {
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        border: 1px solid var(--color-border);
    }

    .template-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 12px 24px -10px rgba(0, 0, 0, 0.3);
        border-color: var(--color-primary);
    }

    /* Floating Toast */
    #toast-container {
        position: fixed;
        top: 24px;
        right: 24px;
        z-index: 9999;
        display: flex;
        flex-direction: column;
        gap: 12px;
        pointer-events: none;
    }

    .toast {
        pointer-events: auto;
        min-width: 300px;
        padding: 16px;
        border-radius: 12px;
        background: var(--color-bg-secondary);
        border-left: 4px solid var(--color-primary);
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        display: flex;
        align-items: center;
        justify-content: space-between;
        animation: slideInRight 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
        backdrop-filter: blur(12px);
    }

    .toast.success {
        border-left-color: #10b981;
    }

    .toast.error {
        border-left-color: #ef4444;
    }

    @keyframes slideInRight {
        from {
            opacity: 0;
            transform: translateX(50px);
        }

        to {
            opacity: 1;
            transform: translateX(0);
        }
    }

    @keyframes slideOutRight {
        to {
            opacity: 0;
            transform: translateX(50px);
        }
    }

    /* Custom Scrollbar for Modal */
    .modal-body-scroll {
        max-height: 70vh;
        overflow-y: auto;
        padding-right: 8px;
    }

    .modal-body-scroll::-webkit-scrollbar {
        width: 6px;
    }

    .modal-body-scroll::-webkit-scrollbar-track {
        background: transparent;
    }

    .modal-body-scroll::-webkit-scrollbar-thumb {
        background: var(--color-border);
        border-radius: 10px;
    }
</style>

<!-- Floating Toast Container -->
<div id="toast-container"></div>

<div class="animate-fade-in max-w-7xl mx-auto">
    <!-- Header -->
    <div class="flex items-center justify-between mb-10">
        <div>
            <h1 class="gradient-text text-4xl font-bold mb-2 tracking-tight">Template Manager</h1>
            <p class="text-secondary text-lg">Streamline your subscriptions with reusable smart templates.</p>
        </div>
        <button class="btn btn-primary gap-2 shadow-xl hover-scale px-6 py-3 rounded-xl font-medium transition-all"
            onclick="openTemplateModal()">
            <span class="text-xl">‚ú®</span> New Template
        </button>
    </div>

    <!-- Templates Grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6" id="templates-grid">
        <!-- Loading Skeleton -->
        <div class="col-span-full grid grid-cols-1 md:grid-cols-3 gap-6 animate-pulse">
            <div class="h-40 bg-bg-secondary rounded-2xl opacity-50"></div>
            <div class="h-40 bg-bg-secondary rounded-2xl opacity-50"></div>
            <div class="h-40 bg-bg-secondary rounded-2xl opacity-50"></div>
        </div>
    </div>
</div>

<!-- Add/Edit Template Modal -->
<div id="templateModal" class="modal" style="backdrop-filter: blur(8px); background: rgba(0,0,0,0.4);">
    <div class="modal-content glass-panel p-0 overflow-hidden" style="max-width: 600px; border-radius: 20px;">

        <!-- Header -->
        <div class="p-6 border-b border-glass-border flex justify-between items-center bg-bg-secondary/30">
            <div>
                <h2 class="text-2xl font-bold text-gradient" id="templateModalTitle">New Template</h2>
                <p class="text-sm text-secondary">Configure your reuseable subscription details.</p>
            </div>
            <button class="text-2xl text-secondary hover:text-primary transition-colors focus:outline-none"
                onclick="closeTemplateModal()">√ó</button>
        </div>

        <form id="templateForm" onsubmit="saveTemplate(event)" class="p-6 md:p-8 modal-body-scroll">
            <input type="hidden" id="template-id">

            <!-- Vendor Section -->
            <div class="mb-8">
                <h3 class="text-xs font-bold text-secondary uppercase tracking-wider mb-4">Core Info</h3>
                <div class="grid grid-cols-1 gap-5">
                    <div class="form-group">
                        <label class="form-label text-sm font-medium mb-2">Vendor Name</label>
                        <input type="text" id="template-vendor" class="form-input premium-input w-full p-3" required
                            placeholder="e.g. Netflix, Adobe, AWS" autocomplete="off">
                    </div>
                    <div class="form-group">
                        <label class="form-label text-sm font-medium mb-2">Plan Details</label>
                        <input type="text" id="template-plan" class="form-input premium-input w-full p-3"
                            placeholder="e.g. Premium 4K, All Apps, Family Bundle">
                    </div>
                </div>
            </div>

            <!-- Billing Section -->
            <div class="mb-8">
                <h3 class="text-xs font-bold text-secondary uppercase tracking-wider mb-4">Billing Configuration</h3>
                <div class="grid grid-cols-2 gap-5">
                    <div class="form-group">
                        <label class="form-label text-sm font-medium mb-2">Cost</label>
                        <div class="relative">
                            <span class="absolute left-3 top-3.5 text-secondary">$</span>
                            <input type="number" step="0.01" id="template-cost"
                                class="form-input premium-input w-full pl-8 p-3" required placeholder="0.00">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label text-sm font-medium mb-2">Currency</label>
                        <select id="template-currency" class="form-select premium-input w-full p-3">
                            <option value="USD">USD ($)</option>
                            <option value="EUR">EUR (‚Ç¨)</option>
                            <option value="GBP">GBP (¬£)</option>
                            <option value="CAD">CAD ($)</option>
                            <option value="AUD">AUD ($)</option>
                            <option value="BBD">BBD ($)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label text-sm font-medium mb-2">Cycle</label>
                        <select id="template-cycle" class="form-select premium-input w-full p-3" required>
                            <option value="monthly">Monthly</option>
                            <option value="yearly">Yearly</option>
                            <option value="quarterly">Quarterly</option>
                            <option value="weekly">Weekly</option>
                            <option value="biannual">Biannual (6M)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label text-sm font-medium mb-2">Category</label>
                        <select id="template-category" class="form-select premium-input w-full p-3">
                            <option value="">(None)</option>
                            {% for cat in categories %}
                            <option value="{{ cat.id }}">{{ cat.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </div>

            <!-- Footer -->
            <div class="flex justify-end gap-4 pt-4 border-t border-glass-border">
                <button type="button" class="btn text-secondary hover:text-text px-6"
                    onclick="closeTemplateModal()">Cancel</button>
                <button type="submit"
                    class="btn bg-gradient-to-r from-indigo-500 to-purple-600 hover:from-indigo-600 hover:to-purple-700 text-white shadow-lg rounded-xl px-8 py-3 font-semibold transition-all transform hover:scale-[1.02]">
                    <span class="btn-text">Save Template</span>
                    <span class="btn-loader hidden animate-spin ml-2">‚è≥</span>
                </button>
            </div>
        </form>
    </div>
</div>

<script>
    let templates = [];

    // --- Phase 3: Premium Toast Notifications ---
    function showPremiumToast(message, type = 'info') {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;

        const icon = type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : '‚ÑπÔ∏è';

        toast.innerHTML = `
            <div class="flex items-center gap-3">
                <span class="text-xl">${icon}</span>
                <span class="font-medium text-text">${message}</span>
            </div>
            <button class="text-secondary hover:text-text ml-4" onclick="this.parentElement.remove()">√ó</button>
        `;

        container.appendChild(toast);

        // Auto remove
        setTimeout(() => {
            toast.style.animation = 'slideOutRight 0.4s forwards';
            setTimeout(() => toast.remove(), 400);
        }, 4000);
    }

    document.addEventListener('DOMContentLoaded', loadTemplates);

    function loadTemplates() {
        fetch('/api/templates')
            .then(r => {
                if (!r.ok) throw new Error('Server error');
                return r.json();
            })
            .then(data => {
                templates = data;
                renderTemplates();
            })
            .catch(err => {
                console.error(err);
                document.getElementById('templates-grid').innerHTML = `
                    <div class="col-span-full text-center py-12">
                        <div class="text-danger text-xl mb-2">‚ö†Ô∏è Failed to connect</div>
                        <p class="text-secondary">Could not load templates. Check your connection.</p>
                        <button onclick="loadTemplates()" class="btn btn-outline mt-4">Retry</button>
                    </div>`;
            });
    }

    function renderTemplates() {
        const grid = document.getElementById('templates-grid');
        grid.innerHTML = '';

        if (templates.length === 0) {
            grid.innerHTML = `
            <div class="col-span-full flex flex-col items-center justify-center py-20 animate-fade-in">
                <div class="w-24 h-24 bg-bg-secondary rounded-full flex items-center justify-center mb-6 text-5xl shadow-inner">
                    ‚ú®
                </div>
                <h3 class="text-2xl font-bold mb-3 text-gradient">Start Your Collection</h3>
                <p class="text-secondary max-w-md mx-auto mb-8 text-center text-lg">
                    Create your first smart template to automate your subscription tracking properly.
                </p>
                <button class="btn btn-primary shadow-xl hover-scale px-8 py-3 rounded-full" onclick="openTemplateModal()">
                    Create Template
                </button>
            </div>`;
            return;
        }

        templates.forEach((t, index) => {
            const card = document.createElement('div');
            card.className = 'template-card bg-bg-secondary/40 backdrop-blur-sm rounded-2xl p-6 relative group';
            card.style.animation = `fade-in 0.5s ease backwards ${index * 0.05}s`;

            // Category Badge
            let catBadge = '';
            if (t.category_id) {
                const sel = document.querySelector(`#template-category option[value="${t.category_id}"]`);
                if (sel) catBadge = `<span class="px-2 py-1 rounded-md text-xs font-medium bg-bg-secondary border border-border text-secondary ml-2">${sel.text}</span>`;
            }

            // Cycle format
            const cycleMap = { 'monthly': 'Mo', 'yearly': 'Yr', 'quarterly': 'Qtr', 'weekly': 'Wk', 'biannual': '6Mo' };
            const cycle = cycleMap[t.billing_cycle] || t.billing_cycle;

            card.innerHTML = `
                <div class="flex justify-between items-start mb-4">
                    <div class="overflow-hidden">
                         <div class="flex items-center mb-1">
                            <h3 class="font-bold text-xl text-primary truncate tracking-tight">${t.vendor_name}</h3>
                         </div>
                         <div class="flex items-center text-sm text-secondary gap-2">
                             <span class="truncate">${t.plan_name || 'Standard Plan'}</span>
                             ${catBadge}
                         </div>
                    </div>
                    <div class="text-right bg-bg-elevated px-3 py-1.5 rounded-lg border border-border/50 shadow-sm">
                        <div class="font-bold text-lg text-text-primary tracking-tight">${t.currency} ${t.cost.toFixed(2)}</div>
                        <div class="text-xs text-secondary font-medium uppercase text-right">/${cycle}</div>
                    </div>
                </div>
                
                <div class="mt-4 pt-4 border-t border-border/50 flex justify-end gap-3 opacity-60 group-hover:opacity-100 transition-opacity duration-300">
                     <button class="flex items-center gap-1.5 px-3 py-1.5 text-sm font-medium text-secondary hover:text-primary hover:bg-primary/10 rounded-lg transition-colors" 
                             onclick="editTemplate(${t.id})">
                         <span>‚úèÔ∏è</span> Edit
                     </button>
                     <button class="flex items-center gap-1.5 px-3 py-1.5 text-sm font-medium text-secondary hover:text-danger hover:bg-danger/10 rounded-lg transition-colors" 
                             onclick="deleteTemplate(${t.id})">
                         <span>üóëÔ∏è</span> Delete
                     </button>
                </div>
            `;
            grid.appendChild(card);
        });
    }

    function openTemplateModal(id = null) {
        const modal = document.getElementById('templateModal');
        const content = modal.querySelector('.modal-content');
        const form = document.getElementById('templateForm');
        const title = document.getElementById('templateModalTitle');
        const btnText = form.querySelector('.btn-text');

        // Reset state
        form.reset();
        btnText.textContent = 'Save Template';

        if (id) {
            const t = templates.find(x => x.id === id);
            if (!t) return;

            title.textContent = 'Edit Template';
            document.getElementById('template-id').value = t.id;
            document.getElementById('template-vendor').value = t.vendor_name;
            document.getElementById('template-plan').value = t.plan_name || '';
            document.getElementById('template-cost').value = t.cost;
            document.getElementById('template-currency').value = t.currency || 'USD';

            let cycle = t.billing_cycle;
            if (cycle.includes('.')) cycle = cycle.split('.')[1];
            document.getElementById('template-cycle').value = cycle;

            document.getElementById('template-category').value = t.category_id || '';
        } else {
            title.textContent = 'New Template';
            document.getElementById('template-id').value = '';
            document.getElementById('template-currency').value = 'USD';
            document.getElementById('template-cycle').value = 'monthly';
        }

        modal.style.display = 'flex';
        // Trigger CSS animation manually if needed, but the class logic works well with display:flex
        content.classList.remove('modal-enter');
        void content.offsetWidth; // trigger reflow
        content.classList.add('modal-enter-active');
    }

    function closeTemplateModal() {
        document.getElementById('templateModal').style.display = 'none';
    }

    function saveTemplate(e) {
        e.preventDefault();

        // --- Phase 1: Robust Data Handling ---
        const idInput = document.getElementById('template-id');
        const id = idInput.value ? parseInt(idInput.value) : null;

        const vendor = document.getElementById('template-vendor').value.trim();
        const costStr = document.getElementById('template-cost').value;
        const cost = parseFloat(costStr);
        const cycle = document.getElementById('template-cycle').value;
        const currency = document.getElementById('template-currency').value;

        // Handle optional nullable fields
        const plan = document.getElementById('template-plan').value.trim() || null;
        const catVal = document.getElementById('template-category').value;
        const category_id = catVal ? parseInt(catVal) : null;

        if (!vendor || isNaN(cost)) {
            showPremiumToast('Please fill in valid vendor and cost.', 'error');
            return;
        }

        // Loading State
        const btn = e.target.querySelector('button[type="submit"]');
        const btnText = btn.querySelector('.btn-text');
        const btnLoader = btn.querySelector('.btn-loader');

        btn.disabled = true;
        btnText.textContent = id ? 'Updating...' : 'Creating...';
        btnLoader.classList.remove('hidden');

        const payload = {
            vendor_name: vendor,
            plan_name: plan,
            cost: cost,
            currency: currency,
            billing_cycle: cycle,
            category_id: category_id
        };

        const method = id ? 'PUT' : 'POST';
        const url = id ? `/api/templates/${id}` : '/api/templates';

        fetch(url, {
            method: method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        })
            .then(async r => {
                if (!r.ok) {
                    const err = await r.json().catch(() => ({}));
                    // Check for validation error structure
                    const msg = err.detail ? (typeof err.detail === 'string' ? err.detail : 'Validation error') : 'Server error';
                    throw new Error(msg);
                }
                return r.json();
            })
            .then(() => {
                closeTemplateModal();
                loadTemplates();
                showPremiumToast(id ? 'Template updated successfully' : 'New template created', 'success');
            })
            .catch(err => {
                console.error(err);
                showPremiumToast(err.message || 'Failed to save template', 'error');
            })
            .finally(() => {
                btn.disabled = false;
                btnText.textContent = 'Save Template';
                btnLoader.classList.add('hidden');
            });
    }

    function editTemplate(id) {
        openTemplateModal(id);
    }

    function deleteTemplate(id) {
        if (confirm('Delete this template permanently?')) {
            fetch(`/api/templates/${id}`, { method: 'DELETE' })
                .then(r => {
                    if (r.ok) {
                        loadTemplates();
                        showPremiumToast('Template deleted', 'success');
                    } else {
                        showPremiumToast('Could not delete template', 'error');
                    }
                })
                .catch(() => showPremiumToast('Network error', 'error'));
        }
    }
</script>
{% endblock %}