{% extends "base.html" %}

{% block title %}Log Check Pro - SubTrack{% endblock %}

{% block extra_head %}
<!-- Flatpickr for date/time picking -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js"></script>

<!-- Pro Theme CSS -->
<link rel="stylesheet" href="/static/css/log_check_pro.css">

<script>
    // Apply Pro Theme class to body
    document.body.classList.add('log-check-pro');
</script>
{% endblock %}

{% block content %}
<div class="pro-container animate-enter">

    <!-- Header -->
    <header class="pro-header">
        <h1 class="pro-title">Log Check Pro</h1>
        <p class="pro-subtitle">System Maintenance & Tracking Console</p>
    </header>

    <!-- Main Glass Card -->
    <div class="glass-card">

        <!-- Clock Centerpiece -->
        <div class="clock-wrapper">
            <div class="pro-clock" id="clock">00:00:00</div>
            <div class="pro-date" id="date">Loading date...</div>
        </div>

        <!-- Mode Switcher -->
        <div style="text-align: center;">
            <div class="toggle-wrapper">
                <div class="toggle-option active" onclick="setMode('automatic')" id="mode-auto">Automatic</div>
                <div class="toggle-option" onclick="setMode('manual')" id="mode-manual">Manual</div>
            </div>
        </div>

        <!-- Automatic Controls -->
        <div id="controls-auto" class="pro-input-group">
            <span class="pro-label">Duration</span>
            <div class="flex items-center gap-2">
                <input type="number" id="duration-hours" class="pro-input" value="0" min="0">
                <span class="pro-label" style="font-size: 0.8rem;">HR</span>
            </div>
            <div class="flex items-center gap-2">
                <input type="number" id="duration-minutes" class="pro-input" value="30" min="0" step="5">
                <span class="pro-label" style="font-size: 0.8rem;">MIN</span>
            </div>
        </div>

        <!-- Manual Controls -->
        <div id="controls-manual" class="pro-input-group" style="display: none; flex-wrap: wrap;">
            <div class="flex flex-col items-center">
                <span class="pro-label mb-2">Start</span>
                <input type="text" id="start-time" class="pro-input" placeholder="10:00 AM" style="width: 140px;">
            </div>
            <div class="flex flex-col items-center">
                <span class="pro-label mb-2">End</span>
                <input type="text" id="end-time" class="pro-input" placeholder="12:00 PM" style="width: 140px;">
            </div>
            <div class="flex flex-col items-center">
                <span class="pro-label mb-2">Date</span>
                <input type="text" id="log-date" class="pro-input" placeholder="Today"
                    style="width: 160px; font-size: 1.2rem;">
            </div>
        </div>

        <!-- Action Grid -->
        <div class="action-grid">
            <!-- Service Check -->
            <div class="action-card card-service" onclick="generateLog('service')">
                <div class="action-icon">üîß</div>
                <div class="action-label">Service Check</div>
                <div class="text-xs text-secondary">Routine Maintenance</div>
            </div>

            <!-- Backup Check -->
            <div class="action-card card-backup" onclick="generateLog('backup')">
                <div class="action-icon">üíæ</div>
                <div class="action-label">Backup Check</div>
                <div class="text-xs text-secondary">Data Integrity Verification</div>
            </div>

            <!-- On-Site -->
            <div class="action-card card-onsite" onclick="openOnSiteModal()">
                <div class="action-icon">üöó</div>
                <div class="action-label">On-Site</div>
                <div class="text-xs text-secondary">Field Support Visit</div>
            </div>

            <!-- Custom -->
            <div class="action-card card-custom" onclick="openCustomModal()">
                <div class="action-icon">üìù</div>
                <div class="action-label">Custom Entry</div>
                <div class="text-xs text-secondary">Specific Log Details</div>
            </div>
        </div>

        <!-- Preview Area -->
        <div class="mt-8">
            <div class="flex justify-between items-end mb-2">
                <span class="pro-label">Log Preview</span>
                <span class="text-xs text-secondary" id="char-count">0 chars</span>
            </div>
            <textarea id="log-preview" class="pro-preview" readonly>Ready to generate log...</textarea>

            <div class="pro-footer">
                <a href="/log-check/history" class="btn btn-secondary btn-sm"
                    style="background: rgba(255,255,255,0.1); border: none;">
                    üìö History
                </a>
                <button class="btn btn-primary" id="btn-copy" data-clipboard-target="#log-preview">
                    üìã Copy to Clipboard
                </button>
            </div>
        </div>

    </div>
</div>

<!-- Modals (Re-using standard styles but wrapped slightly for theme consistency) -->
<!-- Custom Check Modal -->
<div id="customCheckModal" class="modal" style="display: none;">
    <div class="modal-content glass-card" style="max-width: 500px; padding: 24px; background: #1e293b;">
        <div class="modal-header">
            <h2 class="modal-title text-white">Custom Check</h2>
            <button class="modal-close text-white" onclick="closeModal('customCheckModal')">√ó</button>
        </div>
        <div class="modal-body">
            <div class="form-group mb-4">
                <div class="flex justify-between items-center mb-2">
                    <label class="form-label text-gray-300 mb-0">Category</label>
                    <button class="text-xs text-blue-400 hover:text-blue-300 underline"
                        onclick="openCategoryManageModal()">Manage Categories</button>
                </div>
                <div class="flex gap-2">
                    <select class="form-select flex-1 bg-gray-800 text-white border-gray-600" id="custom-category"
                        onchange="onCategoryChange()">
                        <option value="Custom Check" data-desc="">Custom Check</option>
                        {% for cat in check_categories %}
                        <option value="{{ cat.name }}" data-desc="{{ cat.description or '' }}">{{ cat.name }}</option>
                        {% endfor %}
                    </select>
                    <button class="btn btn-secondary" onclick="openCategoryEditModal()">+</button>
                </div>
            </div>
            <div class="form-group">
                <label class="form-label text-gray-300">Log Message</label>
                <textarea class="form-textarea bg-gray-800 text-white border-gray-600" id="custom-message"
                    rows="4"></textarea>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('customCheckModal')">Cancel</button>
            <button class="btn btn-primary" onclick="submitCustomCheck()">Generate Log</button>
        </div>
    </div>
</div>

<!-- On-Site Modal -->
<div id="onSiteModal" class="modal" style="display: none;">
    <div class="modal-content glass-card" style="max-width: 500px; padding: 24px; background: #1e293b;">
        <div class="modal-header">
            <h2 class="modal-title text-white">On-Site Check</h2>
            <button class="modal-close text-white" onclick="closeModal('onSiteModal')">√ó</button>
        </div>
        <div class="modal-body">
            <div class="grid gap-3">
                {% for option in onsite_options %}
                <button
                    class="card p-3 text-left hover:bg-gray-700 transition-colors bg-gray-800 text-white border-gray-600"
                    onclick="submitOnSite('{{ option }}')">
                    {{ option }}
                </button>
                {% endfor %}
                <button
                    class="card p-3 text-left hover:bg-gray-700 transition-colors font-bold text-blue-400 bg-gray-800 border-gray-600"
                    onclick="submitOnSite('On-site support provided.')">
                    Default (Support Provided)
                </button>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('onSiteModal')">Cancel</button>
        </div>
    </div>
</div>

<!-- Category Management Modal -->
<div id="categoryManageModal" class="modal" style="display: none; z-index: 1000;">
    <div class="modal-content glass-card" style="max-width: 600px; padding: 24px; background: #1e293b;">
        <div class="modal-header mb-4 flex justify-between items-center">
            <h2 class="modal-title text-white m-0">Manage Categories</h2>
            <button class="modal-close text-white text-2xl" onclick="closeModal('categoryManageModal')">&times;</button>
        </div>
        <div class="modal-body max-h-[60vh] overflow-y-auto pr-2" id="category-list-container">
            <div class="text-center text-gray-400 py-4">Loading...</div>
        </div>
        <div class="modal-footer mt-4 pt-4 border-t border-gray-700">
            <button class="btn btn-primary w-full" onclick="openCategoryEditModal()">+ Add New Category</button>
        </div>
    </div>
</div>

<!-- Category Edit Modal -->
<div id="categoryEditModal" class="modal" style="display: none; z-index: 1010;">
    <div class="modal-content glass-card"
        style="max-width: 400px; padding: 24px; background: #0f172a; border: 1px solid var(--color-glass-border);">
        <div class="modal-header mb-4 flex justify-between items-center">
            <h2 class="modal-title text-white m-0" id="cat-edit-title">Add Category</h2>
            <button class="modal-close text-white text-2xl" onclick="closeModal('categoryEditModal')">&times;</button>
        </div>
        <div class="modal-body">
            <input type="hidden" id="cat-edit-id">
            <div class="form-group mb-3">
                <label class="form-label text-gray-300 mb-1 block">Name</label>
                <input type="text" id="cat-edit-name"
                    class="pro-input w-full bg-gray-800 text-white border-b-2 border-gray-600 p-2 text-left text-base"
                    style="width: 100%">
            </div>
            <div class="form-group mb-3 mt-4">
                <label class="form-label text-gray-300 mb-1 block">Default Log Message</label>
                <textarea id="cat-edit-desc"
                    class="pro-preview w-full bg-gray-800 text-white border border-gray-600 p-2 rounded" rows="3"
                    style="min-height: 80px"></textarea>
            </div>
        </div>
        <div class="modal-footer mt-4 flex justify-end gap-2">
            <button class="btn btn-secondary" onclick="closeModal('categoryEditModal')">Cancel</button>
            <button class="btn btn-primary" onclick="saveCategory()">Save</button>
        </div>
    </div>
</div>

<!-- Status Toast -->
<div id="status-toast" class="status-toast">
    <span class="text-xl">‚úÖ</span>
    <span id="toast-message">Action successful</span>
</div>

<script>
    // --- Clock ---
    function updateClock() {
        const now = new Date();
        document.getElementById('clock').textContent = now.toLocaleTimeString();
        document.getElementById('date').textContent = now.toLocaleDateString(undefined, { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
    }
    setInterval(updateClock, 1000);
    updateClock();

    // --- Mode Switching ---
    let currentMode = 'automatic';
    function setMode(mode) {
        currentMode = mode;
        document.getElementById('mode-auto').classList.toggle('active', mode === 'automatic');
        document.getElementById('mode-manual').classList.toggle('active', mode === 'manual');
        document.getElementById('controls-auto').style.display = mode === 'automatic' ? 'flex' : 'none';

        // Manual controls layout is tricky, use flex/none
        const manualControls = document.getElementById('controls-manual');
        if (mode === 'manual') {
            manualControls.style.display = 'flex';
            initManualInputs();
        } else {
            manualControls.style.display = 'none';
        }
    }

    function initManualInputs() {
        if (!document.getElementById('log-date')._flatpickr) {
            flatpickr("#log-date", {
                dateFormat: "m/d/Y",
                defaultDate: "today",
                theme: "dark"
            });
        }
        if (!document.getElementById('start-time')._flatpickr) {
            flatpickr("#start-time", {
                enableTime: true,
                noCalendar: true,
                dateFormat: "h:i K",
                time_24hr: false,
                theme: "dark"
            });
        }
        if (!document.getElementById('end-time')._flatpickr) {
            flatpickr("#end-time", {
                enableTime: true,
                noCalendar: true,
                dateFormat: "h:i K",
                time_24hr: false,
                theme: "dark"
            });
        }
    }

    // --- Log Generation ---
    async function generateLog(type) {
        const payload = { check_type: type, mode: currentMode };

        if (currentMode === 'automatic') {
            payload.hours = parseInt(document.getElementById('duration-hours').value) || 0;
            payload.minutes = parseInt(document.getElementById('duration-minutes').value) || 0;
        } else {
            const startTime = document.getElementById('start-time').value;
            const endTime = document.getElementById('end-time').value;
            if (!startTime || !endTime) { showToast("Enter start/end times", "error"); return; }
            payload.start_time = startTime;
            payload.end_time = endTime;
            payload.date_str = document.getElementById('log-date').value;
        }

        if (type === 'custom') {
            payload.message = document.getElementById('custom-message').value;
            payload.category_name = document.getElementById('custom-category').value;
        }

        try {
            const response = await fetch('/api/log-check/generate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const data = await response.json();

            if (!response.ok) {
                showToast(data.detail || "Error generating log", "error");
                return;
            }

            // Simulating typing effect for preview? No, just set it.
            const preview = document.getElementById('log-preview');
            preview.value = data.full_entry || '';
            // Flash effect
            preview.style.borderColor = 'var(--color-accent-green)';
            setTimeout(() => preview.style.borderColor = 'var(--color-glass-border)', 300);

            showToast("Log generated successfully!");
            if (type === 'custom') closeModal('customCheckModal');
            if (type === 'onsite') closeModal('onSiteModal');
        } catch (e) {
            showToast("Error generating log: Javascript failure", "error");
        }
    }

    // --- Custom & OnSite Logic ---
    function openCustomModal() { document.getElementById('customCheckModal').style.display = 'flex'; }
    function openOnSiteModal() { document.getElementById('onSiteModal').style.display = 'flex'; }
    async function submitCustomCheck() { await generateLog('custom'); }

    function onCategoryChange() {
        const sel = document.getElementById('custom-category');
        const selectedOption = sel.options[sel.selectedIndex];
        const desc = selectedOption.getAttribute('data-desc');
        if (desc) {
            document.getElementById('custom-message').value = desc;
        }
    }

    function openCategoryManageModal() {
        document.getElementById('categoryManageModal').style.display = 'flex';
        loadCategories();
    }

    function openCategoryEditModal(id = '', name = '', desc = '') {
        document.getElementById('cat-edit-title').textContent = id ? 'Edit Category' : 'Add Category';
        document.getElementById('cat-edit-id').value = id;
        document.getElementById('cat-edit-name').value = name;
        document.getElementById('cat-edit-desc').value = desc;
        document.getElementById('categoryEditModal').style.display = 'flex';
    }

    async function loadCategories() {
        const container = document.getElementById('category-list-container');
        container.innerHTML = '<div class="text-center text-gray-400 py-4">Loading...</div>';
        try {
            const res = await fetch('/api/log-check/categories');
            if (!res.ok) throw new Error("Failed to fetch");
            const data = await res.json();

            if (data.categories.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-400 py-4">No custom categories found.</div>';
                return;
            }

            container.innerHTML = data.categories.map(c => {
                const safeName = escapeHtml(c.name);
                const safeDesc = escapeHtml(c.description || '');
                // Correctly escape quotes for HTML attributes
                const attrName = safeName.replace(/'/g, "&#39;").replace(/"/g, "&quot;");
                const attrDesc = safeDesc.replace(/'/g, "&#39;").replace(/"/g, "&quot;");

                return `
                <div class="flex justify-between items-center bg-gray-800 p-3 rounded mb-2 border border-gray-700">
                    <div>
                        <div class="text-white font-bold">${safeName}</div>
                        <div class="text-gray-400 text-sm truncate max-w-xs">${safeDesc}</div>
                    </div>
                    <div class="flex gap-2">
                        <button class="btn btn-secondary btn-sm" onclick="openCategoryEditModal('${c.id}', '${attrName}', '${attrDesc}')">Edit</button>
                        <button class="btn btn-secondary btn-sm text-red-400 border-red-900" onclick="deleteCategory(${c.id})">Delete</button>
                    </div>
                </div>
                `;
            }).join('');

            // Also update the dropdown
            updateCategoryDropdown(data.categories);
        } catch (e) {
            container.innerHTML = '<div class="text-center text-red-400 py-4">Error loading categories.</div>';
        }
    }

    function updateCategoryDropdown(categories) {
        const sel = document.getElementById('custom-category');
        const currentVal = sel.value;
        sel.innerHTML = '<option value="Custom Check" data-desc="">Custom Check</option>';
        categories.forEach(c => {
            const opt = document.createElement('option');
            opt.value = c.name;
            opt.textContent = c.name;
            opt.setAttribute('data-desc', c.description || '');
            sel.appendChild(opt);
        });
        if ([...sel.options].some(o => o.value === currentVal)) {
            sel.value = currentVal;
        }
    }

    async function saveCategory() {
        const id = document.getElementById('cat-edit-id').value;
        const name = document.getElementById('cat-edit-name').value.trim();
        const description = document.getElementById('cat-edit-desc').value.trim();

        if (!name) {
            showToast("Name is required", "error");
            return;
        }

        const payload = { name, description };
        const method = id ? 'PUT' : 'POST';
        const url = id ? `/api/log-check/categories/${id}` : '/api/log-check/categories';

        try {
            const res = await fetch(url, {
                method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const data = await res.json();
            if (res.ok) {
                showToast(data.message || "Category saved!");
                closeModal('categoryEditModal');

                // Refresh manage list if open, otherwise just update dropdown directly
                if (document.getElementById('categoryManageModal').style.display === 'flex' || document.getElementById('categoryManageModal').style.display === 'block') {
                    loadCategories();
                } else {
                    updateSingleDropdownOption(data.name, description, id);
                }
            } else {
                showToast(data.detail || "Error saving category", "error");
            }
        } catch (e) {
            showToast("Network error", "error");
        }
    }

    function updateSingleDropdownOption(name, desc, isUpdate) {
        const sel = document.getElementById('custom-category');
        if (!isUpdate) {
            const opt = document.createElement('option');
            opt.value = name;
            opt.textContent = name;
            opt.setAttribute('data-desc', desc);
            sel.appendChild(opt);
            sel.value = name;
            onCategoryChange();
        } else {
            // Find and update
            const opt = [...sel.options].find(o => o.value === name); // name might have changed, ideally track by ID, but wait, options don't have ID here. If name changed it might break this optimistic update, so we just reload all.
            // A simple fetch of all categories is safer.
            fetch('/api/log-check/categories').then(r => r.json()).then(d => {
                updateCategoryDropdown(d.categories);
                sel.value = name;
                onCategoryChange();
            });
        }
    }

    async function deleteCategory(id) {
        if (!confirm("Are you sure you want to delete this category?")) return;
        try {
            const res = await fetch(`/api/log-check/categories/${id}`, { method: 'DELETE' });
            if (res.ok) {
                showToast("Category deleted");
                loadCategories(); // reload list
            } else {
                const data = await res.json();
                showToast(data.detail || "Error deleting", "error");
            }
        } catch (e) {
            showToast("Network error", "error");
        }
    }

    function escapeHtml(str) {
        const div = document.createElement('div');
        div.textContent = str;
        return div.innerHTML;
    }

    async function submitOnSite(msg) {
        // Reuse generateLog logic but inject message via special handling or just construct payload similarly
        // Since generateLog uses DOM for times, we can just call API directly here to be cleaner
        const payload = { check_type: 'onsite', mode: currentMode, message: msg };

        if (currentMode === 'automatic') {
            payload.hours = parseInt(document.getElementById('duration-hours').value) || 0;
            payload.minutes = parseInt(document.getElementById('duration-minutes').value) || 0;
        } else {
            payload.start_time = document.getElementById('start-time').value;
            payload.end_time = document.getElementById('end-time').value;
            payload.date_str = document.getElementById('log-date').value;
            if (!payload.start_time || !payload.end_time) { showToast("Enter times", "error"); return; }
        }

        try {
            const res = await fetch('/api/log-check/generate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const data = await res.json();
            document.getElementById('log-preview').value = data.full_entry;
            showToast("On-Site log generated!");
            closeModal('onSiteModal');
        } catch (e) { }
    }

    // --- Utilities ---
    new ClipboardJS('#btn-copy').on('success', (e) => {
        showToast("Copied to clipboard!");
        e.clearSelection();
    });

    function showToast(msg, type = 'success') {
        const toast = document.getElementById('status-toast');
        document.getElementById('toast-message').textContent = msg;
        toast.style.borderLeftColor = type === 'error' ? '#ef4444' : '#10b981';
        toast.classList.add('show');
        setTimeout(() => toast.classList.remove('show'), 3000);
    }

    document.getElementById('log-preview').addEventListener('input', function () {
        document.getElementById('char-count').textContent = this.value.length + " chars";
    });
</script>
{% endblock %}