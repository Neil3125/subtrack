{% extends "base.html" %}

{% block title %}Log Check Pro - SubTrack{% endblock %}

{% block extra_head %}
<!-- Flatpickr for date/time picking -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js"></script>

<!-- Pro Theme CSS -->
<link rel="stylesheet" href="/static/css/log_check_pro.css">

<script>
    // Apply Pro Theme class to body
    document.body.classList.add('log-check-pro');
</script>
{% endblock %}

{% block content %}
<div class="pro-container animate-enter">

    <!-- Header -->
    <header class="pro-header">
        <h1 class="pro-title">Log Check Pro</h1>
        <p class="pro-subtitle">System Maintenance & Tracking Console</p>
    </header>

    <!-- Main Glass Card -->
    <div class="glass-card">

        <!-- Clock Centerpiece -->
        <div class="clock-wrapper">
            <div class="pro-clock" id="clock">00:00:00</div>
            <div class="pro-date" id="date">Loading date...</div>
        </div>

        <!-- Mode Switcher -->
        <div style="text-align: center;">
            <div class="toggle-wrapper">
                <div class="toggle-option active" onclick="setMode('automatic')" id="mode-auto">Automatic</div>
                <div class="toggle-option" onclick="setMode('manual')" id="mode-manual">Manual</div>
            </div>
        </div>

        <!-- Automatic Controls -->
        <div id="controls-auto" class="pro-input-group">
            <span class="pro-label">Duration</span>
            <div class="flex items-center gap-2">
                <input type="number" id="duration-hours" class="pro-input" value="0" min="0">
                <span class="pro-label" style="font-size: 0.8rem;">HR</span>
            </div>
            <div class="flex items-center gap-2">
                <input type="number" id="duration-minutes" class="pro-input" value="30" min="0" step="5">
                <span class="pro-label" style="font-size: 0.8rem;">MIN</span>
            </div>
        </div>

        <!-- Manual Controls -->
        <div id="controls-manual" class="pro-input-group" style="display: none; flex-wrap: wrap;">
            <div class="flex flex-col items-center">
                <span class="pro-label mb-2">Start</span>
                <input type="text" id="start-time" class="pro-input" placeholder="10:00" onblur="formatTimeInput(this)"
                    style="width: 120px;">
            </div>
            <div class="flex flex-col items-center">
                <span class="pro-label mb-2">End</span>
                <input type="text" id="end-time" class="pro-input" placeholder="12:00" onblur="formatTimeInput(this)"
                    style="width: 120px;">
            </div>
            <div class="flex flex-col items-center">
                <span class="pro-label mb-2">Date</span>
                <input type="text" id="log-date" class="pro-input" placeholder="Today"
                    style="width: 160px; font-size: 1.2rem;">
            </div>
        </div>

        <!-- Action Grid -->
        <div class="action-grid">
            <!-- Service Check -->
            <div class="action-card card-service" onclick="generateLog('service')">
                <div class="action-icon">üîß</div>
                <div class="action-label">Service Check</div>
                <div class="text-xs text-secondary">Routine Maintenance</div>
            </div>

            <!-- Backup Check -->
            <div class="action-card card-backup" onclick="generateLog('backup')">
                <div class="action-icon">üíæ</div>
                <div class="action-label">Backup Check</div>
                <div class="text-xs text-secondary">Data Integrity Verification</div>
            </div>

            <!-- On-Site -->
            <div class="action-card card-onsite" onclick="openOnSiteModal()">
                <div class="action-icon">üöó</div>
                <div class="action-label">On-Site</div>
                <div class="text-xs text-secondary">Field Support Visit</div>
            </div>

            <!-- Custom -->
            <div class="action-card card-custom" onclick="openCustomModal()">
                <div class="action-icon">üìù</div>
                <div class="action-label">Custom Entry</div>
                <div class="text-xs text-secondary">Specific Log Details</div>
            </div>
        </div>

        <!-- Preview Area -->
        <div class="mt-8">
            <div class="flex justify-between items-end mb-2">
                <span class="pro-label">Log Preview</span>
                <span class="text-xs text-secondary" id="char-count">0 chars</span>
            </div>
            <textarea id="log-preview" class="pro-preview" readonly>Ready to generate log...</textarea>

            <div class="pro-footer">
                <a href="/log-check/history" class="btn btn-secondary btn-sm"
                    style="background: rgba(255,255,255,0.1); border: none;">
                    üìö History
                </a>
                <button class="btn btn-primary" id="btn-copy" data-clipboard-target="#log-preview">
                    üìã Copy to Clipboard
                </button>
            </div>
        </div>

    </div>
</div>

<!-- Modals (Re-using standard styles but wrapped slightly for theme consistency) -->
<!-- Custom Check Modal -->
<div id="customCheckModal" class="modal" style="display: none;">
    <div class="modal-content glass-card" style="max-width: 500px; padding: 24px; background: #1e293b;">
        <div class="modal-header">
            <h2 class="modal-title text-white">Custom Check</h2>
            <button class="modal-close text-white" onclick="closeModal('customCheckModal')">√ó</button>
        </div>
        <div class="modal-body">
            <div class="form-group mb-4">
                <label class="form-label text-gray-300">Category</label>
                <div class="flex gap-2">
                    <select class="form-select flex-1 bg-gray-800 text-white border-gray-600" id="custom-category">
                        <option value="Custom Check">Custom Check</option>
                        {% for cat in check_categories %}
                        <option value="{{ cat.name }}">{{ cat.name }}</option>
                        {% endfor %}
                    </select>
                    <button class="btn btn-secondary" onclick="promptNewCategory()">+</button>
                </div>
            </div>
            <div class="form-group">
                <label class="form-label text-gray-300">Log Message</label>
                <textarea class="form-textarea bg-gray-800 text-white border-gray-600" id="custom-message"
                    rows="4"></textarea>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('customCheckModal')">Cancel</button>
            <button class="btn btn-primary" onclick="submitCustomCheck()">Generate Log</button>
        </div>
    </div>
</div>

<!-- On-Site Modal -->
<div id="onSiteModal" class="modal" style="display: none;">
    <div class="modal-content glass-card" style="max-width: 500px; padding: 24px; background: #1e293b;">
        <div class="modal-header">
            <h2 class="modal-title text-white">On-Site Check</h2>
            <button class="modal-close text-white" onclick="closeModal('onSiteModal')">√ó</button>
        </div>
        <div class="modal-body">
            <div class="grid gap-3">
                {% for option in onsite_options %}
                <button
                    class="card p-3 text-left hover:bg-gray-700 transition-colors bg-gray-800 text-white border-gray-600"
                    onclick="submitOnSite('{{ option }}')">
                    {{ option }}
                </button>
                {% endfor %}
                <button
                    class="card p-3 text-left hover:bg-gray-700 transition-colors font-bold text-blue-400 bg-gray-800 border-gray-600"
                    onclick="submitOnSite('On-site support provided.')">
                    Default (Support Provided)
                </button>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('onSiteModal')">Cancel</button>
        </div>
    </div>
</div>

<!-- Status Toast -->
<div id="status-toast" class="status-toast">
    <span class="text-xl">‚úÖ</span>
    <span id="toast-message">Action successful</span>
</div>

<script>
    // --- Clock ---
    function updateClock() {
        const now = new Date();
        document.getElementById('clock').textContent = now.toLocaleTimeString();
        document.getElementById('date').textContent = now.toLocaleDateString(undefined, { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
    }
    setInterval(updateClock, 1000);
    updateClock();

    // --- Mode Switching ---
    let currentMode = 'automatic';
    function setMode(mode) {
        currentMode = mode;
        document.getElementById('mode-auto').classList.toggle('active', mode === 'automatic');
        document.getElementById('mode-manual').classList.toggle('active', mode === 'manual');
        document.getElementById('controls-auto').style.display = mode === 'automatic' ? 'flex' : 'none';

        // Manual controls layout is tricky, use flex/none
        const manualControls = document.getElementById('controls-manual');
        if (mode === 'manual') {
            manualControls.style.display = 'flex';
            initManualInputs();
        } else {
            manualControls.style.display = 'none';
        }
    }

    function initManualInputs() {
        if (!document.getElementById('log-date')._flatpickr) {
            flatpickr("#log-date", {
                dateFormat: "m/d/Y",
                defaultDate: "today",
                theme: "dark"
            });
        }
    }

    // --- Smart Time Formatting ---
    function formatTimeInput(input) {
        let val = input.value.trim();
        if (!val) return;
        if (val.length >= 3 && val.length <= 4 && !val.includes(':') && /^\d+$/.test(val)) {
            if (val.length == 3) {
                input.value = val.substring(0, 1) + ":" + val.substring(1);
            } else {
                input.value = val.substring(0, 2) + ":" + val.substring(2);
            }
        }
    }

    // --- Log Generation ---
    async function generateLog(type) {
        const payload = { check_type: type, mode: currentMode };

        if (currentMode === 'automatic') {
            payload.hours = parseInt(document.getElementById('duration-hours').value) || 0;
            payload.minutes = parseInt(document.getElementById('duration-minutes').value) || 0;
        } else {
            const startTime = document.getElementById('start-time').value;
            const endTime = document.getElementById('end-time').value;
            if (!startTime || !endTime) { showToast("Enter start/end times", "error"); return; }
            payload.start_time = startTime;
            payload.end_time = endTime;
            payload.date_str = document.getElementById('log-date').value;
        }

        if (type === 'custom') {
            payload.message = document.getElementById('custom-message').value;
            payload.category_name = document.getElementById('custom-category').value;
        }

        try {
            const response = await fetch('/api/log-check/generate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const data = await response.json();

            // Simulating typing effect for preview? No, just set it.
            const preview = document.getElementById('log-preview');
            preview.value = data.full_entry;
            // Flash effect
            preview.style.borderColor = 'var(--color-accent-green)';
            setTimeout(() => preview.style.borderColor = 'var(--color-glass-border)', 300);

            showToast("Log generated successfully!");
            if (type === 'custom') closeModal('customCheckModal');
            if (type === 'onsite') closeModal('onSiteModal');
        } catch (e) {
            showToast("Error generating log", "error");
        }
    }

    // --- Custom & OnSite Logic ---
    function openCustomModal() { document.getElementById('customCheckModal').style.display = 'flex'; }
    function openOnSiteModal() { document.getElementById('onSiteModal').style.display = 'flex'; }
    async function submitCustomCheck() { await generateLog('custom'); }

    async function promptNewCategory() {
        const name = prompt("New Category Name:");
        if (name) {
            try {
                const res = await fetch('/api/log-check/categories', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name })
                });
                if (res.ok) {
                    const data = await res.json();
                    const sel = document.getElementById('custom-category');
                    sel.add(new Option(data.name, data.name));
                    sel.value = data.name;
                    showToast("Category added!");
                }
            } catch (e) { }
        }
    }

    async function submitOnSite(msg) {
        // Reuse generateLog logic but inject message via special handling or just construct payload similarly
        // Since generateLog uses DOM for times, we can just call API directly here to be cleaner
        const payload = { check_type: 'onsite', mode: currentMode, message: msg };

        if (currentMode === 'automatic') {
            payload.hours = parseInt(document.getElementById('duration-hours').value) || 0;
            payload.minutes = parseInt(document.getElementById('duration-minutes').value) || 0;
        } else {
            payload.start_time = document.getElementById('start-time').value;
            payload.end_time = document.getElementById('end-time').value;
            payload.date_str = document.getElementById('log-date').value;
            if (!payload.start_time || !payload.end_time) { showToast("Enter times", "error"); return; }
        }

        try {
            const res = await fetch('/api/log-check/generate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const data = await res.json();
            document.getElementById('log-preview').value = data.full_entry;
            showToast("On-Site log generated!");
            closeModal('onSiteModal');
        } catch (e) { }
    }

    // --- Utilities ---
    new ClipboardJS('#btn-copy').on('success', (e) => {
        showToast("Copied to clipboard!");
        e.clearSelection();
    });

    function showToast(msg, type = 'success') {
        const toast = document.getElementById('status-toast');
        document.getElementById('toast-message').textContent = msg;
        toast.style.borderLeftColor = type === 'error' ? '#ef4444' : '#10b981';
        toast.classList.add('show');
        setTimeout(() => toast.classList.remove('show'), 3000);
    }

    document.getElementById('log-preview').addEventListener('input', function () {
        document.getElementById('char-count').textContent = this.value.length + " chars";
    });
</script>
{% endblock %}