{% extends "base.html" %}

{% block content %}
<div class="calendar-container">
    <!-- Calendar Header -->
    <div class="calendar-header" style="padding: 20px 0;"> <!-- Increased padding -->
        <div class="header-left">
            <h1 id="currentMonthYear">January 2026</h1>
            <div class="calendar-controls">
                <button id="prevMonth" class="btn btn-icon-cal" title="Previous Month">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="m15 18-6-6 6-6" />
                    </svg>
                </button>
                <button id="todayBtn" class="btn btn-sm"
                    style="background: var(--color-bg-tertiary); font-weight: 600;">Today</button>
                <button id="nextMonth" class="btn btn-icon-cal" title="Next Month">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="m9 18 6-6-6-6" />
                    </svg>
                </button>
            </div>
        </div>
        <div class="header-right">
            <!-- Legend / Filters could go here -->
            <div class="legend-item">
                <span class="dot renewal"></span> Renewal
            </div>
            <button id="addSubscriptionBtn" class="btn btn-primary">
                <i class="fas fa-plus"></i> Add Subscription
            </button>
        </div>
    </div>

    <!-- Days of Week -->
    <div class="calendar-grid-header">
        <div class="day-name">Sun</div>
        <div class="day-name">Mon</div>
        <div class="day-name">Tue</div>
        <div class="day-name">Wed</div>
        <div class="day-name">Thu</div>
        <div class="day-name">Fri</div>
        <div class="day-name">Sat</div>
    </div>

    <!-- Calendar Grid -->
    <div id="calendarGrid" class="calendar-grid">
        <!-- Generated by JS -->
    </div>
</div>

<!-- Day Detail Modal (Day Summary Card) -->
<div id="dayModal" class="modal" style="align-items: center; justify-content: center; backdrop-filter: blur(4px);">
    <div class="modal-content"
        style="max-width: 480px; border-radius: 16px; overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.5);">
        <div class="modal-header"
            style="display: flex; justify-content: space-between; align-items: center; padding: 24px; background: var(--color-bg-secondary); border-bottom: 1px solid var(--color-border);">
            <div>
                <h2 id="modalDateTitle" style="margin: 0; font-size: 1.25rem;">Date</h2>
                <span id="modalDaySubtitle" style="color: var(--text-secondary); font-size: 0.875rem;">Summary</span>
            </div>
            <button class="close-modal"
                style="background: none; border: none; font-size: 1.5rem; color: var(--text-secondary); cursor: pointer;">&times;</button>
        </div>
        <div class="modal-body" style="padding: 0; max-height: 50vh; overflow-y: auto;">
            <div id="dayEventsList" class="day-events-list" style="padding: 24px; gap: 16px;">
                <!-- Events populated here -->
            </div>
            <div id="emptyStateMessage" style="display: none; padding: 40px 20px; text-align: center;">
                <div style="font-size: 3rem; margin-bottom: 16px;">‚ú®</div>
                <h3 style="font-size: 1rem; color: var(--text-primary); margin-bottom: 8px;">You're all clear today!
                </h3>
                <p style="color: var(--text-secondary); font-size: 0.875rem;">No subscriptions renewing on this day.</p>
            </div>
        </div>
        <div class="modal-footer"
            style="padding: 16px 24px; border-top: 1px solid var(--color-border); background: var(--color-bg);">
            <button id="addEventOnDayBtn" class="btn btn-primary btn-full-width" style="width: 100%;">
                <i class="fas fa-plus"></i> Add New Subscription
            </button>
        </div>
    </div>
</div>

<!-- Add Subscription Modal (Reused or new specific one) -->
<!-- We will trigger the main subscription modal but pre-fill date -->

<style>
    /* Monday.com-inspired Calendar Styles */
    :root {
        --grid-border: #e6e9ef;
        --cell-bg: #ffffff;
        --cell-hover: #f5f6f8;
        --text-primary: #323338;
        --text-secondary: #676879;
        --primary-color: #0073ea;
        --btn-hover-bg: #dcdfec;
    }

    [data-theme="dark"] {
        --grid-border: #24262b;
        --cell-bg: #111111;
        --cell-hover: #1f2125;
        --text-primary: #e6e6e6;
        --text-secondary: #b0b1b8;
        --primary-color: #579dff;
        --btn-hover-bg: #2c2e33;
    }

    .calendar-container {
        display: flex;
        flex-direction: column;
        height: calc(100vh - 80px);
        /* Adjust based on navbar height */
        padding: 24px;
        background-color: var(--color-bg);
        overflow: hidden;
    }

    .calendar-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
        border-bottom: 1px solid transparent;
        /* Alignment fix */
    }

    .header-left {
        display: flex;
        align-items: center;
        gap: 24px;
    }

    .header-left h1 {
        font-size: 24px;
        font-weight: 600;
        color: var(--text-primary);
        margin: 0;
        min-width: 220px;
        line-height: 1;
        /* Fix vertical alignment */
    }

    .calendar-controls {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .btn-icon-cal {
        background: transparent;
        border: 1px solid var(--grid-border);
        color: var(--text-primary);
        width: 32px;
        height: 32px;
        border-radius: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s;
    }

    .btn-icon-cal:hover {
        background-color: var(--btn-hover-bg);
        border-color: var(--primary-color);
        color: var(--primary-color);
    }

    .header-right {
        display: flex;
        align-items: center;
        gap: 16px;
    }

    /* Grid Header */
    .calendar-grid-header {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        padding-bottom: 12px;
        border-bottom: 1px solid var(--grid-border);
    }

    .day-name {
        text-align: center;
        font-weight: 500;
        color: var(--text-secondary);
        font-size: 14px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    /* Grid Body */
    .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        grid-template-rows: repeat(auto-fill, minmax(100px, 1fr));
        /* Fill remaining space */
        flex-grow: 1;
        background-color: var(--grid-border);
        /* Gap color */
        gap: 1px;
        border: 1px solid var(--grid-border);
        border-radius: 0 0 12px 12px;
        overflow-y: auto;
    }

    .calendar-cell {
        background-color: var(--cell-bg);
        padding: 8px;
        min-height: 120px;
        cursor: pointer;
        transition: background-color 0.2s;
        display: flex;
        flex-direction: column;
        gap: 4px;
        position: relative;
    }

    .calendar-cell:hover {
        background-color: var(--cell-hover);
        z-index: 1;
    }

    .calendar-cell.other-month {
        background-color: var(--color-bg-secondary, #fafafa);
        opacity: 0.5;
    }

    [data-theme="dark"] .calendar-cell.other-month {
        background-color: #000000;
    }

    .calendar-cell.today {
        background-color: rgba(0, 115, 234, 0.05);
    }

    [data-theme="dark"] .calendar-cell.today {
        background-color: rgba(87, 157, 255, 0.1);
    }

    .cell-date {
        font-weight: 500;
        font-size: 14px;
        margin-bottom: 4px;
        color: var(--text-secondary);
        width: 26px;
        height: 26px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
    }

    .calendar-cell.today .cell-date {
        background-color: var(--primary-color);
        color: white;
        font-weight: 600;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    /* Events Pills & Pastel Colors */
    .event-pill {
        display: flex;
        align-items: center;
        padding: 6px 8px;
        border-radius: 6px;
        font-size: 12px;
        font-weight: 600;
        margin-bottom: 3px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        transition: all 0.2s cubic-bezier(0.25, 0.8, 0.25, 1);
        border-left: 3px solid transparent;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
    }

    /* Subtle Pastel Themes */
    .pill-color-0 {
        background: #e8ecfc;
        color: #3b5fc0;
        border-color: #3b5fc0;
    }

    /* Blue/Purple */
    .pill-color-1 {
        background: #e2f7e7;
        color: #007f36;
        border-color: #007f36;
    }

    /* Green */
    .pill-color-2 {
        background: #fff0db;
        color: #c07b00;
        border-color: #c07b00;
    }

    /* Orange */
    .pill-color-3 {
        background: #ffe6e6;
        color: #d93025;
        border-color: #d93025;
    }

    /* Red */
    .pill-color-4 {
        background: #f3e5f5;
        color: #8e24aa;
        border-color: #8e24aa;
    }

    /* Purple */
    .pill-color-5 {
        background: #e0f7fa;
        color: #00838f;
        border-color: #00838f;
    }

    /* Cyan */

    /* Dark Mode Pill Overrides (Slightly darker backgrounds, lighter text) */
    [data-theme="dark"] .pill-color-0 {
        background: rgba(59, 95, 192, 0.2);
        color: #8faefc;
    }

    [data-theme="dark"] .pill-color-1 {
        background: rgba(0, 127, 54, 0.2);
        color: #66e3a0;
    }

    [data-theme="dark"] .pill-color-2 {
        background: rgba(192, 123, 0, 0.2);
        color: #ffca6e;
    }

    [data-theme="dark"] .pill-color-3 {
        background: rgba(217, 48, 37, 0.2);
        color: #fa8e87;
    }

    [data-theme="dark"] .pill-color-4 {
        background: rgba(142, 36, 170, 0.2);
        color: #e1bee7;
    }

    [data-theme="dark"] .pill-color-5 {
        background: rgba(0, 131, 143, 0.2);
        color: #80deea;
    }

    .event-pill:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        z-index: 10;
        position: relative;
    }

    /* Modal Tweaks - Side Drawer / Centered Card */
    #dayModal .modal-content {
        max-width: 400px;
        border-radius: 16px;
        border: 1px solid var(--grid-border);
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        padding: 0;
        overflow: hidden;
    }

    .modal-header {
        padding: 20px 24px;
        border-bottom: 1px solid var(--grid-border);
        background: var(--color-bg-secondary, #fafafa);
    }

    [data-theme="dark"] .modal-header {
        background: #1a1c20;
    }

    .modal-body {
        padding: 24px;
    }

    .day-events-list {
        display: flex;
        flex-direction: column;
        gap: 12px;
        max-height: 400px;
        overflow-y: auto;
    }

    .event-item-card {
        padding: 16px;
        border: 1px solid var(--grid-border);
        border-radius: 12px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: var(--cell-bg);
        transition: transform 0.2s;
    }

    .event-item-card:hover {
        border-color: var(--primary-color);
        background-color: var(--cell-hover);
    }

    .event-item-info h4 {
        margin: 0 0 6px 0;
        font-size: 16px;
        font-weight: 600;
        color: var(--text-primary);
    }

    .event-item-meta {
        font-size: 13px;
        color: var(--text-secondary);
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        let currentDate = new Date();
        let currentEvents = [];

        const grid = document.getElementById('calendarGrid');
        const monthLabel = document.getElementById('currentMonthYear');
        const dayModal = document.getElementById('dayModal');
        const modalDateTitle = document.getElementById('modalDateTitle');
        const dayEventsList = document.getElementById('dayEventsList');
        const addEventOnDayBtn = document.getElementById('addEventOnDayBtn');

        // Initial Render
        fetchEventsAndRender();

        // Controls
        document.getElementById('prevMonth').addEventListener('click', () => {
            currentDate.setMonth(currentDate.getMonth() - 1);
            fetchEventsAndRender();
        });

        document.getElementById('nextMonth').addEventListener('click', () => {
            currentDate.setMonth(currentDate.getMonth() + 1);
            fetchEventsAndRender();
        });

        document.getElementById('todayBtn').addEventListener('click', () => {
            currentDate = new Date();
            fetchEventsAndRender();
        });

        // Add Subscription Button (Global)
        document.getElementById('addSubscriptionBtn').addEventListener('click', () => {
            if (typeof openModal === 'function') {
                openModal('subscriptionModal');
            } else {
                console.error("openModal function not found");
            }
        });

        async function fetchEventsAndRender() {
            // Determine date range for current view (start of first week to end of last week)
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();

            // First day of month
            const firstDayOfMonth = new Date(year, month, 1);
            // Starting day of calendar grid (Sunday before first day)
            const startGridDate = new Date(firstDayOfMonth);
            startGridDate.setDate(1 - startGridDate.getDay());

            // Last day of month
            const lastDayOfMonth = new Date(year, month + 1, 0);
            // End day of calendar grid (Saturday after last day)
            const endGridDate = new Date(lastDayOfMonth);
            endGridDate.setDate(lastDayOfMonth.getDate() + (6 - lastDayOfMonth.getDay()));

            // Format for API: YYYY-MM-DD
            const startStr = startGridDate.toISOString().split('T')[0];
            const endStr = endGridDate.toISOString().split('T')[0];

            // Update Header
            const monthName = currentDate.toLocaleString('default', { month: 'long' });
            monthLabel.textContent = `${monthName} ${year}`;

            try {
                // Fetch subscriptions with active status within range
                // Note: The backend filters by next_renewal_date. 
                // We use status=active to show relevant renewals.
                const response = await fetch(`/api/subscriptions?status=active&start_date=${startStr}&end_date=${endStr}`);
                if (!response.ok) throw new Error('Failed to fetch events');
                const subscriptions = await response.json();

                currentEvents = subscriptions;
                renderGrid(startGridDate, endGridDate, subscriptions);
            } catch (error) {
                console.error("Error fetching calendar events:", error);
                // Render empty grid on error
                renderGrid(startGridDate, endGridDate, []);
            }
        }

        function renderGrid(startDate, endDate, subscriptions) {
            grid.innerHTML = '';

            const iteratorDate = new Date(startDate);
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            while (iteratorDate <= endDate) {
                const cell = document.createElement('div');
                cell.className = 'calendar-cell';

                // Styles for other month
                if (iteratorDate.getMonth() !== currentDate.getMonth()) {
                    cell.classList.add('other-month');
                }

                // Today highlight
                if (iteratorDate.getTime() === today.getTime()) {
                    cell.classList.add('today');
                }

                // Date Number
                const dateNum = document.createElement('span');
                dateNum.className = 'cell-date';
                dateNum.textContent = iteratorDate.getDate();
                cell.appendChild(dateNum);

                // Find events for this day
                // Match iteratorDate (YYYY-MM-DD) with sub.next_renewal_date
                const iterDateStr = iteratorDate.toISOString().split('T')[0];
                const daysEvents = subscriptions.filter(sub => sub.next_renewal_date === iterDateStr);

                // Render Pills
                daysEvents.forEach(sub => {
                    const pill = document.createElement('div');
                    // Pastel Color Logic: Use category_id or hash of name
                    const colorIndex = (sub.category_id || 0) % 6;
                    pill.className = `event-pill pill-color-${colorIndex}`;

                    // Add icon if available (todo: map categories to icons)

                    // Text
                    pill.textContent = `${sub.vendor_name} (${sub.currency} ${sub.cost})`;
                    pill.title = `${sub.vendor_name} - Renewal`;

                    cell.appendChild(pill);
                });

                // Click event
                const dateForClick = new Date(iteratorDate); // Closure capture
                cell.onclick = () => openDayModal(dateForClick, daysEvents);

                grid.appendChild(cell);

                // Increment day
                iteratorDate.setDate(iteratorDate.getDate() + 1);
            }
        }

        function openDayModal(date, events) {
            const dateStr = date.toLocaleDateString('default', { weekday: 'long', month: 'long', day: 'numeric' });
            modalDateTitle.textContent = dateStr;
            const daySubtitle = document.getElementById('modalDaySubtitle');
            if (daySubtitle) daySubtitle.textContent = `${events.length} Subscription${events.length !== 1 ? 's' : ''}`;

            dayEventsList.innerHTML = '';
            const emptyState = document.getElementById('emptyStateMessage');

            if (events.length === 0) {
                dayEventsList.style.display = 'none';
                if (emptyState) emptyState.style.display = 'block';
            } else {
                dayEventsList.style.display = 'flex'; // Flex column
                dayEventsList.style.flexDirection = 'column';
                if (emptyState) emptyState.style.display = 'none';

                events.forEach(sub => {
                    const el = document.createElement('div');
                    el.className = 'event-item-card';
                    // Inline styles for the card
                    el.style.display = 'flex';
                    el.style.justifyContent = 'space-between';
                    el.style.alignItems = 'center';
                    el.style.padding = '16px';
                    el.style.background = 'var(--color-bg)';
                    el.style.border = '1px solid var(--color-border)';
                    el.style.borderRadius = '12px';
                    el.style.marginBottom = '0'; // Controlled by gap

                    // Logo Placeholder (Gradient Circle)
                    const logoColor = `var(--pill-color-${(sub.category_id || 0) % 6}, #7A9BFF)`;
                    const logoBg = `rgba(122, 155, 255, 0.12)`; // Fallback or dynamic

                    el.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 16px;">
                            <div style="width: 40px; height: 40px; border-radius: 50%; background: var(--color-bg-tertiary); display: flex; align-items: center; justify-content: center; font-size: 1.2rem;">
                                üìù
                            </div>
                            <div>
                                <h4 style="margin: 0; font-size: 1rem; font-weight: 600; color: var(--text-primary);">${sub.vendor_name}</h4>
                                <div style="font-size: 0.875rem; color: var(--text-secondary); margin-top: 2px;">
                                    ${sub.currency} ${sub.cost} ‚Ä¢ ${sub.billing_cycle}
                                </div>
                            </div>
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <button class="btn btn-icon-only btn-sm btn-outline edit-sub-btn" data-id="${sub.id}" title="Edit" style="border: 1px solid var(--color-border); color: var(--text-secondary);">
                                <i class="fas fa-pencil-alt">‚úèÔ∏è</i>
                            </button>
                             <button class="btn btn-icon-only btn-sm btn-outline delete-sub-btn" data-id="${sub.id}" title="Delete" style="border: 1px solid var(--color-border); color: var(--color-danger);">
                                <i class="fas fa-trash">üóëÔ∏è</i>
                            </button>
                        </div>
                    `;
                    dayEventsList.appendChild(el);

                    // Attach edit handler
                    el.querySelector('.edit-sub-btn').addEventListener('click', (e) => {
                        e.stopPropagation();
                        if (typeof openEditModal === 'function') {
                            openEditModal(sub.id);
                            dayModal.style.display = 'none';
                        }
                    });

                    // Attach delete handler (Mock or Real)
                    el.querySelector('.delete-sub-btn').addEventListener('click', (e) => {
                        e.stopPropagation();
                        if (confirm('Are you sure you want to delete this subscription?')) {
                            // Call delete API
                            fetch(`/api/subscriptions/${sub.id}`, { method: 'DELETE' })
                                .then(res => {
                                    if (res.ok) {
                                        el.remove();
                                        // Update summary count if needed, or close if empty
                                        fetchEventsAndRender(); // Refresh grid
                                        if (dayEventsList.children.length === 0) {
                                            dayEventsList.style.display = 'none';
                                            if (emptyState) emptyState.style.display = 'block';
                                        }
                                    }
                                });
                        }
                    });
                });
            }

            // "Add Subscription" for this specific date
            addEventOnDayBtn.onclick = () => {
                if (typeof openModal === 'function') {
                    openModal('subscriptionModal');
                    dayModal.style.display = 'none';

                    // Attempt to pre-fill date
                    setTimeout(() => {
                        const startDateInput = document.querySelector('[name="start_date"]');
                        if (startDateInput) {
                            startDateInput.value = date.toISOString().split('T')[0];
                        }
                    }, 100);
                }
            };

            dayModal.style.display = 'flex'; // Changed to flex for centering
        }

        // Modal Close Logic
        const closeBtns = document.querySelectorAll('.close-modal');
        closeBtns.forEach(btn => btn.addEventListener('click', () => {
            dayModal.style.display = 'none';
        }));

        window.onclick = function (event) {
            if (event.target == dayModal) {
                dayModal.style.display = "none";
            }
        }
    });
</script>
{% endblock %}