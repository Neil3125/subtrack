{% extends "base.html" %}

{% block extra_head %}
<!-- FullCalendar CSS -->
<link rel="stylesheet" href="/static/css/calendar.css">
<!-- FullCalendar JS (CDN for stability) -->
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>
{% endblock %}

{% block content %}
<div class="calendar-wrapper">
    <!-- Top Control Bar (Search, Total, Action) -->
    <div
        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; flex-wrap: wrap; gap: 12px;">
        <div style="display: flex; align-items: center; gap: 16px;">
            <!-- Month Total Badge -->
            <div id="viewTotalBadge"
                style="background: var(--color-bg-secondary); padding: 8px 16px; border-radius: 20px; font-size: 0.95rem; font-weight: 600; color: var(--text-secondary); border: 1px solid var(--grid-border); display: flex; align-items: center; gap: 8px;">
                <span>View Total:</span>
                <span id="viewTotalAmount" style="color: var(--text-primary); font-size: 1.1rem;">$0.00</span>
            </div>
        </div>

        <div style="display: flex; gap: 12px; align-items: center;">
            <!-- Custom Search (External to FC) -->
            <div class="search-wrapper" style="position: relative;">
                <span
                    style="position: absolute; left: 10px; top: 50%; transform: translateY(-50%); color: var(--text-secondary);">üîç</span>
                <input type="text" id="calendarSearchInput" placeholder="Filter events..."
                    style="padding: 8px 8px 8px 32px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--color-bg); color: var(--text-primary); width: 200px;">
            </div>

            <button id="addSubscriptionBtn" class="btn btn-primary" onclick="openModal('subscriptionModal')">
                <span>+</span> Add New
            </button>
        </div>
    </div>

    <!-- The Calendar -->
    <div id='calendar'></div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        var calendarEl = document.getElementById('calendar');

        var calendar = new FullCalendar.Calendar(calendarEl, {
            themeSystem: 'standard',
            initialView: 'dayGridMonth',
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,timeGridWeek,timeGridDay,listMonth'
            },
            navLinks: true,
            editable: true,
            dayMaxEvents: true, // Allow "more" link
            height: '100%',

            // Interaction Handlers
            selectable: true,

            // Event Data
            events: async function (fetchInfo, successCallback, failureCallback) {
                try {
                    const response = await fetch(`/api/subscriptions?status=active&start_date=${fetchInfo.startStr}&end_date=${fetchInfo.endStr}`);
                    if (!response.ok) throw new Error('Network response was not ok');
                    const subs = await response.json();

                    let events = [];
                    const viewStart = new Date(fetchInfo.start);
                    const viewEnd = new Date(fetchInfo.end);

                    subs.forEach(sub => {
                        let evtDate = new Date(sub.next_renewal_date);

                        // Base Event
                        if (evtDate >= viewStart && evtDate < viewEnd) {
                            events.push(createEventObj(sub, evtDate));
                        }

                        // Project Recurrences for View Range
                        let nextDate = new Date(evtDate);
                        let safety = 0;
                        while (nextDate < viewEnd && safety < 24) {
                            if (sub.billing_cycle === 'monthly') nextDate.setMonth(nextDate.getMonth() + 1);
                            else if (sub.billing_cycle === 'weekly') nextDate.setDate(nextDate.getDate() + 7);
                            else if (sub.billing_cycle === 'quarterly') nextDate.setMonth(nextDate.getMonth() + 3);
                            else if (sub.billing_cycle === 'yearly') nextDate.setFullYear(nextDate.getFullYear() + 1);
                            else break;

                            if (nextDate >= viewStart && nextDate < viewEnd) {
                                events.push(createEventObj(sub, nextDate, true));
                            }
                            safety++;
                        }
                    });
                    successCallback(events);
                } catch (error) {
                    console.error(error);
                    failureCallback(error);
                }
            },

            // --- Hooks ---

            // 1. Calculate Total on View Change
            datesSet: function (info) {
                recalculateTotal();
            },

            // 2. Event Click -> Side Panel (Details)
            eventClick: function (info) {
                info.jsEvent.preventDefault();
                showEventDetailsInPanel(info.event);
            },

            // 3. Date Click -> Side Panel (Day Overview)
            dateClick: function (info) {
                showDayOverviewInPanel(info.date);
            },

            // 4. Custom "More" Link -> Side Panel instead of Popover
            moreLinkClick: function (info) {
                // FullCalendar 6 doesn't easily allow cancelling the popover via return false in some versions,
                // but we can try handling it ourselves.
                showDayOverviewInPanel(info.date);
                return "function"; // Suppress default popover if supported, or just let it open and we override? 
                // Actually, `moreLinkClick` can take a function.
            },

            // 5. Context Menu (Right Click)
            eventDidMount: function (info) {
                info.el.title = `${info.event.title} - ${info.event.extendedProps.currency} ${info.event.extendedProps.costDisplay}`;

                info.el.addEventListener('contextmenu', function (e) {
                    e.preventDefault();
                    // Basic Context Menu Logic (could be improved with a real UI lib)
                    // For now, let's open the panel in "Edit Mode" directly or show a simple browser alert?
                    // Better: Open the panel with actions highlighted.
                    showEventDetailsInPanel(info.event);
                });
            },

            eventDrop: function (info) {
                if (!confirm(`Move ${info.event.title} to ${info.event.start.toLocaleDateString()}?`)) {
                    info.revert();
                } else {
                    // TODO: Implement date update API call
                    console.log("Moved", info.event.title);
                }
            }
        });

        calendar.render();

        // --- Helpers ---

        function createEventObj(sub, dateObj, isProjected = false) {
            const catId = sub.category_id || 0;
            // original sub data for the panel
            return {
                id: isProjected ? `proj-${sub.id}-${dateObj.getTime()}` : `${sub.id}`,
                title: sub.vendor_name,
                start: dateObj.toISOString().split('T')[0],
                allDay: true,
                classNames: [`event-pastel-${catId % 6}`],
                extendedProps: {
                    originalId: sub.id,
                    costDisplay: sub.cost,
                    currency: sub.currency,
                    billingCycle: sub.billing_cycle,
                    status: sub.status,
                    categoryName: sub.category ? sub.category.name : 'Uncategorized',
                    isProjected: isProjected,
                    // Store full subject for simplicity
                    fullData: sub
                }
            };
        }

        // --- View Total Logic ---
        function recalculateTotal() {
            const view = calendar.view;
            const events = calendar.getEvents();
            let total = 0;
            let currency = 'USD'; // default

            events.forEach(evt => {
                // strict range check
                if (evt.start >= view.currentStart && evt.start < view.currentEnd) {
                    // Check if visible (search filter)
                    if (evt.display !== 'none') {
                        total += parseFloat(evt.extendedProps.costDisplay) || 0;
                        if (evt.extendedProps.currency) currency = evt.extendedProps.currency;
                    }
                }
            });

            const badge = document.getElementById('viewTotalAmount');
            // Format currency
            const formatter = new Intl.NumberFormat('en-US', { style: 'currency', currency: currency });
            badge.textContent = formatter.format(total);
        }

        // --- Side Panel Interactions ---

        function showEventDetailsInPanel(event) {
            const props = event.extendedProps;
            const sub = props.fullData;

            // Build HTML
            let html = `
                <div class="panel-section">
                    ${window.renderSidePanelKeyValue('Vendor', event.title, true)}
                    ${window.renderSidePanelKeyValue('Cost', `${props.currency} ${props.costDisplay} / ${props.billingCycle}`)}
                    ${window.renderSidePanelKeyValue('Status', `<span class="badge badge-${props.status === 'active' ? 'success' : 'secondary'}">${props.status}</span>`)}
                    ${window.renderSidePanelKeyValue('Category', props.categoryName)}
                    ${window.renderSidePanelKeyValue('Due Date', event.start.toLocaleDateString(undefined, { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }))}
                    
                    ${props.isProjected ? '<div class="alert alert-info" style="margin-top: 20px;">‚ÑπÔ∏è This is a projected future occurrence.</div>' : ''}
                </div>
            `;

            // Open Panel
            window.openSidePanel(html, 'Subscription Details');

            // Set Edit Action
            window.setSidePanelEditAction(() => {
                if (typeof loadEditData === 'function') {
                    // Close panel and open modal
                    window.closeSidePanel();
                    window.loadEditData('subscription', props.originalId);
                }
            });
        }

        function showDayOverviewInPanel(date) {
            const dateStr = date.toISOString().split('T')[0];
            const events = calendar.getEvents().filter(e => e.startStr === dateStr);

            let html = `<div style="margin-bottom: 20px;">
                <button class="btn btn-primary w-100" onclick="openAddOnDate('${dateStr}')">+ Add Subscription for ${date.toLocaleDateString()}</button>
            </div>`;

            if (events.length === 0) {
                html += `<div class="text-secondary text-center p-4">No events scheduled for this day.</div>`;
            } else {
                html += `<div class="panel-events-list">`;
                events.forEach(evt => {
                    const p = evt.extendedProps;
                    html += `
                        <div class="card card-hover mb-2 p-3" style="cursor: pointer;" onclick="triggerEventClick('${evt.id}')">
                            <div class="flex justify-between items-center">
                                <strong>${evt.title}</strong>
                                <span>${p.currency} ${p.costDisplay}</span>
                            </div>
                            <div class="text-xs text-secondary mt-1">${p.categoryName}</div>
                        </div>
                    `;
                });
                html += `</div>`;
            }

            window.openSidePanel(html, `Overview: ${date.toLocaleDateString()}`);

            // Hide edit button for day view
            const editBtn = document.getElementById('side-panel-edit-btn');
            if (editBtn) editBtn.style.display = 'none';
        }

        // Bridge to trigger event click via ID (for list items in panel)
        window.triggerEventClick = function (eventId) {
            const evt = calendar.getEventById(eventId);
            if (evt) {
                showEventDetailsInPanel(evt);
            }
        };

        window.openAddOnDate = function (dateStr) {
            if (typeof openModal === 'function') {
                window.closeSidePanel();
                openModal('subscriptionModal');
                setTimeout(() => {
                    const form = document.querySelector('#subscriptionModal form');
                    if (form) {
                        const dateInput = form.querySelector('[name="next_renewal_date"]'); // or start_date
                        if (dateInput) dateInput.value = dateStr;
                    }
                }, 100);
            }
        };

        // Search Filter Logic
        document.getElementById('calendarSearchInput').addEventListener('input', function (e) {
            const term = e.target.value.toLowerCase();
            const events = calendar.getEvents();

            events.forEach(evt => {
                const match = evt.title.toLowerCase().includes(term);
                evt.setProp('display', match ? 'auto' : 'none');
            });

            recalculateTotal();
        });
    });
</script>
{% endblock %}