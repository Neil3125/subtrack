{% extends "base.html" %}

{% block content %}
<div class="calendar-container">
    <!-- Calendar Header -->
    <div class="calendar-header">
        <div class="header-left">
            <h1 id="currentMonthYear">January 2026</h1>
            <div class="calendar-controls">
                <button id="prevMonth" class="btn btn-icon" title="Previous Month">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <button id="todayBtn" class="btn btn-sm btn-outline">Today</button>
                <button id="nextMonth" class="btn btn-icon" title="Next Month">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </div>
        <div class="header-right">
            <!-- Legend / Filters could go here -->
            <div class="legend-item">
                <span class="dot renewal"></span> Renewal
            </div>
            <!-- <div class="legend-item">
                <span class="dot expiration"></span> Expiration
            </div> -->
            <button id="addSubscriptionBtn" class="btn btn-primary">
                <i class="fas fa-plus"></i> Add Subscription
            </button>
        </div>
    </div>

    <!-- Days of Week -->
    <div class="calendar-grid-header">
        <div class="day-name">Sun</div>
        <div class="day-name">Mon</div>
        <div class="day-name">Tue</div>
        <div class="day-name">Wed</div>
        <div class="day-name">Thu</div>
        <div class="day-name">Fri</div>
        <div class="day-name">Sat</div>
    </div>

    <!-- Calendar Grid -->
    <div id="calendarGrid" class="calendar-grid">
        <!-- Generated by JS -->
    </div>
</div>

<!-- Day Detail Modal -->
<div id="dayModal" class="modal">
    <div class="modal-content small-modal">
        <div class="modal-header">
            <h2 id="modalDateTitle">Date</h2>
            <button class="close-modal">&times;</button>
        </div>
        <div class="modal-body">
            <div id="dayEventsList" class="day-events-list">
                <!-- Events populated here -->
            </div>
            <button id="addEventOnDayBtn" class="btn btn-outline btn-full-width mt-4">
                <i class="fas fa-plus"></i> Add Subscription for this Date
            </button>
        </div>
    </div>
</div>

<!-- Add Subscription Modal (Reused or new specific one) -->
<!-- We will trigger the main subscription modal but pre-fill date -->

<style>
    /* Monday.com-inspired Calendar Styles */
    :root {
        --grid-border: #e6e9ef;
        --cell-bg: #ffffff;
        --cell-hover: #f5f6f8;
        --text-primary: #323338;
        --text-secondary: #676879;
        --primary-color: #0073ea;
        --event-bg-renewal: #e2f7e7;
        /* Light green */
        --event-text-renewal: #007f36;
        /* Dark green */
        --event-bg-expiration: #ffe6e6;
        /* Light red */
        --event-text-expiration: #d93025;
        /* Dark red */
    }

    .calendar-container {
        display: flex;
        flex-direction: column;
        height: calc(100vh - 80px);
        /* Adjust based on navbar height */
        padding: 24px;
        background-color: #f7f9fa;
        overflow: hidden;
    }

    .calendar-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
    }

    .header-left {
        display: flex;
        align-items: center;
        gap: 24px;
    }

    .header-left h1 {
        font-size: 24px;
        font-weight: 600;
        color: var(--text-primary);
        margin: 0;
        min-width: 200px;
    }

    .calendar-controls {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .header-right {
        display: flex;
        align-items: center;
        gap: 16px;
    }

    .legend-item {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 14px;
        color: var(--text-secondary);
    }

    .dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
    }

    .dot.renewal {
        background-color: var(--event-text-renewal);
    }

    .dot.expiration {
        background-color: var(--event-text-expiration);
    }

    /* Grid Header */
    .calendar-grid-header {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        padding-bottom: 12px;
        border-bottom: 1px solid var(--grid-border);
    }

    .day-name {
        text-align: center;
        font-weight: 500;
        color: var(--text-secondary);
        font-size: 14px;
        text-transform: uppercase;
    }

    /* Grid Body */
    .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        grid-template-rows: repeat(auto-fill, minmax(100px, 1fr));
        /* Fill remaining space */
        flex-grow: 1;
        background-color: var(--grid-border);
        /* Gap color */
        gap: 1px;
        border: 1px solid var(--grid-border);
        border-radius: 0 0 8px 8px;
        overflow-y: auto;
    }

    .calendar-cell {
        background-color: var(--cell-bg);
        padding: 8px;
        min-height: 120px;
        cursor: pointer;
        transition: background-color 0.2s;
        display: flex;
        flex-direction: column;
        gap: 4px;
    }

    .calendar-cell:hover {
        background-color: var(--cell-hover);
    }

    .calendar-cell.other-month {
        background-color: #fcfcfd;
        color: #cecece;
    }

    .calendar-cell.today {
        background-color: #f0f7ff;
    }

    .cell-date {
        font-weight: 500;
        font-size: 14px;
        margin-bottom: 4px;
        color: var(--text-secondary);
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
    }

    .calendar-cell.today .cell-date {
        background-color: var(--primary-color);
        color: white;
    }

    /* Events Pills */
    .event-pill {
        display: flex;
        align-items: center;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: 500;
        margin-bottom: 2px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        transition: transform 0.1s;
    }

    .event-pill:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .event-pill.renewal {
        background-color: var(--event-bg-renewal);
        color: var(--event-text-renewal);
        border-left: 3px solid var(--event-text-renewal);
    }

    .event-pill-icon {
        margin-right: 4px;
        opacity: 0.7;
    }

    /* Modal Tweaks */
    .day-events-list {
        display: flex;
        flex-direction: column;
        gap: 12px;
        max-height: 400px;
        overflow-y: auto;
    }

    .event-item-card {
        padding: 12px;
        border: 1px solid var(--grid-border);
        border-radius: 8px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .event-item-info h4 {
        margin: 0 0 4px 0;
        font-size: 16px;
    }

    .event-item-meta {
        font-size: 13px;
        color: var(--text-secondary);
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        let currentDate = new Date();
        let currentEvents = [];

        const grid = document.getElementById('calendarGrid');
        const monthLabel = document.getElementById('currentMonthYear');
        const dayModal = document.getElementById('dayModal');
        const modalDateTitle = document.getElementById('modalDateTitle');
        const dayEventsList = document.getElementById('dayEventsList');
        const addEventOnDayBtn = document.getElementById('addEventOnDayBtn');

        // Initial Render
        fetchEventsAndRender();

        // Controls
        document.getElementById('prevMonth').addEventListener('click', () => {
            currentDate.setMonth(currentDate.getMonth() - 1);
            fetchEventsAndRender();
        });

        document.getElementById('nextMonth').addEventListener('click', () => {
            currentDate.setMonth(currentDate.getMonth() + 1);
            fetchEventsAndRender();
        });

        document.getElementById('todayBtn').addEventListener('click', () => {
            currentDate = new Date();
            fetchEventsAndRender();
        });

        // Add Subscription Button (Global)
        document.getElementById('addSubscriptionBtn').addEventListener('click', () => {
            if (typeof openModal === 'function') {
                openModal('subscriptionModal');
            } else {
                console.error("openModal function not found");
            }
        });

        async function fetchEventsAndRender() {
            // Determine date range for current view (start of first week to end of last week)
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();

            // First day of month
            const firstDayOfMonth = new Date(year, month, 1);
            // Starting day of calendar grid (Sunday before first day)
            const startGridDate = new Date(firstDayOfMonth);
            startGridDate.setDate(1 - startGridDate.getDay());

            // Last day of month
            const lastDayOfMonth = new Date(year, month + 1, 0);
            // End day of calendar grid (Saturday after last day)
            const endGridDate = new Date(lastDayOfMonth);
            endGridDate.setDate(lastDayOfMonth.getDate() + (6 - lastDayOfMonth.getDay()));

            // Format for API: YYYY-MM-DD
            const startStr = startGridDate.toISOString().split('T')[0];
            const endStr = endGridDate.toISOString().split('T')[0];

            // Update Header
            const monthName = currentDate.toLocaleString('default', { month: 'long' });
            monthLabel.textContent = `${monthName} ${year}`;

            try {
                // Fetch subscriptions with active status within range
                // Note: The backend filters by next_renewal_date. 
                // We use status=active to show relevant renewals.
                const response = await fetch(`/api/subscriptions?status=active&start_date=${startStr}&end_date=${endStr}`);
                if (!response.ok) throw new Error('Failed to fetch events');
                const subscriptions = await response.json();

                currentEvents = subscriptions;
                renderGrid(startGridDate, endGridDate, subscriptions);
            } catch (error) {
                console.error("Error fetching calendar events:", error);
                // Render empty grid on error
                renderGrid(startGridDate, endGridDate, []);
            }
        }

        function renderGrid(startDate, endDate, subscriptions) {
            grid.innerHTML = '';

            const iteratorDate = new Date(startDate);
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            while (iteratorDate <= endDate) {
                const cell = document.createElement('div');
                cell.className = 'calendar-cell';

                // Styles for other month
                if (iteratorDate.getMonth() !== currentDate.getMonth()) {
                    cell.classList.add('other-month');
                }

                // Today highlight
                if (iteratorDate.getTime() === today.getTime()) {
                    cell.classList.add('today');
                }

                // Date Number
                const dateNum = document.createElement('span');
                dateNum.className = 'cell-date';
                dateNum.textContent = iteratorDate.getDate();
                cell.appendChild(dateNum);

                // Find events for this day
                // Match iteratorDate (YYYY-MM-DD) with sub.next_renewal_date
                const iterDateStr = iteratorDate.toISOString().split('T')[0];
                const daysEvents = subscriptions.filter(sub => sub.next_renewal_date === iterDateStr);

                // Render Pills
                daysEvents.forEach(sub => {
                    const pill = document.createElement('div');
                    pill.className = 'event-pill renewal'; // Default to renewal style for now

                    // Add icon if available (todo: map categories to icons)

                    // Text
                    pill.textContent = `${sub.vendor_name} (${sub.currency} ${sub.cost})`;
                    pill.title = `${sub.vendor_name} - Renewal`;

                    cell.appendChild(pill);
                });

                // Click event
                const dateForClick = new Date(iteratorDate); // Closure capture
                cell.onclick = () => openDayModal(dateForClick, daysEvents);

                grid.appendChild(cell);

                // Increment day
                iteratorDate.setDate(iteratorDate.getDate() + 1);
            }
        }

        function openDayModal(date, events) {
            const dateStr = date.toLocaleDateString('default', { weekday: 'long', month: 'long', day: 'numeric' });
            modalDateTitle.textContent = dateStr;
            dayEventsList.innerHTML = '';

            if (events.length === 0) {
                dayEventsList.innerHTML = '<p class="text-secondary text-center">No subscriptions renewing on this day.</p>';
            } else {
                events.forEach(sub => {
                    const el = document.createElement('div');
                    el.className = 'event-item-card';
                    el.innerHTML = `
                        <div class="event-item-info">
                            <h4>${sub.vendor_name}</h4>
                            <div class="event-item-meta">
                                ${sub.currency} ${sub.cost} â€¢ ${sub.billing_cycle}
                            </div>
                        </div>
                        <button class="btn btn-sm btn-outline edit-sub-btn" data-id="${sub.id}">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                    `;
                    dayEventsList.appendChild(el);

                    // attach edit handler
                    el.querySelector('.edit-sub-btn').addEventListener('click', (e) => {
                        e.stopPropagation();
                        // Call global edit function (assuming it exists in base.js or similar)
                        if (typeof openEditModal === 'function') {
                            openEditModal(sub.id);
                            dayModal.style.display = 'none';
                        }
                    });
                });
            }

            // "Add Subscription" for this specific date
            addEventOnDayBtn.onclick = () => {
                if (typeof openModal === 'function') {
                    openModal('subscriptionModal');
                    dayModal.style.display = 'none';

                    // Pre-fill date logic
                    // We need to find the next renewal date input in the modal
                    // Since the current subscription modal doesn't have a visible "Next Renewal" field (it calculates it),
                    // we might need to adjust this or inject a hidden field/override.
                    // For now, we will just open the modal.
                    // Ideally: document.querySelector('[name="next_renewal_date"]').value = date.toISOString().split('T')[0];
                    // But looking at base.html, there is no direct date input for next_renewal, it is derived from start_date/billing_cycle?
                    // Or maybe it's not shown. 
                    // Let's at least set the start_date to this day if it exists.
                    const startDateInput = document.querySelector('[name="start_date"]');
                    if (startDateInput) {
                        startDateInput.value = date.toISOString().split('T')[0];
                    }
                }
            };

            dayModal.style.display = 'block';
        }

        // Modal Close Logic
        const closeBtns = document.querySelectorAll('.close-modal');
        closeBtns.forEach(btn => btn.addEventListener('click', () => {
            dayModal.style.display = 'none';
        }));

        window.onclick = function (event) {
            if (event.target == dayModal) {
                dayModal.style.display = "none";
            }
        }
    });
</script>
{% endblock %}