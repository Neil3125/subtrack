{% extends "base.html" %}

{% block title %}{{ group.name }} - SubTrack Web{% endblock %}

{% block content %}
<div class="animate-fade-in">
    <!-- Back Button -->
    <button class="btn btn-secondary btn-sm mb-4" onclick="window.history.back()" style="display: inline-flex; align-items: center; gap: 6px;">
        ‚Üê Back
    </button>

    <nav class="breadcrumbs" style="margin-bottom: var(--space-4); font-size: var(--font-size-sm);">
        <a href="/" style="color: var(--color-text-secondary);">Dashboard</a>
        <span style="margin: 0 var(--space-2); color: var(--color-text-tertiary);">/</span>
        <a href="/categories/{{ group.category.id }}" style="color: var(--color-text-secondary);">{{ group.category.name }}</a>
        <span style="margin: 0 var(--space-2); color: var(--color-text-tertiary);">/</span>
        <span style="color: var(--color-text);">{{ group.name }}</span>
    </nav>
    
    <div class="flex items-center justify-between mb-8">
        <div>
            <h1>{{ group.name }}</h1>
            <p class="text-secondary">
                <a href="/categories/{{ group.category.id }}">{{ group.category.name }}</a>
            </p>
        </div>
        <div class="flex gap-2">
            <button class="btn btn-secondary btn-sm" onclick="loadEditData('group', {{ group.id }})">
                ‚úèÔ∏è Edit Group
            </button>
            <button class="btn btn-secondary" onclick="openModal('addExistingCustomerModal')">
                üë• Add Existing Customer
            </button>
            <button class="btn btn-primary" onclick="openModal('customerModal')">
                ‚ûï New Customer
            </button>
        </div>
    </div>

    <!-- Group Stats Cards -->
    <div class="grid grid-cols-3 mb-6">
        <div class="card card-hover stat-card animate-slide-in clickable-card" style="cursor: pointer;" onclick="openModal('groupCustomersModal')">
            <div class="text-sm text-secondary mb-2">Customers</div>
            <div class="text-3xl font-bold text-primary">{{ customers|length }}</div>
            <div class="text-xs text-secondary">Click to view ‚Üí</div>
        </div>
        <div class="card card-hover stat-card animate-slide-in clickable-card" style="animation-delay: 100ms; cursor: pointer;" onclick="openModal('groupSubsModal')">
            <div class="text-sm text-secondary mb-2">Total Subscriptions</div>
            {% set total_subs = namespace(count=0) %}
            {% for c in customers %}{% set total_subs.count = total_subs.count + c.subscriptions|length %}{% endfor %}
            <div class="text-3xl font-bold text-success">{{ total_subs.count }}</div>
            <div class="text-xs text-secondary">Click to view ‚Üí</div>
        </div>
        <div class="card card-hover stat-card animate-slide-in" style="animation-delay: 200ms;">
            <div class="text-sm text-secondary mb-2">Category</div>
            <div class="text-xl font-bold text-info">
                <a href="/categories/{{ group.category.id }}" class="hover:underline">{{ group.category.name }}</a>
            </div>
            <div class="text-xs text-secondary">Parent category</div>
        </div>
    </div>

    <div class="card mb-6">
        <div class="card-header">
            <h2 class="card-title">Group Information</h2>
        </div>
        <div>
            <div class="text-sm text-secondary mb-1">Notes</div>
            <div>{{ group.notes or 'No notes' }}</div>
        </div>
    </div>

    <!-- Customers in this group -->
    {% if customers %}
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">üë• Customers ({{ customers|length }})</h2>
        </div>
        <div class="table-container">
            <table class="table">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Phone</th>
                        <th>Tags</th>
                        <th>Subscriptions</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for customer in customers %}
                    <tr>
                        <td class="font-medium">{{ customer.name }}</td>
                        <td>{{ customer.email or '-' }}</td>
                        <td>{{ customer.phone or '-' }}</td>
                        <td>{{ customer.tags or '-' }}</td>
                        <td>
                            <span class="badge badge-primary">{{ customer.subscriptions|length }}</span>
                        </td>
                        <td>
                            <a href="/customers/{{ customer.id }}" class="btn btn-sm btn-secondary">View</a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% else %}
    <div class="card">
        <div class="empty-state">
            <div class="empty-state-icon">üë•</div>
            <h3 class="empty-state-title">No customers in this group</h3>
            <p class="empty-state-text">Add your first customer to this group.</p>
            <button class="btn btn-primary" onclick="window.location.href='/customers/new?group_id={{ group.id }}'">
                Add Customer
            </button>
        </div>
    </div>
    {% endif %}
</div>

<!-- Add Existing Customer to Group Modal -->
<div id="addExistingCustomerModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title">üë• Add Existing Customer to Group</h2>
            <button class="modal-close" onclick="closeModal('addExistingCustomerModal')">√ó</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label class="form-label">Select Customer</label>
                <select id="existingCustomerSelect" class="form-select" multiple style="min-height: 200px;">
                    {% for customer in available_customers %}
                    <option value="{{ customer.id }}">{{ customer.name }} {% if customer.email %}({{ customer.email }}){% endif %}</option>
                    {% endfor %}
                </select>
                <small class="text-secondary">Hold Ctrl/Cmd to select multiple customers</small>
            </div>
            {% if not available_customers %}
            <div class="info-box info-box-info">
                <strong>‚ÑπÔ∏è No available customers</strong><br>
                All customers in this category are already in a group, or there are no customers yet.
            </div>
            {% endif %}
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeModal('addExistingCustomerModal')">Cancel</button>
            <button type="button" class="btn btn-primary" onclick="addExistingCustomersToGroup({{ group.id }})" {% if not available_customers %}disabled{% endif %}>Add to Group</button>
        </div>
    </div>
</div>

<script>
async function addExistingCustomersToGroup(groupId) {
    const select = document.getElementById('existingCustomerSelect');
    const selectedOptions = Array.from(select.selectedOptions);
    
    if (selectedOptions.length === 0) {
        showToast('Please select at least one customer', 'error');
        return;
    }
    
    let successCount = 0;
    let errorCount = 0;
    let errorMessages = [];
    
    for (const option of selectedOptions) {
        const customerId = option.value;
        try {
            // Simply update the customer with the new group_id
            const response = await fetch(`/api/customers/${customerId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ group_id: groupId })
            });
            
            if (response.ok) {
                successCount++;
            } else {
                const errorData = await response.json().catch(() => ({}));
                errorMessages.push(errorData.detail || 'Unknown error');
                errorCount++;
            }
        } catch (error) {
            console.error('Error adding customer to group:', error);
            errorMessages.push(error.message);
            errorCount++;
        }
    }
    
    closeModal('addExistingCustomerModal');
    
    if (successCount > 0) {
        showToast(`Added ${successCount} customer(s) to group`, 'success');
        setTimeout(() => window.location.reload(), 500);
    }
    if (errorCount > 0) {
        showToast(`Failed to add ${errorCount} customer(s): ${errorMessages[0] || 'Unknown error'}`, 'error');
    }
}
</script>

<!-- Group Customers Modal -->
<div id="groupCustomersModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 700px;">
        <div class="modal-header">
            <h2 class="modal-title">üë• Customers in {{ group.name }} ({{ customers|length }})</h2>
            <button class="modal-close" onclick="closeModal('groupCustomersModal')">√ó</button>
        </div>
        <div class="modal-body">
            {% if customers %}
            <div class="table-container" style="max-height: 400px; overflow-y: auto;">
                <table class="table">
                    <thead style="position: sticky; top: 0; background: var(--color-bg-card); z-index: 1;">
                        <tr>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Subscriptions</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for customer in customers %}
                        <tr>
                            <td class="font-medium">{{ customer.name }}</td>
                            <td>{{ customer.email or '-' }}</td>
                            <td><span class="badge badge-primary">{{ customer.subscriptions|length }}</span></td>
                            <td><a href="/customers/{{ customer.id }}" class="btn btn-sm btn-secondary">View</a></td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p class="text-secondary text-center py-4">No customers in this group yet</p>
            {% endif %}
        </div>
    </div>
</div>

<!-- Group Subscriptions Modal -->
<div id="groupSubsModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 800px;">
        <div class="modal-header">
            <h2 class="modal-title">üìã All Subscriptions in {{ group.name }}</h2>
            <button class="modal-close" onclick="closeModal('groupSubsModal')">√ó</button>
        </div>
        <div class="modal-body">
            {% set has_subs = namespace(value=false) %}
            {% for c in customers %}{% if c.subscriptions|length > 0 %}{% set has_subs.value = true %}{% endif %}{% endfor %}
            
            {% if has_subs.value %}
            <div class="table-container" style="max-height: 400px; overflow-y: auto;">
                <table class="table">
                    <thead style="position: sticky; top: 0; background: var(--color-bg-card); z-index: 1;">
                        <tr>
                            <th>Vendor</th>
                            <th>Customer</th>
                            <th>Cost</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for customer in customers %}
                        {% for sub in customer.subscriptions %}
                        <tr>
                            <td class="font-medium">{{ sub.vendor_name }}</td>
                            <td>{{ customer.name }}</td>
                            <td>${{ "%.2f"|format(sub.cost) }}</td>
                            <td><span class="badge badge-{{ 'success' if sub.status.value == 'active' else 'secondary' }}">{{ sub.status.value }}</span></td>
                            <td><a href="/subscriptions/{{ sub.id }}" class="btn btn-sm btn-secondary">View</a></td>
                        </tr>
                        {% endfor %}
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p class="text-secondary text-center py-4">No subscriptions from customers in this group</p>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}
