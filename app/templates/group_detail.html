{% extends "base.html" %}

{% block title %}{{ group.name }} - SubTrack Web{% endblock %}

{% block content %}
<div class="animate-fade-in">
    <nav class="breadcrumbs" style="margin-bottom: var(--space-4); font-size: var(--font-size-sm);">
        <a href="/" style="color: var(--color-text-secondary);">Dashboard</a>
        <span style="margin: 0 var(--space-2); color: var(--color-text-tertiary);">/</span>
        <a href="/categories/{{ group.category.id }}" style="color: var(--color-text-secondary);">{{ group.category.name }}</a>
        <span style="margin: 0 var(--space-2); color: var(--color-text-tertiary);">/</span>
        <span style="color: var(--color-text);">{{ group.name }}</span>
    </nav>
    
    <div class="flex items-center justify-between mb-8">
        <div>
            <h1>{{ group.name }}</h1>
            <p class="text-secondary">
                <a href="/categories/{{ group.category.id }}">{{ group.category.name }}</a>
            </p>
        </div>
        <div class="flex gap-2">
            <button class="btn btn-secondary btn-sm" onclick="loadEditData('group', {{ group.id }})">
                ‚úèÔ∏è Edit Group
            </button>
            <button class="btn btn-secondary" onclick="openModal('addExistingCustomerModal')">
                üë• Add Existing Customer
            </button>
            <button class="btn btn-primary" onclick="openModal('customerModal')">
                ‚ûï New Customer
            </button>
        </div>
    </div>

    <div class="card mb-6">
        <div class="card-header">
            <h2 class="card-title">Group Information</h2>
        </div>
        <div>
            <div class="text-sm text-secondary mb-1">Notes</div>
            <div>{{ group.notes or 'No notes' }}</div>
        </div>
    </div>

    <!-- Customers in this group -->
    {% if customers %}
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">üë• Customers ({{ customers|length }})</h2>
        </div>
        <div class="table-container">
            <table class="table">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Phone</th>
                        <th>Tags</th>
                        <th>Subscriptions</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for customer in customers %}
                    <tr>
                        <td class="font-medium">{{ customer.name }}</td>
                        <td>{{ customer.email or '-' }}</td>
                        <td>{{ customer.phone or '-' }}</td>
                        <td>{{ customer.tags or '-' }}</td>
                        <td>
                            <span class="badge badge-primary">{{ customer.subscriptions|length }}</span>
                        </td>
                        <td>
                            <a href="/customers/{{ customer.id }}" class="btn btn-sm btn-secondary">View</a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% else %}
    <div class="card">
        <div class="empty-state">
            <div class="empty-state-icon">üë•</div>
            <h3 class="empty-state-title">No customers in this group</h3>
            <p class="empty-state-text">Add your first customer to this group.</p>
            <button class="btn btn-primary" onclick="window.location.href='/customers/new?group_id={{ group.id }}'">
                Add Customer
            </button>
        </div>
    </div>
    {% endif %}
</div>

<!-- Add Existing Customer to Group Modal -->
<div id="addExistingCustomerModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title">üë• Add Existing Customer to Group</h2>
            <button class="modal-close" onclick="closeModal('addExistingCustomerModal')">√ó</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label class="form-label">Select Customer</label>
                <select id="existingCustomerSelect" class="form-select" multiple style="min-height: 200px;">
                    {% for customer in available_customers %}
                    <option value="{{ customer.id }}">{{ customer.name }} {% if customer.email %}({{ customer.email }}){% endif %}</option>
                    {% endfor %}
                </select>
                <small class="text-secondary">Hold Ctrl/Cmd to select multiple customers</small>
            </div>
            {% if not available_customers %}
            <div class="info-box info-box-info">
                <strong>‚ÑπÔ∏è No available customers</strong><br>
                All customers in this category are already in a group, or there are no customers yet.
            </div>
            {% endif %}
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeModal('addExistingCustomerModal')">Cancel</button>
            <button type="button" class="btn btn-primary" onclick="addExistingCustomersToGroup({{ group.id }})" {% if not available_customers %}disabled{% endif %}>Add to Group</button>
        </div>
    </div>
</div>

<script>
async function addExistingCustomersToGroup(groupId) {
    const select = document.getElementById('existingCustomerSelect');
    const selectedOptions = Array.from(select.selectedOptions);
    
    if (selectedOptions.length === 0) {
        showToast('Please select at least one customer', 'error');
        return;
    }
    
    let successCount = 0;
    let errorCount = 0;
    let errorMessages = [];
    
    for (const option of selectedOptions) {
        const customerId = option.value;
        try {
            // Simply update the customer with the new group_id
            const response = await fetch(`/api/customers/${customerId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ group_id: groupId })
            });
            
            if (response.ok) {
                successCount++;
            } else {
                const errorData = await response.json().catch(() => ({}));
                errorMessages.push(errorData.detail || 'Unknown error');
                errorCount++;
            }
        } catch (error) {
            console.error('Error adding customer to group:', error);
            errorMessages.push(error.message);
            errorCount++;
        }
    }
    
    closeModal('addExistingCustomerModal');
    
    if (successCount > 0) {
        showToast(`Added ${successCount} customer(s) to group`, 'success');
        setTimeout(() => window.location.reload(), 500);
    }
    if (errorCount > 0) {
        showToast(`Failed to add ${errorCount} customer(s): ${errorMessages[0] || 'Unknown error'}`, 'error');
    }
}
</script>
{% endblock %}
